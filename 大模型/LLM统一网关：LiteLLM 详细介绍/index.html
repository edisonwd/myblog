
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../langchain%E4%BD%BF%E7%94%A8token%E5%88%87%E5%88%86chunk/">
      
      
        <link rel="next" href="../%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E8%B7%B5/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>LLM统一网关：LiteLLM 详细介绍 - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#llmlitellm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              LLM统一网关：LiteLLM 详细介绍
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Devops
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Devops
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/apisix%E5%9C%A8k8s%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    apisix在k8s中的实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/devops%E5%B7%A5%E5%85%B7zadig%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    devops工具zadig实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/k8s%E4%B8%AD%E7%9A%84nginx-ingress%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E8%B7%AF%E5%BE%84%E9%87%8D%E5%AE%9A%E5%90%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    k8s中的nginx-ingress如何配置路径重定向
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%9C%A8k8s%E4%B8%AD%E5%AE%89%E8%A3%85%E5%B9%B6%E4%BD%BF%E7%94%A8jenkins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在k8s中安装并使用jenkins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%9C%A8k8s%E4%B8%AD%E5%AE%89%E8%A3%85%E5%B9%B6%E4%BD%BF%E7%94%A8nexus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在k8s中安装并使用nexus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98docker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何提高docker容器的安全性
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Go
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Go
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/go%E8%AF%AD%E8%A8%80grpc%E6%A1%86%E6%9E%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    go语言grpc框架从入门到实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/%E3%80%90golang%E3%80%91%E4%BD%BF%E7%94%A8chan%E6%94%B6%E9%9B%86%E5%A4%9A%E5%8D%8F%E7%A8%8B%E6%89%A7%E8%A1%8C%E7%9A%84%E7%BB%93%E6%9E%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【golang】使用chan收集多协程执行的结果
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/%E3%80%90golang%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E3%80%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【golang学习记录】环境搭建
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Image
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Image
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    收集的学习资料
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            收集的学习资料
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../image/%E6%94%B6%E9%9B%86%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/%E5%9C%A8%E7%BA%BF%E9%98%85%E8%AF%BB%E4%B9%A6%E7%B1%8D%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在线阅读书籍汇总
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%20%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java 编程思想
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java11%E5%92%8CJava17%E4%B9%8B%E9%97%B4%E6%9C%89%E5%93%AA%E4%BA%9B%E6%96%B0%E5%8F%98%E5%8C%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java11和Java17之间有哪些新变化
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/java%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    java中如何实现线程间通信
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E4%B8%AD%E8%8E%B7%E5%8F%96ThreadDumps%E7%9A%848%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java中获取ThreadDumps的8种方式汇总
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%92%8Cgo%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0LRU%E7%AE%97%E6%B3%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java和go语言实现LRU算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java异常
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E8%AE%BE%E8%AE%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java异常处理设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/maven%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    maven基础知识汇总
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Mockito%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mockito单元测试框架使用指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Mockito%E7%9A%84%E5%B8%B8%E8%A7%81%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E5%8F%8A%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mockito的常见核心功能及最佳实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/springboot%E4%BD%BF%E7%94%A8k8s%E7%9A%84configMap%E4%BD%9C%E4%B8%BA%E5%A4%96%E9%83%A8%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot使用k8s的configMap作为外部配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E4%BD%BF%E7%94%A8maven%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用maven自定义插件实现devops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7%20Java%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何监控 Java 垃圾回收
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E5%A6%82%E4%BD%95%E8%B0%83%E4%BC%98%20Java%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何调优 Java 垃圾收集
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E6%98%AF%E4%BB%80%E4%B9%88%E8%AE%A9Java%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84CPU%E4%BD%BF%E7%94%A8%E7%8E%87%E9%A3%99%E5%8D%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    是什么让Java应用程序的CPU使用率飙升
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3%20Java%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    简单理解 Java 垃圾收集器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E9%98%85%E8%AF%BB%E9%98%BF%E9%87%8CJava%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    阅读阿里Java开发手册记录
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Other
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Other
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/Python%E8%84%9A%E6%9C%AC%E5%A4%84%E7%90%86Markdown%E5%9B%BE%E7%89%87%E6%9C%AC%E5%9C%B0%E5%8C%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python脚本处理Markdown图片本地化
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E4%BC%98%E7%A7%80%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    优秀博客汇总
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E4%BD%BF%E7%94%A8Awescnb%E6%9E%84%E5%BB%BA%E9%85%B7%E7%82%AB%E7%9A%84%E5%8D%9A%E5%AE%A2%E5%9B%AD%E7%9A%AE%E8%82%A4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用Awescnb构建酷炫的博客园皮肤
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E5%9C%A8markdown%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%A1%A8%E6%83%85%E7%AC%A6%E5%8F%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在markdown中使用表情符号
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/gunicorn%E8%B6%85%E6%97%B6%E6%8A%A5%E9%94%99/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    gunicorn超时报错
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E4%B8%ADThreadPoolExecutor%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python中ThreadPoolExecutor运行原理解析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%8F%90%E5%8F%96json%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%80%BC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python使用正则表达式提取json字符串的值
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E5%AE%9E%E7%8E%B0%E6%8E%98%E9%87%91%E5%AE%9A%E6%97%B6%E7%AD%BE%E5%88%B0%E6%8A%BD%E5%A5%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python实现掘金定时签到抽奖
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/%E4%BD%BF%E7%94%A8python%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用python问题总结
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Rag
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Rag
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/PDF%E9%A1%B5%E7%9C%89%E9%A1%B5%E8%84%9A%E8%AF%86%E5%88%AB%E4%B8%8E%E5%8E%BB%E9%99%A4%E6%96%B9%E6%A1%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF页眉页脚识别与去除方案
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/RAG%E6%8A%80%E6%9C%AF%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E6%8C%91%E6%88%98%E5%88%86%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAG技术及其应用挑战分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/%E3%80%90RAG%E3%80%91chunk%E5%88%86%E5%9D%97%E5%AE%9E%E8%B7%B5%E7%AF%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】chunk分块实践篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/%E3%80%90RAG%E3%80%91chunk%E5%88%86%E5%9D%97%E7%90%86%E8%AE%BA%E7%AF%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】chunk分块理论篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/%E3%80%90RAG%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】docling结合OCR实现pdf转markdown
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/%E3%80%90RAG%E3%80%91%E4%BD%BF%E7%94%A8PyMuPDF4LLM%E8%A7%A3%E6%9E%90PDF%E7%9A%84%E5%9B%BE%E7%89%87%E5%92%8C%E8%A1%A8%E6%A0%BC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】使用PyMuPDF4LLM解析PDF的图片和表格
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/%E3%80%90RAG%E3%80%91%E6%9E%84%E5%BB%BA%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】构建向量数据库索引
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91%E5%B0%86pdf%E5%92%8Cdocx%E8%BD%AC%E6%8D%A2%E4%B8%BAmarkdown%E6%A0%BC%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG优化】将pdf和docx转换为markdown格式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rag/%E4%BD%BF%E7%94%A8Nanonets-OCR-s%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0PDF%E6%96%87%E4%BB%B6%E8%BD%ACmarkdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用Nanonets-OCR-s模型实现PDF文件转markdown
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Springboot
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Springboot
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20Validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spring Boot 中使用 Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%E4%B8%AD%E4%BD%BF%E7%94%A8MyBatis%20Generator%E7%94%9F%E6%88%90%E5%8A%A8%E6%80%81SQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spring Boot中使用MyBatis Generator生成动态SQL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%E9%A1%B9%E7%9B%AE%E8%87%AA%E5%B7%B1%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AA%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spring Boot项目自己封装一个分页查询工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%20%E5%A4%A7%E5%9E%8B%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%8C%85%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%28DDD%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot 大型复杂项目的包结构设计(DDD)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%E4%B8%AD%E4%BD%BF%E7%94%A8MapStruct%E6%95%99%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot中使用MapStruct教程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%E9%A1%B9%E7%9B%AE%E4%B8%AD%20PO%20BO%20VO%20DTO%20POJO%20DAO%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8%EF%BC%88%E9%99%84%E8%BD%AC%E6%8D%A2%E5%9B%BE%EF%BC%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot项目中 PO BO VO DTO POJO DAO概念及其作用（附转换图）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%8D%81%E5%88%86%E9%92%9F%E5%AE%9E%E7%8E%B0springboot%20%2B%20MyBatis%20Dynamic%20SQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    从零开始十分钟实现springboot + MyBatis Dynamic SQL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    大模型
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            大模型
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../langchain%E4%BD%BF%E7%94%A8token%E5%88%87%E5%88%86chunk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    langchain使用token切分chunk
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    LLM统一网关：LiteLLM 详细介绍
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    LLM统一网关：LiteLLM 详细介绍
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#litellm" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 基本介绍
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM 基本介绍">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#litellm_1" class="md-nav__link">
    <span class="md-ellipsis">
      为什么需要LiteLLM？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      项目概述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      核心功能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      技术架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      典型应用场景
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      优势对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm_2" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 两种使用方式介绍
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM 两种使用方式介绍">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#litellm-proxy-server-vs-python-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Proxy Server vs. Python SDK：核心区别详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Proxy Server vs. Python SDK：核心区别详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      定位与架构差异
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellm-python-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      一、LiteLLM Python SDK
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一、LiteLLM Python SDK">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      核心特征
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      典型使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellm-proxy-server" class="md-nav__link">
    <span class="md-ellipsis">
      二、LiteLLM Proxy Server
    </span>
  </a>
  
    <nav class="md-nav" aria-label="二、LiteLLM Proxy Server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      使用docker部署
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      核心功能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      典型使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      三、核心能力对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      四、如何选择？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四、如何选择？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      选择 Python SDK ：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proxy-server" class="md-nav__link">
    <span class="md-ellipsis">
      选择 Proxy Server ：
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      五、协同使用方案
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm_3" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 实践
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM 实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#litellm-python-sdk_1" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Python SDK 的 基本使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Python SDK 的 基本使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      安装依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellmcompletion" class="md-nav__link">
    <span class="md-ellipsis">
      litellm.completion方法参数详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="litellm.completion方法参数详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      基础参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      生成控制参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      高级控制参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      多模态与工具调用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      流式传输
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      模型推理控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      搜索与响应格式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      其他参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      返回值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellm-python-sdk_2" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Python SDK 实践
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Python SDK 实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1.非流式对话
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.非流式对话">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      使用阿里云百炼平台非流式对话
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用阿里云百炼平台非流式对话">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deepseek" class="md-nav__link">
    <span class="md-ellipsis">
      使用 deepseek 非流式对话
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2.流式对话
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.流式对话">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      流式对话辅助函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      异步流式对话
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      函数调用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="函数调用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义工具函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. 发起函数调用请求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 解析并执行工具调用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 获取最终响应
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm_4" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 智能路由功能详解
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm-router" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Router 参数详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Router 参数详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      一、核心模型配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      二、缓存配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      三、调度与队列
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      四、可靠性配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      五、回退策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      六、路由策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      七、模型健康与故障处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      八、预检查与过滤
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      九、模型别名与分组
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      十、预算与告警
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      十一、调试与日志
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      十二、高级配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      参数功能关系图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      典型配置示例
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      关键功能说明
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      核心价值
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      路由策略实战配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="路由策略实战配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      随机路由配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      基于权重的随机路由
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      基于最低延迟路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      基于最少请求路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      基于最低成本路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      基于最少使用路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      失败重试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      模型调用失败回退策略配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="模型调用失败回退策略配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      完整工作流示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jupyter-notebook-markdown" class="md-nav__link">
    <span class="md-ellipsis">
      将 jupyter notebook 转换为 markdown 格式
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    大模型工具调用原理和实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%A6%82%E4%BD%95%E8%AE%A9%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何让大模型输出结构化数据
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%B7%A5%E5%85%B7/%E4%BD%BF%E7%94%A8%E8%BF%87%E7%9A%84%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用过的开源工具
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    爬虫
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            爬虫
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/BeautifulSoup%E7%9A%84%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BeautifulSoup的使用
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/selenium%E5%A6%82%E4%BD%95%E6%8B%96%E5%8A%A8%E6%BB%9A%E5%8A%A8%E6%9D%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    selenium如何拖动滚动条
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/%E3%80%90%E7%88%AC%E8%99%AB%E3%80%91docker%E9%83%A8%E7%BD%B2python%2Bselenium%2Bfirefox-headless/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【爬虫】docker部署python+selenium+firefox-headless
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/%E3%80%90%E7%88%AC%E8%99%AB%E3%80%91python%2Bselenium%2Bfirefox%E4%BD%BF%E7%94%A8%E4%B8%8E%E9%83%A8%E7%BD%B2%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【爬虫】python+selenium+firefox使用与部署详解
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    算法
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            算法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%AE%97%E6%B3%95/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E5%9B%BE%E6%96%87%E8%AE%B2%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    归并排序图文讲解
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#litellm" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 基本介绍
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM 基本介绍">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#litellm_1" class="md-nav__link">
    <span class="md-ellipsis">
      为什么需要LiteLLM？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      项目概述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      核心功能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      技术架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      典型应用场景
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      优势对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm_2" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 两种使用方式介绍
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM 两种使用方式介绍">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#litellm-proxy-server-vs-python-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Proxy Server vs. Python SDK：核心区别详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Proxy Server vs. Python SDK：核心区别详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      定位与架构差异
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellm-python-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      一、LiteLLM Python SDK
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一、LiteLLM Python SDK">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      核心特征
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      典型使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellm-proxy-server" class="md-nav__link">
    <span class="md-ellipsis">
      二、LiteLLM Proxy Server
    </span>
  </a>
  
    <nav class="md-nav" aria-label="二、LiteLLM Proxy Server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      使用docker部署
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      核心功能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      典型使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      三、核心能力对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      四、如何选择？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四、如何选择？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      选择 Python SDK ：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proxy-server" class="md-nav__link">
    <span class="md-ellipsis">
      选择 Proxy Server ：
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      五、协同使用方案
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm_3" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 实践
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM 实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#litellm-python-sdk_1" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Python SDK 的 基本使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Python SDK 的 基本使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      安装依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellmcompletion" class="md-nav__link">
    <span class="md-ellipsis">
      litellm.completion方法参数详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="litellm.completion方法参数详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      基础参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      生成控制参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      高级控制参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      多模态与工具调用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      流式传输
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      模型推理控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      搜索与响应格式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      其他参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      返回值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#litellm-python-sdk_2" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Python SDK 实践
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Python SDK 实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1.非流式对话
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.非流式对话">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      使用阿里云百炼平台非流式对话
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用阿里云百炼平台非流式对话">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deepseek" class="md-nav__link">
    <span class="md-ellipsis">
      使用 deepseek 非流式对话
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2.流式对话
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.流式对话">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      流式对话辅助函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      异步流式对话
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      函数调用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="函数调用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义工具函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. 发起函数调用请求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 解析并执行工具调用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 获取最终响应
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm_4" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM 智能路由功能详解
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litellm-router" class="md-nav__link">
    <span class="md-ellipsis">
      LiteLLM Router 参数详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LiteLLM Router 参数详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      一、核心模型配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      二、缓存配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      三、调度与队列
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      四、可靠性配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      五、回退策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      六、路由策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      七、模型健康与故障处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      八、预检查与过滤
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      九、模型别名与分组
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      十、预算与告警
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      十一、调试与日志
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      十二、高级配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      参数功能关系图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      典型配置示例
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      关键功能说明
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      核心价值
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      路由策略实战配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="路由策略实战配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      随机路由配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      基于权重的随机路由
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      基于最低延迟路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      基于最少请求路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      基于最低成本路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      基于最少使用路由配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      失败重试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      模型调用失败回退策略配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="模型调用失败回退策略配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      完整工作流示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jupyter-notebook-markdown" class="md-nav__link">
    <span class="md-ellipsis">
      将 jupyter notebook 转换为 markdown 格式
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="llmlitellm">LLM统一网关：LiteLLM 详细介绍</h1>
<h2 id="litellm">LiteLLM 基本介绍</h2>
<h4 id="litellm_1">为什么需要LiteLLM？</h4>
<p>在AI应用开发过程中，开发者常常遇到以下痛点：
- 接口碎片化：不同厂商的API接口差异巨大，从参数命名到响应格式都不统一
- 密钥管理复杂：每个服务商都有独立的认证机制，密钥管理成为运维负担
- 多模型管理成本：更换模型提供商需要重写大量代码，项目难以灵活调整
- 安全与合规：医疗或金融场景需确保数据不经过第三方模型，需要在调用第三方模型前拦截
- 开发迭代：快速对比不同模型在业务场景中的效果，需为每个模型单独编写评测代码
- 系统稳定性：动态路由与负载均衡，容灾与故障转移，智能重试与限流</p>
<h4 id="_1">项目概述</h4>
<p><strong>LiteLLM</strong> 是一个开源工具，LiteLLM通过提供统一的OpenAI兼容接口，作为 LLM API 的通用适配器，简化大型语言模型（LLM）的集成与管理，允许开发人员通过标准化接口与各种大模型进行交互。该项目支持目前市面上大多数LLM提供商，包括 Anthropic、AWS Bedrock、AWS SageMaker、Azure OpenAI、deepseek、Google Vertex AI、OpenAI等等，除了云端产品，还支持本地化部署工具，如Ollama等。</p>
<p>除了统一接口之外，还实现了成本跟踪、访问控制和 API 调用的实时监控等功能。该项目核心目标是是简化多 LLM 应用的开发，提高平台团队管理多提供商的效率。目前，LiteLLM 集成了100多个LLM的访问、费用跟踪和回退。</p>
<p>使用LiteLLM，可为开发团队节省时间和精力。开发者无需自定义集成每个新的模型 API ，或等待特定提供商发布SDK。</p>
<h4 id="_2">核心功能</h4>
<ol>
<li><strong>标准化API接口</strong></li>
<li><strong>统一调用格式</strong>：无论底层模型如何，所有请求均使用相同结构（如OpenAI格式），降低代码适配成本。</li>
<li>
<p><strong>示例</strong>：调用GPT-4与Claude 2均通过 <code>litellm.completion(model="模型名", messages=[...])</code> 实现。</p>
</li>
<li>
<p><strong>多模型支持</strong></p>
</li>
<li><strong>覆盖主流LLM</strong>：支持包括OpenAI、Anthropic、Google Vertex AI、Hugging Face、Cohere等20+模型，持续扩展中。</li>
<li>
<p><strong>自定义模型接入</strong>：通过配置可接入私有化部署模型或小众API。</p>
</li>
<li>
<p><strong>智能路由与负载均衡</strong></p>
</li>
<li><strong>路由策略</strong>：根据模型类型、可用性、成本或时延自动选择最优服务节点。</li>
<li>
<p><strong>故障转移</strong>：当某模型服务不可用时，自动切换至备用模型，确保业务连续性。</p>
</li>
<li>
<p><strong>缓存与成本优化</strong></p>
</li>
<li><strong>请求缓存</strong>：对重复查询结果缓存，减少API调用次数。</li>
<li>
<p><strong>用量统计</strong>：实时监控各模型Token消耗，生成成本报告，支持预算告警。</p>
</li>
<li>
<p><strong>监控与日志</strong></p>
</li>
<li><strong>性能指标</strong>：记录响应时间、错误率、Token用量等关键指标。</li>
<li>
<p><strong>审计日志</strong>：追踪所有请求详情，便于调试与合规审查。</p>
</li>
<li>
<p><strong>安全增强</strong></p>
</li>
<li><strong>API密钥管理</strong>：集中存储加密密钥，避免硬编码泄露风险。</li>
<li><strong>访问控制</strong>：支持基于角色的权限管理（RBAC），限制敏感操作。</li>
</ol>
<h4 id="_3">技术架构</h4>
<p>LiteLLM采用模块化设计，关键组件包括：
- <strong>API网关</strong>：接收请求并转发至适配器，处理认证、限流等。
- <strong>模型适配器</strong>：将统一API转换为各LLM原生接口（如将OpenAI格式转为Anthropic的HTTP参数）。
- <strong>路由引擎</strong>：动态决策模型调用路径，支持自定义规则（如“优先使用成本低于$0.01/1k Tokens的模型”）。
- <strong>缓存层</strong>：基于Redis或内存存储高频查询结果。
- <strong>监控代理</strong>：集成Prometheus、Grafana等工具，提供可视化看板。</p>
<h4 id="_4">典型应用场景</h4>
<ol>
<li><strong>多模型A/B测试</strong></li>
<li>
<p>同时向GPT-4和Claude 2发送请求，比较生成质量，辅助模型选型。</p>
</li>
<li>
<p><strong>混合云LLM调度</strong></p>
</li>
<li>
<p>结合公有云API（如OpenAI）与本地部署模型（如Llama 2），根据数据敏感性自动路由。</p>
</li>
<li>
<p><strong>成本敏感型应用</strong></p>
</li>
<li>
<p>配置路由策略，在非关键任务中使用低价模型（如GPT-3.5），关键任务切换至高成本模型（如GPT-4）。</p>
</li>
<li>
<p><strong>容灾备份</strong></p>
</li>
<li>当Qwen模型调用服务出现故障时，自动将请求转发至deepseek模型调用服务，避免服务中断。</li>
</ol>
<h4 id="_5">优势对比</h4>
<table>
<thead>
<tr>
<th>特性</th>
<th>原生多模型开发</th>
<th>使用LiteLLM</th>
</tr>
</thead>
<tbody>
<tr>
<td>代码复杂度</td>
<td>需为每个模型编写适配层</td>
<td>统一API，代码复用率高</td>
</tr>
<tr>
<td>维护成本</td>
<td>需跟踪各API更新</td>
<td>自动处理接口变更</td>
</tr>
<tr>
<td>故障恢复</td>
<td>手动实现重试逻辑</td>
<td>内置智能故障转移</td>
</tr>
<tr>
<td>成本优化</td>
<td>需自行统计与分析</td>
<td>提供用量仪表盘</td>
</tr>
</tbody>
</table>
<h4 id="_6">总结</h4>
<p>LiteLLM通过抽象化底层LLM的复杂性，显著降低了多模型应用的开发门槛。其核心价值在于：
- <strong>开发者友好</strong>：减少70%以上的模型集成代码量。
- <strong>企业级管控</strong>：提供从成本控制到安全审计的全生命周期管理。
- <strong>生态兼容性</strong>：无缝对接现有MLOps工具链（如MLflow、Weights &amp; Biases）。</p>
<p>随着LLM技术的快速演进，LiteLLM正成为构建稳健、可扩展AI应用的关键基础设施。</p>
<h2 id="litellm_2">LiteLLM 两种使用方式介绍</h2>
<p>LiteLLM有两种使用方式：
- <strong>Python SDK</strong>：在 Python 代码中使用 LiteLLM，通常由构建 llm 项目的开发人员使用。
- <strong>Proxy Server</strong>：需要中央服务（LLM 网关）访问多个 LLM，通常由 Gen AI 支持/ML 平台团队使用。</p>
<h3 id="litellm-proxy-server-vs-python-sdk">LiteLLM Proxy Server vs. Python SDK：核心区别详解</h3>
<h4 id="_7"><strong>定位与架构差异</strong></h4>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>LiteLLM Python SDK</strong></th>
<th><strong>LiteLLM Proxy Server</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>本质</strong></td>
<td>轻量级Python客户端库</td>
<td>独立部署的API网关服务</td>
</tr>
<tr>
<td><strong>运行方式</strong></td>
<td>嵌入应用代码中（如Django/Flask/fastapi）</td>
<td>独立进程（Docker/K8s部署）</td>
</tr>
<tr>
<td><strong>通信协议</strong></td>
<td>函数调用（Python进程内）</td>
<td>HTTP REST API（跨语言调用）</td>
</tr>
<tr>
<td><strong>依赖</strong></td>
<td>需Python环境</td>
<td>需要单独部署（任何HTTP客户端可访问，无语言限制）</td>
</tr>
</tbody>
</table>
<h3 id="litellm-python-sdk">一、<strong>LiteLLM Python SDK</strong></h3>
<h4 id="_8">核心特征</h4>
<ul>
<li><strong>本地集成</strong>：作为Python包直接安装（<code>pip install litellm</code>）</li>
<li><strong>开发者友好</strong>：面向Python开发者，提供同步/异步API</li>
<li><strong>无服务依赖</strong>：无需额外基础设施</li>
</ul>
<h4 id="_9">典型使用场景</h4>
<ol>
<li>
<p><strong>单应用快速集成</strong>
   <div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">litellm</span>  <span class="c1"># 单库集成所有功能</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># 直接调用模型</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>脚本/实验环境</strong>
   <div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Jupyter Notebook中快速测试模型</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a> <span class="kn">import</span><span class="w"> </span><span class="nn">litellm</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a> <span class="n">model_list</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">model_list</span> <span class="c1"># 查看支持模型</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a> <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">))</span> <span class="c1"># 791</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>与其他Python库协同</strong>
   <div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a> <span class="c1"># 安装 langchain-litellm 依赖</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a> <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">qU</span> <span class="n">langchain</span><span class="o">-</span><span class="n">litellm</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a> <span class="c1"># 无缝接入LangChain</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a> <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatLiteLLM</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a> <span class="n">llm</span> <span class="o">=</span> <span class="n">ChatLiteLLM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-nano&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span></code></pre></div></p>
</li>
</ol>
<h3 id="litellm-proxy-server">二、<strong>LiteLLM Proxy Server</strong></h3>
<h4 id="docker">使用docker部署</h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>docker<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span>-v<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/litellm_config.yaml:/app/config.yaml<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">AZURE_API_KEY</span><span class="o">=</span>d6***********<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">AZURE_API_BASE</span><span class="o">=</span>https://openai-***********/<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span>-p<span class="w"> </span><span class="m">4000</span>:4000<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span>ghcr.io/berriai/litellm:main-latest<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span>--config<span class="w"> </span>/app/config.yaml<span class="w"> </span>--detailed_debug
</span></code></pre></div>
<h4 id="_10">核心功能</h4>
<ul>
<li><strong>中心化网关</strong>：独立服务，通过HTTP暴露统一API</li>
<li><strong>企业级功能</strong>：</li>
<li><strong>多租户管理</strong>（团队/项目隔离）</li>
<li><strong>集中式监控面板</strong></li>
<li><strong>全局速率限制</strong></li>
<li><strong>成本跟踪</strong></li>
</ul>
<h4 id="_11">典型使用场景</h4>
<ol>
<li><strong>多语言架构</strong></li>
</ol>
<p>使用 javascript 调用
   <div class="language-javascript highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">// 前端JS直接调用</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nx">fetch</span><span class="p">(</span><span class="s2">&quot;http://llm-gateway.company.com/completions&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="s2">&quot;Authorization&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Bearer team-123&quot;</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">  </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Hello&quot;</span><span class="p">}]</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">  </span><span class="p">})</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="p">})</span>
</span></code></pre></div>
   使用 curl 调用
   <div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w"> </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s1">&#39;http://0.0.0.0:4000/chat/completions&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Authorization: Bearer sk-1234&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="s1">     &quot;model&quot;: &quot;gpt-4o&quot;,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="s1">     &quot;messages&quot;: [</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="s1">       {</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="s1">         &quot;role&quot;: &quot;system&quot;,</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="s1">         &quot;content&quot;: &quot;You are an LLM named gpt-4o&quot;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="s1">       },</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="s1">       {</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="s1">         &quot;role&quot;: &quot;user&quot;,</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="s1">         &quot;content&quot;: &quot;what is your name?&quot;</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="s1">       }</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="s1">     ]</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="s1"> }&#39;</span>
</span></code></pre></div>
   使用 openai 兼容接口调用</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a> <span class="kn">import</span><span class="w"> </span><span class="nn">openai</span> <span class="c1"># openai v1.0.0+</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a> <span class="n">client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;anything&quot;</span><span class="p">,</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://0.0.0.0:4000&quot;</span><span class="p">)</span> <span class="c1"># set proxy to base_url</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a> <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>                 <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>                 <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;this is a test request, write a short poem&quot;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>             <span class="p">}]</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a> <span class="c1"># request sent to model set on litellm proxy, `litellm --model`</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span> <span class="p">)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a> <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="_12">三、核心能力对比</h3>
<table>
<thead>
<tr>
<th><strong>功能</strong></th>
<th><strong>Python SDK</strong></th>
<th><strong>Proxy Server</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>多模型调用</strong></td>
<td>✅ 支持</td>
<td>✅ 支持</td>
</tr>
<tr>
<td><strong>负载均衡</strong></td>
<td>✅ 基础路由策略</td>
<td>✅ 高级算法（一致性哈希/权重轮询）</td>
</tr>
<tr>
<td><strong>成本跟踪</strong></td>
<td>✅ 单进程级统计</td>
<td>✅ 多团队细粒度分析</td>
</tr>
<tr>
<td><strong>密钥管理</strong></td>
<td>❌ 需自行实现加密</td>
<td>✅ 集中存储（Vault集成）</td>
</tr>
<tr>
<td><strong>访问控制</strong></td>
<td>❌ 无</td>
<td>✅ RBAC/团队隔离</td>
</tr>
<tr>
<td><strong>全局速率限制</strong></td>
<td>❌ 仅单进程有效</td>
<td>✅ 集群级控制</td>
</tr>
<tr>
<td><strong>审计日志</strong></td>
<td>✅ 基础日志</td>
<td>✅ 结构化日志（ElasticSearch集成）</td>
</tr>
<tr>
<td><strong>服务发现</strong></td>
<td>❌ 无</td>
<td>✅ 健康检查+自动故障转移</td>
</tr>
</tbody>
</table>
<h3 id="_13">四、如何选择？</h3>
<h4 id="python-sdk">选择 <strong>Python SDK</strong> ：</h4>
<ul>
<li>构建纯Python应用（如AI助手脚本）</li>
<li>需要极简原型验证（POC阶段）</li>
<li>无多团队/多语言集成需求</li>
</ul>
<h4 id="proxy-server">选择 <strong>Proxy Server</strong> ：</h4>
<ul>
<li>企业生产环境部署</li>
<li>需要支持Java/Go/Node.js等多语言客户端</li>
<li>要求团队隔离与SLA保障</li>
<li>已有Prometheus/Grafana监控栈</li>
</ul>
<h3 id="_14">五、协同使用方案</h3>
<p><pre class="mermaid"><code>graph LR
    A[Python应用] --&gt;|直接调用| B(Python SDK)
    C[Java应用] --&gt;|HTTP| D(Proxy Server)
    E[Node.js应用] --&gt;|HTTP| D

    D --&gt;|路由请求| F[OpenAI]
    D --&gt;|路由请求| G[Anthropic]
    D --&gt;|路由请求| H[本地模型]
    B --&gt;|绕过网关直连| F
    B --&gt;|绕过网关直连| G
</code></pre>
<strong>最佳实践</strong>：
- 开发环境用SDK快速迭代
- 生产环境通过Proxy统一管理
- SDK应用可逐步迁移至Proxy</p>
<h2 id="litellm_3">LiteLLM 实践</h2>
<p>因为我们使用的是python应用，并且主要使用的是 <strong>langchain</strong> 框架，所以接下来的实践内容以 <strong>LiteLLM Python SDK</strong> 为主，重点介绍下面功能的使用方法。</p>
<ul>
<li>非流式对话</li>
<li>流式对话</li>
<li>函数调用</li>
<li>动态路由</li>
<li>智能重试</li>
</ul>
<p>这里从两个大的方面介绍这些功能的使用
1. 使用 <strong>LiteLLM Python SDK</strong> 直接提供的接口
2. 与langchain集成，使用 <strong>langchain-litellm</strong> 提供的接口</p>
<p>为了更好的实践，接下来从 <a href="https://api-docs.deepseek.com/zh-cn/">deepseek</a> 和 <a href="https://www.aliyun.com/product/bailian">阿里云百炼</a> 这两个平台申请模型调用服务。
- 申请 deepseek 模型调用服务需要充值，具体使用可以查看<a href="https://api-docs.deepseek.com/zh-cn/">deepseek</a>官方文档。
- 申请阿里云百炼模型调用服务，首次开通每个模型可以免费领取100万token使用额度，具体使用可以查看<a href="https://www.aliyun.com/product/bailian">阿里云百炼</a>官方文档。</p>
<p>假设你已经申请好了对应的 <strong>api_key</strong> ，接下来开始实践。</p>
<h3 id="litellm-python-sdk_1">LiteLLM Python SDK 的 基本使用</h3>
<h4 id="_15">安装依赖</h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>pip<span class="w"> </span>install<span class="w"> </span>litellm<span class="w"> </span>-U
</span></code></pre></div>
<h4 id="litellmcompletion">litellm.completion方法参数详解</h4>
<p>使用 <strong>LiteLLM Python SDK</strong> 主要的接口是 <strong>litellm.completion()</strong>，查看源码参数及说明如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nd">@client</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">completion</span><span class="p">(</span>  <span class="c1"># type: ignore # noqa: PLR0915</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="c1"># Optional OpenAI params: see https://platform.openai.com/docs/api-reference/chat/create</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="n">stream_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="n">max_completion_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="n">modalities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionModality</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="n">prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatCompletionPredictionContentParam</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="n">audio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatCompletionAudioParam</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="n">presence_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>    <span class="n">frequency_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>    <span class="c1"># openai v1.0+ new params</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>    <span class="n">response_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>    <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>    <span class="n">top_logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    <span class="n">parallel_tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    <span class="n">web_search_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OpenAIWebSearchOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>    <span class="n">deployment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>    <span class="n">extra_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>    <span class="c1"># soon to be deprecated params by OpenAI</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>    <span class="n">functions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>    <span class="n">function_call</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>    <span class="c1"># set api_base, api_version, api_key</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>    <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>    <span class="n">api_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>    <span class="n">model_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># pass in a list of api_base,keys, etc.</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>    <span class="c1"># Optional liteLLM function params</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>    <span class="n">thinking</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnthropicThinkingParam</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ModelResponse</span><span class="p">,</span> <span class="n">CustomStreamWrapper</span><span class="p">]:</span>
</span></code></pre></div>
<p>注意：由于参数很多，我会尽量简洁明了地解释每个参数。</p>
<ol>
<li>
<p><code>model: str</code>：指定要使用的模型名称，例如 "gpt-3.5-turbo"。</p>
</li>
<li>
<p><code>messages: List = []</code>：聊天消息列表，每个消息是一个字典，包含"role"（如"user"、"assistant"）和"content"。</p>
</li>
<li>
<p><code>timeout: Optional[Union[float, str, httpx.Timeout]] = None</code>：请求超时时间，可以是秒数（float），字符串（如"5s"）或httpx.Timeout对象。</p>
</li>
<li>
<p><code>temperature: Optional[float] = None</code>：控制生成文本的随机性。值越高，输出越随机；值越低，输出越确定。</p>
</li>
<li>
<p><code>top_p: Optional[float] = None</code>：核采样（nucleus sampling）的参数，控制生成文本的多样性。与temperature类似，但通常只考虑概率质量累计到top_p的词汇。</p>
</li>
<li>
<p><code>n: Optional[int] = None</code>：生成多个独立的回复（选择其中一个返回）。</p>
</li>
<li>
<p><code>stream: Optional[bool] = None</code>：是否以流式（stream）方式返回响应。</p>
</li>
<li>
<p><code>stream_options: Optional[dict] = None</code>：流式传输的额外选项。</p>
</li>
<li>
<p><code>stop</code>：可选，指定一个或多个字符串，当模型生成这些字符串时停止生成。</p>
</li>
<li>
<p><code>max_completion_tokens: Optional[int] = None</code>：限制完成部分的最大token数（不包括提示）。</p>
</li>
<li>
<p><code>max_tokens: Optional[int] = None</code>：整个生成的最大token数（包括提示和完成部分）。通常用这个或max_completion_tokens。</p>
</li>
<li>
<p><code>modalities: Optional[List[ChatCompletionModality]] = None</code>：指定交互的模态（如文本、图像等），可能是多模态输入。</p>
</li>
<li>
<p><code>prediction: Optional[ChatCompletionPredictionContentParam] = None</code>：预测内容参数，可能用于指定生成内容的结构或类型。</p>
</li>
<li>
<p><code>audio: Optional[ChatCompletionAudioParam] = None</code>：音频参数，可能用于语音输入或输出。</p>
</li>
<li>
<p><code>presence_penalty: Optional[float] = None</code>：存在惩罚，用于降低已经出现过的token的概率。</p>
</li>
<li>
<p><code>frequency_penalty: Optional[float] = None</code>：频率惩罚，用于降低频繁出现的token的概率。</p>
</li>
<li>
<p><code>logit_bias: Optional[dict] = None</code>：一个字典，用于调整特定token的生成概率（通过调整logit值）。</p>
</li>
<li>
<p><code>user: Optional[str] = None</code>：终端用户的标识符，用于监控和滥用检测。</p>
</li>
<li>
<p><code>reasoning_effort: Optional[Literal["low", "medium", "high"]] = None</code>：指定模型推理的努力程度（可能影响响应时间和质量）。</p>
</li>
<li>
<p><code>response_format: Optional[Union[dict, Type[BaseModel]]] = None</code>：指定响应格式，比如JSON对象，或者使用Pydantic的BaseModel定义结构。</p>
</li>
<li>
<p><code>seed: Optional[int] = None</code>：随机种子，用于使生成结果具有确定性。</p>
</li>
<li>
<p><code>tools: Optional[List] = None</code>：一个工具列表，模型可以调用这些工具（类似于functions的替代）。</p>
</li>
<li>
<p><code>tool_choice: Optional[Union[str, dict]] = None</code>：控制模型如何选择工具，可以是"auto"、"none"，或指定某个工具。</p>
</li>
<li>
<p><code>logprobs: Optional[bool] = None</code>：是否返回每个token的对数概率。</p>
</li>
<li>
<p><code>top_logprobs: Optional[int] = None</code>：如果logprobs为True，这个参数指定返回每个位置概率最高的几个token及其对数概率。</p>
</li>
<li>
<p><code>parallel_tool_calls: Optional[bool] = None</code>：是否允许模型并行调用多个工具（如果支持）。</p>
</li>
<li>
<p><code>web_search_options: Optional[OpenAIWebSearchOptions] = None</code>：网络搜索选项，可能用于让模型在生成前进行网络搜索。</p>
</li>
<li>
<p><code>deployment_id=None</code>：部署ID，可能用于Azure OpenAI服务，指定特定的部署。</p>
</li>
<li>
<p><code>extra_headers: Optional[dict] = None</code>：额外的HTTP头，用于自定义请求。</p>
</li>
<li>
<p><code>functions: Optional[List] = None</code>：函数列表（旧版），模型可以调用这些函数（将被tools取代）。</p>
</li>
<li>
<p><code>function_call: Optional[str] = None</code>：控制函数调用行为，如"auto"、"none"或强制调用特定函数。</p>
</li>
<li>
<p><code>base_url: Optional[str] = None</code>：API的基础URL，用于覆盖默认的OpenAI API地址。</p>
</li>
<li>
<p><code>api_version: Optional[str] = None</code>：API版本，特别用于Azure OpenAI服务。</p>
</li>
<li>
<p><code>api_key: Optional[str] = None</code>：API密钥，用于认证。</p>
</li>
<li>
<p><code>model_list: Optional[list] = None</code>：一个列表，可能包含多个API的配置（如多个base_url和api_key），用于负载均衡或回退。</p>
</li>
<li>
<p><code>thinking: Optional[AnthropicThinkingParam] = None</code>：特定于Anthropic模型的参数，可能用于控制模型的“思考”过程。</p>
</li>
<li>
<p><code>**kwargs</code>：其他未指定的参数，用于向前或向后兼容。</p>
</li>
</ol>
<p>返回类型：<code>Union[ModelResponse, CustomStreamWrapper]</code>，表示返回一个模型响应对象，或者如果是流式响应，则返回一个自定义的流包装器。</p>
<blockquote>
<p>注意：这个函数是一个封装函数，用于统一调用不同提供者（如OpenAI、Anthropic等）的API，因此参数非常丰富，涵盖了多个提供者的特定参数。</p>
</blockquote>
<p>为了便于理解各个参数的作用，接下来将按照参数的功能分类，整理成表格，以下是 <code>completion</code> 函数参数的分类整理表格：</p>
<h5 id="_16"><strong>基础参数</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model</code></td>
<td><code>str</code></td>
<td>-</td>
<td><strong>必需</strong>，模型名称（如 <code>gpt-4-turbo</code>）</td>
</tr>
<tr>
<td><code>messages</code></td>
<td><code>List</code></td>
<td><code>[]</code></td>
<td><strong>必需</strong>，聊天消息列表（格式：<code>[{"role": "user", "content": "text"}]</code>）</td>
</tr>
</tbody>
</table>
<h5 id="_17"><strong>生成控制参数</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>temperature</code></td>
<td><code>float</code></td>
<td><code>None</code></td>
<td>随机性控制（0.0-2.0），值越高输出越随机</td>
</tr>
<tr>
<td><code>top_p</code></td>
<td><code>float</code></td>
<td><code>None</code></td>
<td>核采样阈值（0.0-1.0），仅累积概率超过阈值的词参与采样</td>
</tr>
<tr>
<td><code>max_tokens</code></td>
<td><code>int</code></td>
<td><code>None</code></td>
<td><strong>输入+输出</strong>总 token 数上限</td>
</tr>
<tr>
<td><code>max_completion_tokens</code></td>
<td><code>int</code></td>
<td><code>None</code></td>
<td><strong>仅输出</strong> token 数上限</td>
</tr>
<tr>
<td><code>stop</code></td>
<td><code>Union[str, List[str]]</code></td>
<td><code>None</code></td>
<td>停止生成标记（如 <code>["\n", "."]</code>）</td>
</tr>
<tr>
<td><code>n</code></td>
<td><code>int</code></td>
<td><code>None</code></td>
<td>生成多条独立回复的数量</td>
</tr>
<tr>
<td><code>seed</code></td>
<td><code>int</code></td>
<td><code>None</code></td>
<td>随机种子，确保结果可复现</td>
</tr>
</tbody>
</table>
<h5 id="_18"><strong>高级控制参数</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>presence_penalty</code></td>
<td><code>float</code></td>
<td><code>None</code></td>
<td>惩罚已出现 token（-2.0~2.0），避免重复内容</td>
</tr>
<tr>
<td><code>frequency_penalty</code></td>
<td><code>float</code></td>
<td><code>None</code></td>
<td>惩罚高频 token（-2.0~2.0），避免常见词滥用</td>
</tr>
<tr>
<td><code>logit_bias</code></td>
<td><code>dict</code></td>
<td><code>None</code></td>
<td>特定 token 概率偏移（如 <code>{12345: 5.0}</code> 提高该 token 概率）</td>
</tr>
<tr>
<td><code>logprobs</code></td>
<td><code>bool</code></td>
<td><code>None</code></td>
<td>是否返回 token 对数概率</td>
</tr>
<tr>
<td><code>top_logprobs</code></td>
<td><code>int</code></td>
<td><code>None</code></td>
<td>返回每个位置概率最高的 token 数量（需 <code>logprobs=True</code>）</td>
</tr>
<tr>
<td><code>user</code></td>
<td><code>str</code></td>
<td><code>None</code></td>
<td>终端用户 ID（用于滥用监控）</td>
</tr>
</tbody>
</table>
<h5 id="_19"><strong>多模态与工具调用</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>modalities</code></td>
<td><code>List[ChatCompletionModality]</code></td>
<td><code>None</code></td>
<td>多模态输入类型（文本/图像/音频）</td>
</tr>
<tr>
<td><code>audio</code></td>
<td><code>ChatCompletionAudioParam</code></td>
<td><code>None</code></td>
<td>音频输入参数（如语音转文本）</td>
</tr>
<tr>
<td><code>tools</code></td>
<td><code>List</code></td>
<td><code>None</code></td>
<td><strong>新版</strong>工具调用列表（替代 <code>functions</code>）</td>
</tr>
<tr>
<td><code>tool_choice</code></td>
<td><code>Union[str, dict]</code></td>
<td><code>None</code></td>
<td>工具调用控制（<code>"auto"</code>/<code>"none"</code> 或指定工具）</td>
</tr>
<tr>
<td><code>parallel_tool_calls</code></td>
<td><code>bool</code></td>
<td><code>None</code></td>
<td>是否允许并行调用多个工具</td>
</tr>
<tr>
<td><code>functions</code></td>
<td><code>List</code></td>
<td><code>None</code></td>
<td><strong>旧版</strong>函数列表（即将弃用）</td>
</tr>
<tr>
<td><code>function_call</code></td>
<td><code>str</code></td>
<td><code>None</code></td>
<td><strong>旧版</strong>函数调用控制（即将弃用）</td>
</tr>
</tbody>
</table>
<h5 id="_20"><strong>流式传输</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>stream</code></td>
<td><code>bool</code></td>
<td><code>None</code></td>
<td>是否启用流式传输</td>
</tr>
<tr>
<td><code>stream_options</code></td>
<td><code>dict</code></td>
<td><code>None</code></td>
<td>流式配置（如 <code>{"include_usage": true}</code>）</td>
</tr>
</tbody>
</table>
<h5 id="_21"><strong>模型推理控制</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>reasoning_effort</code></td>
<td><code>Literal["low","medium","high"]</code></td>
<td><code>None</code></td>
<td>推理强度（影响响应质量与延迟）</td>
</tr>
<tr>
<td><code>prediction</code></td>
<td><code>ChatCompletionPredictionContentParam</code></td>
<td><code>None</code></td>
<td>预测内容结构化参数</td>
</tr>
<tr>
<td><code>thinking</code></td>
<td><code>AnthropicThinkingParam</code></td>
<td><code>None</code></td>
<td>Anthropic 模型专用思考控制</td>
</tr>
</tbody>
</table>
<h5 id="_22"><strong>搜索与响应格式</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>web_search_options</code></td>
<td><code>OpenAIWebSearchOptions</code></td>
<td><code>None</code></td>
<td>网络搜索配置（如启用实时搜索）</td>
</tr>
<tr>
<td><code>response_format</code></td>
<td><code>Union[dict, Type[BaseModel]]</code></td>
<td><code>None</code></td>
<td>响应格式（如 <code>{"type": "json_object"}</code> 或 Pydantic 模型）</td>
</tr>
</tbody>
</table>
<h5 id="api"><strong>API 配置</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>api_key</code></td>
<td><code>str</code></td>
<td><code>None</code></td>
<td>覆盖默认 API 密钥</td>
</tr>
<tr>
<td><code>base_url</code></td>
<td><code>str</code></td>
<td><code>None</code></td>
<td>覆盖 API 地址（如 Azure 端点）</td>
</tr>
<tr>
<td><code>api_version</code></td>
<td><code>str</code></td>
<td><code>None</code></td>
<td>指定 API 版本（Azure 必需）</td>
</tr>
<tr>
<td><code>model_list</code></td>
<td><code>list</code></td>
<td><code>None</code></td>
<td>多模型配置列表（负载均衡/故障转移）</td>
</tr>
<tr>
<td><code>deployment_id</code></td>
<td><code>str</code></td>
<td><code>None</code></td>
<td>Azure 部署 ID</td>
</tr>
</tbody>
</table>
<h5 id="_23"><strong>其他参数</strong></h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>timeout</code></td>
<td><code>Union[float, str, httpx.Timeout]</code></td>
<td><code>None</code></td>
<td>请求超时时间（秒或 <code>httpx.Timeout</code> 对象）</td>
</tr>
<tr>
<td><code>extra_headers</code></td>
<td><code>dict</code></td>
<td><code>None</code></td>
<td>自定义 HTTP 头</td>
</tr>
<tr>
<td><code>kwargs</code></td>
<td><code>Any</code></td>
<td>-</td>
<td>兼容未来扩展的额外参数</td>
</tr>
</tbody>
</table>
<h5 id="_24"><strong>返回值</strong></h5>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ModelResponse</code></td>
<td>非流式响应时的结构化对象</td>
</tr>
<tr>
<td><code>CustomStreamWrapper</code></td>
<td>流式响应时的迭代器包装器</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>关键说明</strong>：
1. 部分参数（如 <code>modalities</code>、<code>audio</code>）需特定模型支持（如 GPT-4o）
2. <code>tools</code> 已取代 <code>functions</code>，推荐使用新参数
3. openai接口完整文档参考：<a href="https://platform.openai.com/docs/api-reference/chat/create">OpenAI API 文档</a>(https://platform.openai.com/docs/api-reference/chat/create)</p>
</blockquote>
<h3 id="litellm-python-sdk_2">LiteLLM Python SDK 实践</h3>
<p>下面的实践中主要使用了 <strong>completion</strong> 方法的<strong>基础参数(model和messages)和API 配置参数(base_url 和 api_key)</strong>。</p>
<blockquote>
<p>⚠️注意：使用 model 参数时需要在模型名称前面添加 provider 的名称，查看 <a href="https://docs.litellm.ai/docs/providers">litellm 支持的 provider</a> 。
在 LiteLLM 中，<code>model</code> 参数的设计非常灵活，它允许你通过一个字符串同时指定模型名称和提供商（provider），这种设计主要是为了简化多模型、多提供商的调用管理。</p>
<p><strong>provider 名称的作用</strong>
1. 确定 API 端点：如果没有指定 base_url 参数，那么则LiteLLM 根据 provider 名称确定应该将请求发送到哪个 API 端点。
2. 选择正确的认证方式：不同的提供商使用不同的认证方式（例如 API Key 的位置和格式）。LiteLLM 会根据 provider 使用正确的认证方式。
3. 转换请求格式：每个提供商的 API 请求格式可能不同。LiteLLM 会将标准的 <code>messages</code> 列表转换为目标提供商所需的格式。
4. 转换响应格式：LiteLLM 会将不同提供商的响应转换为统一的标准格式（类似于 OpenAI 的格式）。</p>
<p>如果你有一个自定义模型或者本地部署的模型，可能就需要明确指定 provider。</p>
<p>因为这里实践使用的 <a href="https://api-docs.deepseek.com/zh-cn/">deepseek</a> 和 <a href="https://www.aliyun.com/product/bailian">阿里云百炼</a> 这两个平台提供的服务接口都兼容 <strong>openai</strong> 接口格式，所以在设置 <strong>model</strong> 参数时都应该在模型的名称前面加上 <strong>openai/</strong>，例如：<code>openai/qwen-turbo</code> 或 <code>openai/deepseek-chat</code></p>
</blockquote>
<h4 id="1">1.非流式对话</h4>
<h5 id="_25">使用阿里云百炼平台非流式对话</h5>
<p>参考文档：<a href="https://bailian.console.aliyun.com/?tab=api#/api/?type=model&amp;url=https%3A%2F%2Fhelp.aliyun.com%2Fdocument_detail%2F2712576.html&amp;renderType=iframe">通义千问 API 的输入输出参数</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">litellm</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">BAILIAN_API_KEY</span> <span class="o">=</span> <span class="s2">&quot;sk-a47e70844cc843cea2ba5f23663f13d5&quot;</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BAILIAN_API_KEY</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="p">)</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Message(content=&#39;我是通义千问，阿里巴巴集团旗下的通义实验室自主研发的超大规模语言模型。我能够帮助您回答问题、创作文字，如写故事、公文、技术文档等，还能进行逻辑推理、编程，表达观点，玩游戏等。如果您有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None})
</code></pre></div>
<h6 id="deepseek">使用 deepseek 非流式对话</h6>
<p>参考 <a href="https://api-docs.deepseek.com/zh-cn/">deepseek 官方文档</a>，可以知道 <code>base_url=https://api.deepseek.com/</code>, 因为 deepseek 平台提供的接口也是兼容 openai 接口的，所以 model 参数需要设置为 <code>openai/deepseek-chat</code>，deepseek 其他可选的模型名称可以在deepseek官网查看。</p>
<p>下面是使用 litellm 集成 deepseek 模型服务非流式接口的示例：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">litellm</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">DEEPSEEK_API_KEY</span> <span class="o">=</span> <span class="s2">&quot;sk-783df6a1c50445d7b0994a7a5b3ef6e3&quot;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEEPSEEK_API_KEY</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.deepseek.com/&quot;</span><span class="p">,</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="p">)</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Message(content=&#39;我是DeepSeek Chat，由深度求索公司创造的智能AI助手！🤖✨ 我的使命是为你提供各种问题的解答、创意灵感、学习辅助，甚至陪你聊天解闷。无论是知识查询、写作建议，还是日常小困惑，都可以问我哦！有什么我可以帮你的吗？😊&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None})
</code></pre></div>
<h4 id="2">2.流式对话</h4>
<p>使用 litellm 开启流式对话非常简单，只需要在 <code>completion</code> 方法中添加参数 <code>stream=True</code> 即可，如下所示：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">litellm</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 开启流式对话</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="c1"># 流式对话completion方法返回的是 CustomStreamWrapper，可以迭代获取流式对话的chunk</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Delta(provider_specific_fields=None, refusal=None, content=&#39;我是&#39;, role=&#39;assistant&#39;, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;通&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;义&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;千问，阿里巴巴&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;集团旗下的通义&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;实验室自主研发的超&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;大规模语言模型。&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;我能够帮助您&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;回答问题、创作&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;文字，如写&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;故事、公文&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;、技术文档等&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;，还能进行逻辑&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;推理、编程，&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;表达观点，玩游戏&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;等。如果您有任何&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;问题或需要帮助&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;，欢迎随时告诉我&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;！&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, content=None, role=None, function_call=None, tool_calls=None, audio=None)
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">litellm</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.deepseek.com/&quot;</span><span class="p">,</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 开启流式对话</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="p">)</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Delta(provider_specific_fields=None, refusal=None, content=&#39;我是&#39;, role=&#39;assistant&#39;, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;Deep&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;Se&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;ek&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39; Chat&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;，&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;由&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;深度&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;求&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;索&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;公司&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;创造的&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;智能&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;AI&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;助手&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;！&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;🤖&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;✨&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39; &#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;我的&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;使命&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;是&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;帮助你&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;解答&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;各种&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;问题&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;，&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;无论是&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;学习&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;、&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;工作&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;，&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;还是&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;日常&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;生活中的&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;小&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;困惑&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;。&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;我可以&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;陪你&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;聊天&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;、&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;提供&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;建议&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;、&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;查找&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;信息&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;，&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;甚至&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;帮你&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;分析&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;文档&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;！&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;📚&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;💡&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;  \n\n&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;有什么&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;我可以&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;帮&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;你的&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;吗&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;？&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, refusal=None, content=&#39;😊&#39;, role=None, function_call=None, tool_calls=None, audio=None)
Delta(provider_specific_fields=None, content=None, role=None, function_call=None, tool_calls=None, audio=None)
</code></pre></div>
<h5 id="_26">流式对话辅助函数</h5>
<p>LiteLLM还提供了一个辅助函数 <code>litellm.stream_chunk_builder</code>，用于从chunk列表中重建完整的流响应。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">litellm</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.deepseek.com/&quot;</span><span class="p">,</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 开启流式对话</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="p">)</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="n">model_response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">stream_chunk_builder</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_response</span><span class="p">)</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>ModelResponse(id=&#39;chatcmpl-fc4abbab-0992-432a-8141-6b23098508ae&#39;, created=1749107445, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司创造的智能AI助手！🤖✨ 我的目标是帮助你解答问题、提供信息、陪你聊天，还能处理各种文本和文件内容。无论是学习、工作还是日常生活中的疑问，都可以来问我！有什么我可以帮你的吗？😊&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields=None))], usage=Usage(completion_tokens=61, prompt_tokens=4, total_tokens=65, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None))
我是DeepSeek Chat，由深度求索公司创造的智能AI助手！🤖✨ 我的目标是帮助你解答问题、提供信息、陪你聊天，还能处理各种文本和文件内容。无论是学习、工作还是日常生活中的疑问，都可以来问我！有什么我可以帮你的吗？😊
</code></pre></div>
<h5 id="_27">异步流式对话</h5>
<p><code>litellm.completion</code> 方法在返回的流对象中实现了一个<code>__anext__（）</code>函数，这允许对流对象进行异步迭代。</p>
<p>使用方法如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="n">model_config_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="s2">&quot;deepseek-chat&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="p">},</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="p">}</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">llm_chat</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;使用的模型如下：</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}]</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">litellm</span><span class="o">.</span><span class="n">acompletion</span><span class="p">(</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>        <span class="n">model</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">),</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>        <span class="n">base_url</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_url&#39;</span><span class="p">),</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>        <span class="n">api_key</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">),</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>        <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>    <span class="p">)</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>    <span class="k">return</span> <span class="n">response</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="n">response</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">llm_chat</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;deepseek-chat&#39;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="s1">&#39;你是谁&#39;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="_28">函数调用</h4>
<p>接下来重点介绍LiteLLM的函数调用功能，包括如何使用、支持的模型以及底层机制</p>
<p>函数调用（Function Calling）允许大模型根据用户输入智能调用预定义的工具函数。LiteLLM通过标准化接口支持多种模型提供商的函数调用功能。</p>
<p>关键点：</p>
<ol>
<li>
<p>统一接口：使用OpenAI格式的函数定义</p>
</li>
<li>
<p>多模型支持：包括OpenAI, Anthropic, Azure, Google等</p>
</li>
<li>
<p>自动转换：将非OpenAI模型的函数调用响应转换为OpenAI格式</p>
</li>
</ol>
<p>使用步骤：</p>
<ol>
<li>
<p>定义工具函数列表（tools）</p>
</li>
<li>
<p>在completion调用中传入tools参数</p>
</li>
<li>
<p>解析模型返回的工具调用请求</p>
</li>
<li>
<p>执行本地函数</p>
</li>
<li>
<p>将函数执行结果传回模型（可选，用于多轮对话）</p>
</li>
</ol>
<p>下面详细展开：</p>
<blockquote>
<p>如果要使用函数调用功能，那么选择的模型需要支持函数调用，在 litellm 中提供了一个工具方法 <code>litellm.supports_function_calling</code> 用来检查模型是否支持函数调用。</p>
<p><code>litellm.supports_function_calling</code> 方法是从 https://github.com/BerriAI/litellm/blob/main/model_prices_and_context_window.json 中查询模型是否支持函数调用。</p>
<p>如果选择的模型没有在这个字典中，则无法通过该方法判断，所以应该从平台上面选择支持函数调用的模型。</p>
<p>查看 deepseek 官网，可以看到 <strong>deepseek-chat</strong> 支持函数调用。</p>
</blockquote>
<p>函数调用流程如下：
<pre class="mermaid"><code>graph LR
    A[用户请求] --&gt; B(模型分析)
    B --&gt; C{是否需要工具}
    C -- 是 --&gt; D[返回工具调用请求]
    C -- 否 --&gt; E[直接生成回答]
    D --&gt; F[开发者执行函数]
    F --&gt; G[返回函数结果]
    G --&gt; H[模型整合结果]
    H --&gt; I[最终响应]</code></pre>
下面是实践代码：</p>
<h6 id="1_1">1. 定义工具函数</h6>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c1"># 定义工具参数结构</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">WeatherParams</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;城市名称，如 &#39;北京&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;温度单位&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;celsius&quot;</span><span class="p">)</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="c1"># 定义股票查询工具</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">StockParams</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;股票代码，如 &#39;AAPL&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;时间范围&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span><span class="p">)</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_weather</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="n">weather</span> <span class="o">=</span> <span class="n">WeatherParams</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="k">if</span> <span class="s1">&#39;上海&#39;</span> <span class="ow">in</span> <span class="n">weather</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;上海&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;celsius&quot;</span><span class="p">}</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="k">elif</span> <span class="s2">&quot;北京&quot;</span> <span class="ow">in</span> <span class="n">weather</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;北京&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;72&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;fahrenheit&quot;</span><span class="p">}</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="k">elif</span> <span class="s2">&quot;成都&quot;</span> <span class="ow">in</span> <span class="n">weather</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;成都&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;celsius&quot;</span><span class="p">}</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">weather</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;不知道&quot;</span><span class="p">}</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_stock_price</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>    <span class="n">stock_param</span> <span class="o">=</span> <span class="n">StockParams</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>    <span class="k">if</span> <span class="s1">&#39;AAPL&#39;</span> <span class="ow">in</span> <span class="n">stock_param</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;苹果&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="s2">&quot;202.82&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">}</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>    <span class="k">elif</span> <span class="s2">&quot;AMZN&quot;</span> <span class="ow">in</span> <span class="n">stock_param</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;AMZN&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;亚马逊&quot;</span><span class="p">,</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="s2">&quot;207.23&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">}</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">stock_param</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="s2">&quot;不知道&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">}</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="c1"># 工具列表</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>    <span class="p">{</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_weather&quot;</span><span class="p">,</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;获取指定位置的当前天气&quot;</span><span class="p">,</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">WeatherParams</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>        <span class="p">}</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>    <span class="p">},</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>    <span class="p">{</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_stock_price&quot;</span><span class="p">,</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;获取股票最新价格&quot;</span><span class="p">,</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">StockParams</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>        <span class="p">}</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>    <span class="p">}</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a><span class="p">]</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a><span class="n">tools</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[{&#39;type&#39;: &#39;function&#39;,
  &#39;function&#39;: {&#39;name&#39;: &#39;get_weather&#39;,
   &#39;description&#39;: &#39;获取指定位置的当前天气&#39;,
   &#39;parameters&#39;: {&#39;properties&#39;: {&#39;location&#39;: {&#39;description&#39;: &quot;城市名称，如 &#39;北京&#39;&quot;,
      &#39;title&#39;: &#39;Location&#39;,
      &#39;type&#39;: &#39;string&#39;},
     &#39;unit&#39;: {&#39;default&#39;: &#39;celsius&#39;,
      &#39;description&#39;: &#39;温度单位&#39;,
      &#39;title&#39;: &#39;Unit&#39;,
      &#39;type&#39;: &#39;string&#39;}},
    &#39;required&#39;: [&#39;location&#39;],
    &#39;title&#39;: &#39;WeatherParams&#39;,
    &#39;type&#39;: &#39;object&#39;}}},
 {&#39;type&#39;: &#39;function&#39;,
  &#39;function&#39;: {&#39;name&#39;: &#39;get_stock_price&#39;,
   &#39;description&#39;: &#39;获取股票最新价格&#39;,
   &#39;parameters&#39;: {&#39;properties&#39;: {&#39;symbol&#39;: {&#39;description&#39;: &quot;股票代码，如 &#39;AAPL&#39;&quot;,
      &#39;title&#39;: &#39;Symbol&#39;,
      &#39;type&#39;: &#39;string&#39;},
     &#39;timeframe&#39;: {&#39;default&#39;: &#39;1d&#39;,
      &#39;description&#39;: &#39;时间范围&#39;,
      &#39;title&#39;: &#39;Timeframe&#39;,
      &#39;type&#39;: &#39;string&#39;}},
    &#39;required&#39;: [&#39;symbol&#39;],
    &#39;title&#39;: &#39;StockParams&#39;,
    &#39;type&#39;: &#39;object&#39;}}}]
</code></pre></div>
<h5 id="2_1">2. 发起函数调用请求</h5>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">model_config_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="s2">&quot;deepseek-chat&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>        <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>        <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="p">},</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="p">}</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">llm_chat</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;使用的模型如下：</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}]</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>        <span class="n">model</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">),</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>        <span class="n">base_url</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_url&#39;</span><span class="p">),</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>        <span class="n">api_key</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">),</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>        <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>    <span class="p">)</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>    <span class="k">return</span> <span class="n">response</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;上海现在的天气怎么样？苹果股价是多少？&quot;</span><span class="p">}]</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="n">response</span> <span class="o">=</span> <span class="n">llm_chat</span><span class="p">(</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>    <span class="n">model</span><span class="o">=</span><span class="s1">&#39;deepseek-chat&#39;</span><span class="p">,</span> 
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> 
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>    <span class="n">stream</span><span class="o">=</span><span class="kc">False</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="p">)</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="n">response</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>ModelResponse(id=&#39;5de8bff5-fa6b-414e-9948-62f43d4abb07&#39;, created=1749126781, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;tool_calls&#39;, index=0, message=Message(content=&#39;&#39;, role=&#39;assistant&#39;, tool_calls=[ChatCompletionMessageToolCall(index=0, function=Function(arguments=&#39;{&quot;location&quot;: &quot;上海&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;, name=&#39;get_weather&#39;), id=&#39;call_0_afd2cb42-f93d-45f6-9a40-32020366337b&#39;, type=&#39;function&#39;), ChatCompletionMessageToolCall(index=1, function=Function(arguments=&#39;{&quot;symbol&quot;: &quot;AAPL&quot;}&#39;, name=&#39;get_stock_price&#39;), id=&#39;call_1_f800d8fb-3084-425f-bb5f-fc62a45bc047&#39;, type=&#39;function&#39;)], function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=48, prompt_tokens=323, total_tokens=371, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=320, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=320, prompt_cache_miss_tokens=3), service_tier=None)
</code></pre></div>
<h5 id="3">3. 解析并执行工具调用</h5>
<p>在函数调用的流程中，正确的消息顺序应该是：</p>
<ol>
<li>
<p>用户消息（user）或系统消息（system）</p>
</li>
<li>
<p>模型的消息，其中包含了 <code>tool_calls</code>（表示模型决定调用工具）</p>
</li>
<li>
<p>工具消息（tool），作为对 <code>tool_calls</code> 的响应</p>
</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">available_functions</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>                <span class="s2">&quot;get_weather&quot;</span><span class="p">:</span> <span class="n">get_weather</span><span class="p">,</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>                <span class="s2">&quot;get_stock_price&quot;</span><span class="p">:</span> <span class="n">get_stock_price</span><span class="p">,</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>            <span class="p">}</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute_tool_call</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;处理工具调用并返回更新后的消息列表&quot;&quot;&quot;</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;tool_calls&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>        <span class="k">return</span> <span class="n">messages</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="n">updated_messages</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="c1"># 添加模型的消息（包含tool_calls）</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="c1"># updated_messages.append({</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>    <span class="c1">#     &quot;role&quot;: &quot;assistant&quot;,</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>    <span class="c1">#     &quot;content&quot;: None,</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>    <span class="c1">#     &quot;tool_calls&quot;: [</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>    <span class="c1">#         {</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>    <span class="c1">#             &quot;id&quot;: call.id,</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>    <span class="c1">#             &quot;type&quot;: &quot;function&quot;,</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>    <span class="c1">#             &quot;function&quot;: {</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>    <span class="c1">#                 &quot;name&quot;: call.function.name,</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>    <span class="c1">#                 &quot;arguments&quot;: call.function.arguments</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>    <span class="c1">#             }</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>    <span class="c1">#         } for call in tool_calls</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>    <span class="c1">#     ]</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>    <span class="c1"># })</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>    <span class="c1"># 添加模型的消息，与前面构造的模型消息相似</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>    <span class="n">updated_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>    <span class="c1"># 执行工具并添加结果</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>    <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>        <span class="n">function_name</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>        <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>        <span class="c1"># 执行对应函数</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>        <span class="n">function_to_call</span> <span class="o">=</span> <span class="n">available_functions</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>        <span class="n">function_response</span> <span class="o">=</span> <span class="n">function_to_call</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>        <span class="n">updated_messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">function_response</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>            <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a>        <span class="p">})</span>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a>    <span class="k">return</span> <span class="n">updated_messages</span><span class="p">,</span> <span class="n">tool_calls</span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a><span class="n">updated_messages</span><span class="p">,</span> <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">execute_tool_call</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a><span class="n">updated_messages</span><span class="p">,</span> <span class="n">tool_calls</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>([{&#39;role&#39;: &#39;user&#39;, &#39;content&#39;: &#39;上海现在的天气怎么样？苹果股价是多少？&#39;},
  Message(content=&#39;&#39;, role=&#39;assistant&#39;, tool_calls=[ChatCompletionMessageToolCall(index=0, function=Function(arguments=&#39;{&quot;location&quot;: &quot;上海&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;, name=&#39;get_weather&#39;), id=&#39;call_0_afd2cb42-f93d-45f6-9a40-32020366337b&#39;, type=&#39;function&#39;), ChatCompletionMessageToolCall(index=1, function=Function(arguments=&#39;{&quot;symbol&quot;: &quot;AAPL&quot;}&#39;, name=&#39;get_stock_price&#39;), id=&#39;call_1_f800d8fb-3084-425f-bb5f-fc62a45bc047&#39;, type=&#39;function&#39;)], function_call=None, provider_specific_fields={&#39;refusal&#39;: None}),
  {&#39;role&#39;: &#39;tool&#39;,
   &#39;name&#39;: &#39;get_weather&#39;,
   &#39;content&#39;: &#39;{&quot;location&quot;: &quot;上海&quot;, &quot;temperature&quot;: &quot;10&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;,
   &#39;tool_call_id&#39;: &#39;call_0_afd2cb42-f93d-45f6-9a40-32020366337b&#39;},
  {&#39;role&#39;: &#39;tool&#39;,
   &#39;name&#39;: &#39;get_stock_price&#39;,
   &#39;content&#39;: &#39;{&quot;symbol&quot;: &quot;AAPL&quot;, &quot;name&quot;: &quot;苹果&quot;, &quot;price&quot;: &quot;202.82&quot;, &quot;unit&quot;: &quot;USD&quot;}&#39;,
   &#39;tool_call_id&#39;: &#39;call_1_f800d8fb-3084-425f-bb5f-fc62a45bc047&#39;}],
 [ChatCompletionMessageToolCall(index=0, function=Function(arguments=&#39;{&quot;location&quot;: &quot;上海&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;, name=&#39;get_weather&#39;), id=&#39;call_0_afd2cb42-f93d-45f6-9a40-32020366337b&#39;, type=&#39;function&#39;),
  ChatCompletionMessageToolCall(index=1, function=Function(arguments=&#39;{&quot;symbol&quot;: &quot;AAPL&quot;}&#39;, name=&#39;get_stock_price&#39;), id=&#39;call_1_f800d8fb-3084-425f-bb5f-fc62a45bc047&#39;, type=&#39;function&#39;)])
</code></pre></div>
<h5 id="4">4. 获取最终响应</h5>
<p>将函数执行结果传回模型（可选，用于多轮对话）</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">final_response</span> <span class="o">=</span> <span class="n">llm_chat</span><span class="p">(</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="n">model</span><span class="o">=</span><span class="s1">&#39;deepseek-chat&#39;</span><span class="p">,</span> 
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">updated_messages</span><span class="p">,</span> 
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="n">stream</span><span class="o">=</span><span class="kc">False</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="p">)</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最终回答:&quot;</span><span class="p">,</span> <span class="n">final_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>/Users/xiniao/myenv/lib/python3.12/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
  PydanticSerializationUnexpectedValue(Expected `ChatCompletionMessageToolCall` - serialized value may not be as expected [input_value={&#39;index&#39;: 0, &#39;function&#39;: ...7b&#39;, &#39;type&#39;: &#39;function&#39;}, input_type=dict])
  PydanticSerializationUnexpectedValue(Expected `ChatCompletionMessageToolCall` - serialized value may not be as expected [input_value={&#39;index&#39;: 1, &#39;function&#39;: ...47&#39;, &#39;type&#39;: &#39;function&#39;}, input_type=dict])
  return self.__pydantic_serializer__.to_python(


最终回答: 上海现在的天气是10°C。苹果(AAPL)的股价目前是202.82美元。
</code></pre></div>
<h2 id="litellm_4">LiteLLM 智能路由功能详解</h2>
<p>LiteLLM 的动态路由是其最强大的功能之一，它允许开发者构建智能的模型调用网关，根据成本、性能、可用性等指标自动选择最优模型。</p>
<p>在 LiteLLM 中提供了<code>Router</code>类，<code>Router</code>类的作用覆盖了模型管理、缓存、调度、可靠性、回退策略、路由策略、故障处理、预算控制等多个方面，提供了高度可配置的路由机制。通过合理配置这些参数，可以构建出适应不同场景需求的智能模型路由系统。</p>
<h2 id="litellm-router">LiteLLM Router 参数详解</h2>
<p>查看 <code>Router</code>类的源码参数如下：
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>        <span class="n">model_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>            <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">DeploymentTypedDict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>        <span class="c1">## ASSISTANTS API ##</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>        <span class="n">assistants_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AssistantsTypedDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>        <span class="c1">## CACHING ##</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>        <span class="n">redis_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>        <span class="n">redis_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>        <span class="n">redis_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>        <span class="n">redis_password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>        <span class="n">cache_responses</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>        <span class="n">cache_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># additional kwargs to pass to RedisCache (see caching.py)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>        <span class="n">caching_groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>            <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># if you want to cache across model groups</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>        <span class="n">client_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># ttl for cached clients - will re-initialize after this time in seconds</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>        <span class="c1">## SCHEDULER ##</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>        <span class="n">polling_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>        <span class="n">default_priority</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>        <span class="c1">## RELIABILITY ##</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>        <span class="n">num_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>        <span class="n">max_fallbacks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>            <span class="nb">int</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># max fallbacks to try before exiting the call. Defaults to 5.</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>        <span class="n">stream_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>        <span class="n">default_litellm_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>            <span class="nb">dict</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># default params for Router.chat.completion.create</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>        <span class="n">default_max_parallel_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>        <span class="n">set_verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>        <span class="n">debug_level</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>        <span class="n">default_fallbacks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>            <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># generic fallbacks, works across all deployments</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a>        <span class="n">fallbacks</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>        <span class="n">context_window_fallbacks</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>        <span class="n">content_policy_fallbacks</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>        <span class="n">model_group_alias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>            <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RouterModelGroupAliasItem</span><span class="p">]]</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a>        <span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>        <span class="n">enable_pre_call_checks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>        <span class="n">enable_tag_filtering</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>        <span class="n">retry_after</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># min time to wait before retrying a failed request</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a>        <span class="n">retry_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>            <span class="n">Union</span><span class="p">[</span><span class="n">RetryPolicy</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># set custom retries for different exceptions</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>        <span class="n">model_group_retry_policy</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a>            <span class="nb">str</span><span class="p">,</span> <span class="n">RetryPolicy</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a>        <span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># set custom retry policies based on model group</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a>        <span class="n">allowed_fails</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>            <span class="nb">int</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Number of times a deployment can failbefore being added to cooldown</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>        <span class="n">allowed_fails_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a>            <span class="n">AllowedFailsPolicy</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># set custom allowed fails policy</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>        <span class="n">cooldown_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a>            <span class="nb">float</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># (seconds) time to cooldown a deployment after failure</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>        <span class="n">disable_cooldowns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a>        <span class="n">routing_strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>            <span class="s2">&quot;simple-shuffle&quot;</span><span class="p">,</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a>            <span class="s2">&quot;least-busy&quot;</span><span class="p">,</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>            <span class="s2">&quot;usage-based-routing&quot;</span><span class="p">,</span>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a>            <span class="s2">&quot;latency-based-routing&quot;</span><span class="p">,</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a>            <span class="s2">&quot;cost-based-routing&quot;</span><span class="p">,</span>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a>            <span class="s2">&quot;usage-based-routing-v2&quot;</span><span class="p">,</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;simple-shuffle&quot;</span><span class="p">,</span>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a>        <span class="n">optional_pre_call_checks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OptionalPreCallChecks</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a>        <span class="n">routing_strategy_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># just for latency-based</span>
</span><span id="__span-19-73"><a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a>        <span class="n">provider_budget_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenericBudgetConfigType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-74"><a id="__codelineno-19-74" name="__codelineno-19-74" href="#__codelineno-19-74"></a>        <span class="n">alerting_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AlertingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-75"><a id="__codelineno-19-75" name="__codelineno-19-75" href="#__codelineno-19-75"></a>        <span class="n">router_general_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-19-76"><a id="__codelineno-19-76" name="__codelineno-19-76" href="#__codelineno-19-76"></a>            <span class="n">RouterGeneralSettings</span>
</span><span id="__span-19-77"><a id="__codelineno-19-77" name="__codelineno-19-77" href="#__codelineno-19-77"></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">RouterGeneralSettings</span><span class="p">(),</span>
</span><span id="__span-19-78"><a id="__codelineno-19-78" name="__codelineno-19-78" href="#__codelineno-19-78"></a>        <span class="n">ignore_invalid_deployments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-79"><a id="__codelineno-19-79" name="__codelineno-19-79" href="#__codelineno-19-79"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></code></pre></div></p>
<p>为了更好的使用<code>Router</code>类，下面是对 <code>Router</code> 类初始化参数的详细解释，按功能分类说明：</p>
<h3 id="_29">一、核心模型配置</h3>
<ol>
<li><code>model_list</code></li>
<li><strong>作用</strong>：定义路由管理的模型列表，每个模型是一个字典，包含模型别名和具体的调用参数。</li>
<li><strong>格式</strong>：字典列表，每个字典包含模型配置</li>
<li>
<p><strong>示例</strong>：
  <div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="p">[</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    <span class="p">{</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;azure-gpt-4&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="err">。</span><span class="c1"># 具体的调用参数</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;azure/gpt-4-turbo&quot;</span><span class="p">,</span>  <span class="c1"># 实际模型名</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>        <span class="p">},</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4-turbo&quot;</span><span class="p">}</span>  <span class="c1"># 额外模型信息</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="p">},</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>    <span class="c1"># 更多模型...</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="p">]</span>
</span></code></pre></div></p>
</li>
<li>
<p><code>assistants_config</code></p>
</li>
<li><strong>作用</strong>：配置 OpenAI Assistants API 相关参数</li>
<li><strong>类型</strong>：字典</li>
<li><strong>用途</strong>：构建基于助手的工作流</li>
</ol>
<h3 id="_30">二、缓存配置</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>redis_url</code></td>
<td>Redis服务器的URL，用于缓存响应。如果提供，将覆盖<code>redis_host</code>和<code>redis_port</code></td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>redis_host</code></td>
<td>Redis 主机地址</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>redis_port</code></td>
<td>Redis 端口</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>redis_password</code></td>
<td>Redis 密码</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>cache_responses</code></td>
<td>是否缓存响应</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>cache_kwargs</code></td>
<td>传递给缓存系统的额外参数</td>
<td><code>{}</code></td>
</tr>
<tr>
<td><code>caching_groups</code></td>
<td>跨模型组的缓存配置</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>client_ttl</code></td>
<td>客户端缓存生存时间（秒）</td>
<td><code>3600</code> (1小时)</td>
</tr>
</tbody>
</table>
<h3 id="_31">三、调度与队列</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>polling_interval</code></td>
<td>轮询队列的频率（秒）</td>
<td>用于 <code>.scheduler_acompletion()</code></td>
</tr>
<tr>
<td><code>default_priority</code></td>
<td>请求的默认优先级,优先级高的请求会被优先处理</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<h3 id="_32">四、可靠性配置</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>num_retries</code></td>
<td>失败请求的重试次数</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>max_fallbacks</code></td>
<td>最大回退尝试次数</td>
<td><code>5</code></td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>请求超时时间（秒）</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>stream_timeout</code></td>
<td>流式请求超时时间（秒）</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>retry_after</code></td>
<td>重试前最小等待时间（秒）</td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>retry_policy</code></td>
<td>使用<code>RetryPolicy</code>自定义重试策略</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>model_group_retry_policy</code></td>
<td>按模型组的重试策略</td>
<td><code>{}</code></td>
</tr>
</tbody>
</table>
<h3 id="_33">五、回退策略</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>default_fallbacks</code></td>
<td>通用回退列表，适用于所有部署。当主模型失败时，会尝试回退到列表中的模型。</td>
<td><code>["gpt-3.5-turbo"]</code></td>
</tr>
<tr>
<td><code>fallbacks</code></td>
<td>特定模型的回退链</td>
<td><code>[{"gpt-4": "claude-3"}]</code></td>
</tr>
<tr>
<td><code>context_window_fallbacks</code></td>
<td>上下文窗口不足时的回退</td>
<td><code>[{"llama3": "claude-3"}]</code></td>
</tr>
<tr>
<td><code>content_policy_fallbacks</code></td>
<td>内容策略违规时的回退</td>
<td><code>[{"gpt-4": "gemini"}]</code></td>
</tr>
</tbody>
</table>
<h3 id="_34">六、路由策略</h3>
<ol>
<li><code>routing_strategy</code></li>
<li><strong>作用</strong>：选择路由算法</li>
<li>
<p><strong>可选值</strong>：</p>
<ul>
<li><code>"simple-shuffle"</code>：简单随机选择（默认）</li>
<li><code>"least-busy"</code>：选择当前请求最少的模型</li>
<li><code>"usage-based-routing"</code>：基于使用量（如Token消耗）的路由</li>
<li><code>"latency-based-routing"</code>：基于延迟的路由</li>
<li><code>"cost-based-routing"</code>：基于成本的路由</li>
<li><code>"usage-based-routing-v2"</code>：改进版的使用量路由</li>
</ul>
</li>
<li>
<p><strong>默认值</strong>：<code>"simple-shuffle"</code></p>
</li>
<li>
<p><code>routing_strategy_args</code></p>
</li>
<li><strong>作用</strong>：路由策略的额外参数</li>
<li><strong>类型</strong>：字典</li>
<li><strong>用途</strong>：传递策略特定参数，如成本权重</li>
</ol>
<h3 id="_35">七、模型健康与故障处理</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>allowed_fails</code></td>
<td>故障阈值（触发冷却的失败次数）</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>allowed_fails_policy</code></td>
<td>使用<code>AllowedFailsPolicy</code>自定义故障策略</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>cooldown_time</code></td>
<td>模型冷却时间（秒）</td>
<td><code>1</code></td>
</tr>
<tr>
<td><code>disable_cooldowns</code></td>
<td>是否禁用冷却机制</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<h3 id="_36">八、预检查与过滤</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enable_pre_call_checks</code></td>
<td>是否在调用前检查部署的上下文窗口限制。如果提示超出限制，则过滤掉该部署</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>enable_tag_filtering</code></td>
<td>启用标签过滤</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>optional_pre_call_checks</code></td>
<td>可选的预调用检查配置</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<h3 id="_37">九、模型别名与分组</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model_group_alias</code></td>
<td>模型组别名配置</td>
<td><code>{"fast-group": ["gpt-4", "claude-3"]}</code></td>
</tr>
</tbody>
</table>
<h3 id="_38">十、预算与告警</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>provider_budget_config</code></td>
<td>设置LLM提供商的预算限制。例如，每天为OpenAI设置100美元预算。</td>
<td>字典</td>
</tr>
<tr>
<td><code>alerting_config</code></td>
<td>告警配置（如Slack集成）当发生特定事件（如部署失败）时发送告警</td>
<td><code>AlertingConfig</code></td>
</tr>
</tbody>
</table>
<h3 id="_39">十一、调试与日志</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>set_verbose</code></td>
<td>启用详细日志</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>debug_level</code></td>
<td>日志级别（"DEBUG"/"INFO"）</td>
<td><code>"INFO"</code></td>
</tr>
<tr>
<td><code>ignore_invalid_deployments</code></td>
<td>是否忽略无效的部署。如果为True，则初始化时遇到无效部署不会引发错误，而是跳过并继续。默认为False。</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<h3 id="_40">十二、高级配置</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>default_litellm_params</code></td>
<td>默认调用参数</td>
<td>全局参数覆盖</td>
</tr>
<tr>
<td><code>default_max_parallel_requests</code></td>
<td>默认最大并行请求数</td>
<td>控制并发</td>
</tr>
<tr>
<td><code>router_general_settings</code></td>
<td>路由器通用设置</td>
<td><code>RouterGeneralSettings</code> 对象</td>
</tr>
</tbody>
</table>
<h2 id="_41">参数功能关系图</h2>
<pre class="mermaid"><code>graph TD
    A[模型列表 model_list] --&gt; B[路由策略 routing_strategy]
    B --&gt; C{路由决策}
    C --&gt; D[缓存配置 redis_url等]
    C --&gt; E[回退策略 fallbacks]
    C --&gt; F[故障处理 allowed_fails]
    D --&gt; G[响应返回]
    E --&gt; G
    F --&gt; G
    H[监控告警 alerting_config] --&gt; F
    I[预检查 enable_pre_call_checks] --&gt; C</code></pre>
<h2 id="_42">典型配置示例</h2>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="n">model_list</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>        <span class="p">{</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>            <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;azure/gpt-4-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;azure-key&quot;</span><span class="p">,</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>                <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://azure-endpoint&quot;</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>            <span class="p">},</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>            <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">0.00003</span><span class="p">}</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>        <span class="p">},</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>        <span class="p">{</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;claude-3-haiku&quot;</span><span class="p">,</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>            <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;anthropic/claude-3-haiku&quot;</span><span class="p">,</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;anthropic-key&quot;</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>            <span class="p">},</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>            <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">0.00001</span><span class="p">}</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>        <span class="p">}</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>    <span class="p">],</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;cost-based-routing&quot;</span><span class="p">,</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>    <span class="n">redis_url</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379&quot;</span><span class="p">,</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>    <span class="n">cache_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>    <span class="n">num_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>    <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>    <span class="n">fallbacks</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;gpt-4-turbo&quot;</span><span class="p">:</span> <span class="s2">&quot;claude-3-haiku&quot;</span><span class="p">}],</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="n">allowed_fails</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>    <span class="n">cooldown_time</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="p">)</span>
</span></code></pre></div>
<h2 id="_43">关键功能说明</h2>
<ol>
<li>
<p><strong>路由策略选择指南</strong>：
   <pre class="mermaid"><code> graph TD
     A[选择路由策略] --&gt; B{关键需求}
     B --&gt;|成本优化| C[cost-based-routing]
     B --&gt;|最低延迟| D[latency-based-routing]
     B --&gt;|高并发| E[least-busy]
     B --&gt;|预算控制| F[usage-based-routing]
     B --&gt;|高可用| G[model-fallback]
     B --&gt;|简单均衡| H[simple-shuffle]
     B --&gt;|自定义逻辑| I[custom-function]</code></pre></p>
</li>
<li>
<p><strong>故障处理流程</strong>：</p>
</li>
<li>模型失败次数超过 <code>allowed_fails</code> 阈值</li>
<li>进入 <code>cooldown_time</code> 秒的冷却期</li>
<li>路由自动切换到回退模型</li>
<li>
<p>冷却结束后重新尝试</p>
</li>
<li>
<p><strong>缓存机制</strong>：</p>
</li>
<li>使用 Redis 存储响应</li>
<li><code>client_ttl</code> 控制缓存有效期</li>
<li>
<p>相同请求直接返回缓存结果</p>
</li>
<li>
<p><strong>预算控制</strong>：</p>
</li>
<li>通过 <code>provider_budget_config</code> 设置预算</li>
<li>超过预算自动切换到其他提供商</li>
<li>支持按天/周/月设置限额</li>
</ol>
<h2 id="_44">核心价值</h2>
<ol>
<li><strong>智能负载均衡</strong>：在多个模型/供应商间分配请求</li>
<li><strong>成本优化</strong>：自动选择性价比最高的模型</li>
<li><strong>高可用性</strong>：故障时自动切换到备用模型</li>
<li><strong>流量控制</strong>：按配额分配调用量</li>
<li><strong>A/B测试</strong>：无缝对比模型性能</li>
</ol>
<h2 id="_45">路由策略实战配置</h2>
<h3 id="_46">随机路由配置</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="p">{</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="p">},</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="p">},</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="p">{</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>        <span class="p">},</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>    <span class="p">},</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="p">]</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="c1"># 创建路由</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;simple-shuffle&quot;</span><span class="p">,</span>  <span class="c1"># 默认路由策略 simple-shuffle，随机选择模型</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="p">)</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="c1"># 使用路由</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="p">)</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="c1"># 使用路由</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a><span class="p">)</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>11:15:13 - LiteLLM Router:INFO: router.py:660 - Routing strategy: simple-shuffle
11:15:14 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/qwen-turbo)[32m 200 OK


ModelResponse(id=&#39;chatcmpl-6c983ebb-54f1-9b7b-8385-347de1515a04&#39;, created=1749179715, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的通义实验室自主研发的超大规模语言模型。我能够帮助你回答问题、创作文字，如写故事、公文、技术文档等，还能进行逻辑推理、编程，表达观点，玩游戏等。如果你有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=64, prompt_tokens=10, total_tokens=74, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None)


11:15:21 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/deepseek-chat)[32m 200 OK


ModelResponse(id=&#39;36c23345-aa7f-4ed8-a525-19d7eb869a3e&#39;, created=1749179715, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司（DeepSeek）创造的智能AI助手！✨ 我的使命是帮助你解答问题、提供信息、陪你聊天，还能帮你处理各种文本、文档等内容。无论是学习、工作，还是日常生活中的小疑问，都可以来找我哦！😊  \n\n有什么我可以帮你的吗？&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=70, prompt_tokens=4, total_tokens=74, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None)
</code></pre></div>
<h2 id="_47">基于权重的随机路由</h2>
<p>对模型设置权重<code>litellm_params["weight"]</code>以比其他模型更频繁地选择一种路由，这适用于<code>simple-shuffle</code>路由策略（如果未选择路由策略，这是默认值）。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="p">{</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>            <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>        <span class="p">},</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="p">},</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>    <span class="p">{</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>            <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 选择此模型比前一个更频繁2倍</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>        <span class="p">},</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>    <span class="p">},</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="p">]</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="c1"># 创建路由</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;simple-shuffle&quot;</span><span class="p">,</span>  <span class="c1"># 默认路由策略 simple-shuffle，随机选择模型</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="p">)</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="c1"># 使用路由</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="p">)</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="c1"># 使用路由</span>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="p">)</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>
</span><span id="__span-23-50"><a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="c1"># 使用路由</span>
</span><span id="__span-23-51"><a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-23-52"><a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-23-53"><a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-23-54"><a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="p">)</span>
</span><span id="__span-23-55"><a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>
</span><span id="__span-23-56"><a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>11:35:29 - LiteLLM Router:INFO: router.py:660 - Routing strategy: simple-shuffle
11:35:29 - LiteLLM Router:INFO: simple_shuffle.py:55 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;, &#39;weight&#39;: 2}, &#39;model_info&#39;: {&#39;id&#39;: &#39;7c6b876813711f84e643255a92267a1ecd18a012c6df37bbfa010ca6572a54eb&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 1e-05}} for model: my-llm-test
11:35:30 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/qwen-turbo)[32m 200 OK
11:35:30 - LiteLLM Router:INFO: simple_shuffle.py:55 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://api.deepseek.com/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/deepseek-chat&#39;, &#39;weight&#39;: 1}, &#39;model_info&#39;: {&#39;id&#39;: &#39;7cc6bbf33429d66def887cba459d00b997960200174b741ccee0d683662febb6&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 3e-05}} for model: my-llm-test


ModelResponse(id=&#39;chatcmpl-595a9128-72f4-9406-b6ea-cafd8b9741dc&#39;, created=1749180931, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的超大规模语言模型。我能够帮助你回答问题、创作文字，如写故事、公文、技术文档等，还能表达观点、玩游戏等。如果你有任何问题或需要帮助，尽管告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=52, prompt_tokens=10, total_tokens=62, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None)


11:35:37 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/deepseek-chat)[32m 200 OK
11:35:37 - LiteLLM Router:INFO: simple_shuffle.py:55 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;, &#39;weight&#39;: 2}, &#39;model_info&#39;: {&#39;id&#39;: &#39;7c6b876813711f84e643255a92267a1ecd18a012c6df37bbfa010ca6572a54eb&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 1e-05}} for model: my-llm-test


ModelResponse(id=&#39;47f1ccde-679d-4b97-ba8d-3c2ffc797c57&#39;, created=1749180931, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司打造的智能AI助手！✨ 我的使命是帮助你解答问题、提供建议、陪你聊天，还能处理各种文本、文档信息。无论是学习、工作，还是日常生活中的小困惑，都可以来找我聊聊！😊  \n\n有什么我可以帮你的吗？&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=64, prompt_tokens=4, total_tokens=68, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None)


11:35:38 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/qwen-turbo)[32m 200 OK


ModelResponse(id=&#39;chatcmpl-31cded70-dda4-98ff-bf1c-acd593954f76&#39;, created=1749180939, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的通义实验室自主研发的超大规模语言模型。我能够帮助您回答问题、创作文字，如写故事、公文、技术文档，还能进行逻辑推理、编程等任务，并支持多种语言。如果您有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=63, prompt_tokens=10, total_tokens=73, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None)
</code></pre></div>
<h2 id="_48">基于最低延迟路由配置</h2>
<p>选择响应时间最短的模型，它根据从模型发送和接收请求的时间缓存并更新模型的响应时间。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>    <span class="p">{</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>        <span class="p">},</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}</span> 
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>    <span class="p">},</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>    <span class="p">{</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>        <span class="p">},</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">}</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>    <span class="p">},</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="p">]</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="c1"># 创建路由</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;latency-based-routing&quot;</span><span class="p">,</span>  <span class="c1"># 选择基于最低延迟路由配置</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="p">)</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="c1"># 循环调用，缓存并更新模型的响应时间，在后续的调用中选择响应时间最短的模型</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">acompletion</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">))</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a><span class="c1"># 使用路由</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a><span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a><span class="p">)</span>
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>12:00:54 - LiteLLM Router:INFO: router.py:660 - Routing strategy: latency-based-routing
12:00:54 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://api.deepseek.com/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/deepseek-chat&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;deepseek-chat&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 3e-05}} for model: my-llm-test
12:00:54 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 1e-05}} for model: my-llm-test
12:00:54 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 1e-05}} for model: my-llm-test
12:00:54 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 1e-05}} for model: my-llm-test
12:00:54 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://api.deepseek.com/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/deepseek-chat&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;deepseek-chat&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 3e-05}} for model: my-llm-test
12:00:56 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/qwen-turbo)[32m 200 OK
12:00:56 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/qwen-turbo)[32m 200 OK
12:00:56 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/qwen-turbo)[32m 200 OK
12:01:00 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/deepseek-chat)[32m 200 OK
12:01:01 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/deepseek-chat)[32m 200 OK
12:01:01 - LiteLLM Router:INFO: router.py:6448 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 1e-05}} for model: my-llm-test


[ModelResponse(id=&#39;c62a00d2-410c-4e8e-ad93-c2692c01231e&#39;, created=1749182454, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司（DeepSeek）研发的智能AI助手！🤖✨ 我可以帮你解答各种问题，比如学习、工作、科技、生活小窍门，甚至陪你聊天解闷。有什么想问的，尽管来吧！😊&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=59, prompt_tokens=4, total_tokens=63, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None), ModelResponse(id=&#39;chatcmpl-3b50779a-a89d-9edf-b94d-ac02558db233&#39;, created=1749182456, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的通义实验室自主研发的超大规模语言模型。我能够帮助你回答问题、创作文字，如写故事、公文、技术文档等，还能进行逻辑推理、编程，表达观点，玩游戏等。如果你有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=64, prompt_tokens=10, total_tokens=74, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None), ModelResponse(id=&#39;chatcmpl-0a80858c-b588-9efc-a633-de9042621458&#39;, created=1749182457, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的超大规模语言模型。我能够帮助您回答问题、创作文字，如写故事、公文、技术文档等，还能进行逻辑推理、表达观点，玩游戏等。如果您有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=57, prompt_tokens=10, total_tokens=67, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None), ModelResponse(id=&#39;chatcmpl-6996d035-f7f3-90f2-baa0-5b05bf83fb41&#39;, created=1749182457, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的超大规模语言模型。我能够帮助你回答问题、创作文字，如写故事、公文、技术文档等，还能进行逻辑推理、表达观点，玩游戏等。如果你有任何问题或需要帮助，尽管告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=56, prompt_tokens=10, total_tokens=66, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None), ModelResponse(id=&#39;9d3fe083-a7d4-437c-a83d-4a5936570846&#39;, created=1749182454, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司（DeepSeek）研发的智能AI助手！🤖✨  \n\n我可以帮你解答各种问题，无论是学习、工作、编程，还是日常生活中的小困惑，都可以来问我！如果你有什么需要，尽管开口吧~ 😊&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=59, prompt_tokens=4, total_tokens=63, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None)]


12:01:02 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/qwen-turbo)[32m 200 OK


ModelResponse(id=&#39;chatcmpl-1f8f351f-2858-9e7c-9de1-33249ac4b589&#39;, created=1749182463, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的超大规模语言模型。我能够帮助您回答问题、创作文字，如写故事、公文、技术文档等，还能表达观点、玩游戏等。如果你有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=53, prompt_tokens=10, total_tokens=63, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None)
</code></pre></div>
<h2 id="_49">基于最少请求路由配置</h2>
<p>选择当前请求最少的模型</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="p">{</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="p">},</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>    <span class="p">},</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>    <span class="p">{</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>        <span class="p">},</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">}</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>    <span class="p">},</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="p">]</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="c1"># 创建路由</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;least-busy&quot;</span><span class="p">,</span>  <span class="c1"># 选择基于最少请求路由配置</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="p">)</span>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="c1"># 循环调用</span>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">acompletion</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">))</span>
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>
</span><span id="__span-25-41"><a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="c1"># 使用路由</span>
</span><span id="__span-25-42"><a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-25-43"><a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-25-44"><a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a><span class="p">)</span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>13:35:20 - LiteLLM Router:INFO: router.py:660 - Routing strategy: least-busy
13:35:20 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://api.deepseek.com/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/deepseek-chat&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;deepseek-chat&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 3e-05}} for model: my-llm-test
13:35:20 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://api.deepseek.com/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/deepseek-chat&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;deepseek-chat&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 3e-05}} for model: my-llm-test
13:35:26 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/deepseek-chat)[32m 200 OK
13:35:31 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/deepseek-chat)[32m 200 OK
13:35:31 - LiteLLM Router:INFO: router.py:6448 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False, &#39;cost&#39;: 1e-05}} for model: my-llm-test


[ModelResponse(id=&#39;0249d7e2-ceef-426d-9d43-62d43008be46&#39;, created=1749188120, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司（DeepSeek）创造的智能对话助手！😊 我的使命是帮助你解答各种问题，无论是学习、工作，还是生活中的小困惑，我都会尽力提供有用的信息和建议。  \n\n你可以问我任何问题，比如：  \n- **知识科普**：黑洞是怎么形成的？  \n- **学习辅导**：如何提高英语写作能力？  \n- **实用建议**：有什么时间管理的好方法？  \n- **娱乐休闲**：推荐几本好看的小说吧！  \n\n我目前是**免费**的，而且支持**长文本对话（128K上下文）**，还能读取你上传的**图片、PDF、Word、Excel等文件**，并从中提取文字信息来帮助你分析内容。  \n\n有什么我可以帮你的吗？😃&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=166, prompt_tokens=4, total_tokens=170, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None), ModelResponse(id=&#39;65ea6058-2214-42a1-9a51-d3178cd83539&#39;, created=1749188120, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司创造的智能AI助手！🤖✨ 我可以帮你解答各种问题、提供知识支持、陪你聊天，甚至帮你处理文档和文件。有什么我可以帮你的吗？😊&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=48, prompt_tokens=4, total_tokens=52, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None)]


13:35:32 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/qwen-turbo)[32m 200 OK


ModelResponse(id=&#39;chatcmpl-ca30bd33-b748-9ff2-9cf9-dcc254c88712&#39;, created=1749188132, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的超大规模语言模型。我能够帮助你回答问题、创作文字，如写故事、公文、技术文档等，还能表达观点，玩游戏等。如果你有任何问题或需要帮助，尽管告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=52, prompt_tokens=10, total_tokens=62, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None)
</code></pre></div>
<h2 id="_50">基于最低成本路由配置</h2>
<p>最低成本路由策略的工作原理。</p>
<ol>
<li>
<p>获取所有健康的部署（deployment）模型</p>
</li>
<li>
<p>选择那些在其提供的rpm（每分钟请求数）和tpm（每分钟token数）限制内的部署</p>
</li>
<li>
<p>对于每个部署，检查它是否在<a href="https://github.com/BerriAI/litellm/blob/main/model_prices_and_context_window.json">litellm_model_cost_map</a>（成本映射表）中存在</p>
</li>
<li>
<p>如果部署不存在于成本映射表中，则使用默认成本（1美元）</p>
</li>
<li>
<p>选择成本最低的部署</p>
</li>
</ol>
<p>可以设置<code>litellm_params["input_cost_per_token"]</code>和<code>litellm_params["output_cost_per_token"]</code>以便在路由时使用自定义成本。
如果设置了自定义成本，使用自定义的成本进行比较。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="p">{</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>            <span class="s2">&quot;input_cost_per_token&quot;</span><span class="p">:</span> <span class="mf">0.00003</span><span class="p">,</span>  <span class="c1"># 每Token成本</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>            <span class="s2">&quot;output_cost_per_token&quot;</span><span class="p">:</span> <span class="mf">0.00003</span><span class="p">,</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>        <span class="p">},</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}</span>  
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>    <span class="p">},</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>    <span class="p">{</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>            <span class="s2">&quot;input_cost_per_token&quot;</span><span class="p">:</span> <span class="mf">0.00001</span><span class="p">,</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>            <span class="s2">&quot;output_cost_per_token&quot;</span><span class="p">:</span> <span class="mf">0.00001</span><span class="p">,</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>        <span class="p">},</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">}</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>    <span class="p">},</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="p">]</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="c1"># 创建路由</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;cost-based-routing&quot;</span><span class="p">,</span>  <span class="c1"># 选择基于最低成本路由配置</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="p">)</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="c1"># 循环调用</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">acompletion</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">))</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>13:57:07 - LiteLLM Router:INFO: router.py:660 - Routing strategy: cost-based-routing
13:57:07 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
13:57:07 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
13:57:07 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
13:57:07 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
13:57:07 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;input_cost_per_token&#39;: 1e-05, &#39;output_cost_per_token&#39;: 1e-05, &#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False, &#39;input_cost_per_token&#39;: 1e-05, &#39;output_cost_per_token&#39;: 1e-05}} for model: my-llm-test
13:57:07 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;input_cost_per_token&#39;: 1e-05, &#39;output_cost_per_token&#39;: 1e-05, &#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False, &#39;input_cost_per_token&#39;: 1e-05, &#39;output_cost_per_token&#39;: 1e-05}} for model: my-llm-test
13:57:08 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/qwen-turbo)[32m 200 OK
13:57:09 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/qwen-turbo)[32m 200 OK


[ModelResponse(id=&#39;chatcmpl-73379046-922b-9e10-9193-cda015839781&#39;, created=1749189429, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的通义实验室自主研发的超大规模语言模型。我能够帮助您回答问题、创作文字，如写故事、公文、技术文档等，还能进行逻辑推理、编程等任务，并支持多语言交流。如果您有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=65, prompt_tokens=10, total_tokens=75, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None), ModelResponse(id=&#39;chatcmpl-b7cfda24-8c92-9e7d-b840-0ec80285c323&#39;, created=1749189429, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的超大规模语言模型。我能够回答问题、创作文字，如写故事、公文、技术文档，还能表达观点，玩游戏等。如果你有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=50, prompt_tokens=10, total_tokens=60, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None)]


/var/folders/ln/2_qqbq993pv1yc5c8_dm5q6h0000gp/T/ipykernel_1818/4150574972.py:41: RuntimeWarning: coroutine &#39;Router.acompletion&#39; was never awaited
  response = await asyncio.gather(*tasks)
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
</code></pre></div>
<h2 id="_51">基于最少使用路由配置</h2>
<p>这将路由到tpm(每分钟token数)使用率最低的部署。</p>
<p>在生产环境中，我们使用Redis来跟踪多个部署中tpm(每分钟token数)的使用情况。</p>
<p>如果传入模型的tpm/rpm限制，这也将对此进行检查，并过滤掉任何超出限制的模型。</p>
<p>对于Azure，rpm(每分钟请求数)=tpm(每分钟token数)/6。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>    <span class="p">{</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>            <span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># 每分钟token数</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>            <span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># 每分钟请求数</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>        <span class="p">},</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}</span>  
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>    <span class="p">},</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>    <span class="p">{</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BAILIAN_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>            <span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>            <span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>        <span class="p">},</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">}</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>    <span class="p">},</span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="p">]</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="c1"># 创建路由</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;usage-based-routing-v2&quot;</span><span class="p">,</span>  <span class="c1"># 选择基于最少使用情况路由配置</span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>    <span class="c1"># cache_responses=True  # 在生产中，我们建议使用Redis缓存。为了在本地快速测试，我们还支持简单的内存缓存。</span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="p">)</span>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="c1"># 循环调用</span>
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">acompletion</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">))</span>
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a><span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</span><span id="__span-27-43"><a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>14:20:05 - LiteLLM Router:INFO: router.py:660 - Routing strategy: usage-based-routing-v2
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;, &#39;tpm&#39;: 100000, &#39;rpm&#39;: 10000, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/qwen-turbo&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;qwen-turbo&#39;, &#39;db_model&#39;: False}} for model: my-llm-test
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM Router:INFO: router.py:6292 - get_available_deployment for model: my-llm-test, Selected deployment: {&#39;model_name&#39;: &#39;my-llm-test&#39;, &#39;litellm_params&#39;: {&#39;api_key&#39;: &#39;sk**********&#39;, &#39;api_base&#39;: &#39;https://api.deepseek.com/v1&#39;, &#39;tpm&#39;: 1000, &#39;rpm&#39;: 100, &#39;use_in_pass_through&#39;: False, &#39;use_litellm_proxy&#39;: False, &#39;merge_reasoning_content_in_choices&#39;: False, &#39;model&#39;: &#39;openai/deepseek-chat&#39;}, &#39;model_info&#39;: {&#39;id&#39;: &#39;deepseek-chat&#39;, &#39;db_model&#39;: False}} for model: my-llm-test
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:05 - LiteLLM:WARNING: logging_callback_manager.py:124 - Cannot add callback - would exceed MAX_CALLBACKS limit of 30. Current callbacks: 30
14:20:10 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/qwen-turbo)[32m 200 OK
14:20:12 - LiteLLM Router:INFO: router.py:1103 - litellm.acompletion(model=openai/deepseek-chat)[32m 200 OK


[ModelResponse(id=&#39;chatcmpl-c1b6361b-864f-9a9f-8f4f-121204e778ff&#39;, created=1749190810, model=&#39;qwen-turbo&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是通义千问，阿里巴巴集团旗下的超大规模语言模型。我能够帮助您回答问题、创作文字，如写故事、公文、技术文档等，还能表达观点、玩游戏等。如果你有任何问题或需要帮助，欢迎随时告诉我！&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=53, prompt_tokens=10, total_tokens=63, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None)), service_tier=None), ModelResponse(id=&#39;59af6dbe-193f-4e30-b4de-c8d01a988e48&#39;, created=1749190806, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司（DeepSeek）研发的AI助手！🤖✨ 我的使命是帮助你解答问题、提供信息、陪你聊天，甚至帮你处理各种文本和文件内容。无论是学习、工作，还是日常生活中的疑问，都可以来找我！😊  \n\n有什么我可以帮你的吗？&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=70, prompt_tokens=4, total_tokens=74, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None)]
</code></pre></div>
<h2 id="_52">失败重试</h2>
<ul>
<li>
<p>对于async和sync函数都支持重试失败的请求。</p>
</li>
<li>
<p>对于RateLimitError，实现了指数退避。</p>
</li>
<li>
<p>对于一般错误，会立即重试</p>
</li>
<li>
<p>支持在重试失败的请求之前设置最短等待时间，可以通过retry_after参数设置。</p>
</li>
</ul>
<p>下面快速浏览一下我们如何设置num_retries=3：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIError</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="p">{</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>        <span class="p">},</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}</span>  
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>    <span class="p">},</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>    <span class="p">{</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>            <span class="c1"># &quot;api_key&quot;: os.getenv(&quot;BAILIAN_API_KEY&quot;),</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>        <span class="p">},</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">}</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>    <span class="p">},</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="p">]</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="c1"># 创建路由</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;simple-shuffle&quot;</span><span class="p">,</span>  
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a>    <span class="n">num_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 失败重试 3 次</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a>    <span class="n">retry_after</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 重试失败的请求之前等待 5 秒</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>    <span class="c1"># cache_responses=True  # 在生产中，我们建议使用Redis缓存。为了在本地快速测试，我们还支持简单的内存缓存。</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="p">)</span>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a>    <span class="c1"># 使用路由</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a>        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;my-llm-test&quot;</span><span class="p">,</span>  <span class="c1"># 使用模型别名调用</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a>        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a>    <span class="p">)</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a><span class="k">except</span> <span class="n">OpenAIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-28-48"><a id="__codelineno-28-48" name="__codelineno-28-48" href="#__codelineno-28-48"></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>14:36:00 - LiteLLM Router:INFO: router.py:660 - Routing strategy: simple-shuffle
14:36:00 - LiteLLM Router:INFO: router.py:911 - litellm.completion(model=openai/deepseek-chat)[31m Exception litellm.AuthenticationError: AuthenticationError: OpenAIException - The api_key client option must be set either by passing api_key to the client or by setting the OPENAI_API_KEY environment variable
14:36:00 - LiteLLM Router:INFO: router.py:3670 - Retrying request with num_retries: 3
14:36:00 - LiteLLM Router:INFO: router.py:911 - litellm.completion(model=openai/qwen-turbo)[31m Exception litellm.AuthenticationError: AuthenticationError: OpenAIException - The api_key client option must be set either by passing api_key to the client or by setting the OPENAI_API_KEY environment variable
14:36:05 - LiteLLM Router:INFO: router.py:911 - litellm.completion(model=openai/qwen-turbo)[31m Exception litellm.AuthenticationError: AuthenticationError: OpenAIException - The api_key client option must be set either by passing api_key to the client or by setting the OPENAI_API_KEY environment variable
14:36:05 - LiteLLM Router:INFO: router.py:911 - litellm.completion(model=openai/deepseek-chat)[31m Exception litellm.AuthenticationError: AuthenticationError: OpenAIException - The api_key client option must be set either by passing api_key to the client or by setting the OPENAI_API_KEY environment variable
14:36:10 - LiteLLM Router:INFO: router.py:3379 - Trying to fallback b/w models


litellm.AuthenticationError: AuthenticationError: OpenAIException - The api_key client option must be set either by passing api_key to the client or by setting the OPENAI_API_KEY environment variable. Received Model Group=my-llm-test
Available Model Group Fallbacks=None LiteLLM Retried: 2 times, LiteLLM Max Retries: 3
</code></pre></div>
<h2 id="_53">模型调用失败回退策略配置</h2>
<p>Fallbacks（回退机制）是 LiteLLM 的核心高可用特性，它能在主模型调用失败时自动切换到备用模型，确保服务的连续性和稳定性。以下是全面的功能解析：</p>
<p>根据之前提供的 Router 参数，我们知道有几种类型的回退配置：</p>
<ol>
<li>
<p><code>default_fallbacks</code>: 通用回退列表，适用于所有模型，触发条件：任何模型调用失败时</p>
</li>
<li>
<p><code>fallbacks</code>: 指定特定模型组的回退链，精细化控制回退路径</p>
</li>
<li>
<p><code>context_window_fallbacks</code>: 当输入超出模型上下文窗口时的回退，触发条件：收到错误<code>ContextWindowExceededError</code>，典型场景：处理长文档摘要、代码分析</p>
</li>
<li>
<p><code>content_policy_fallbacks</code>: 当内容违反模型使用策略时的回退，触发条件： 收到错误<code>PolicyViolationError</code>，应用场景：医疗/金融等敏感领域</p>
</li>
</ol>
<p>此外，在故障处理方面，还有 <code>max_fallbacks</code> 参数控制最大回退尝试次数。</p>
<p><strong>回退顺序：主模型失败 → 定向回退（fallbacks） → 通用回退（default_fallbacks） → 最终兜底</strong></p>
<p><strong>回退策略执行顺序流程图</strong>
<pre class="mermaid"><code>graph TD
    A[主模型调用] --&gt; B{失败原因?}
    B --&gt;|常规错误| C[触发fallbacks定向回退]
    B --&gt;|上下文超限，抛出异常ContextWindowExceededError| D[触发context_window_fallbacks]
    B --&gt;|策略违规，抛出异常PolicyViolationError| E[触发content_policy_fallbacks]
    C --&gt; F{是否用尽fallbacks?}
    D --&gt; G{是否用尽context回退?}
    E --&gt; H{是否用尽policy回退?}
    F --&gt;|是| I[触发default_fallbacks]
    G --&gt;|是| I
    H --&gt;|是| I
    I --&gt; J{是否用尽default回退?}
    J --&gt;|是| K[抛出最终错误]</code></pre></p>
<p><strong>Fallbacks 工作流程</strong>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Router
    participant ModelA
    participant ModelB
    participant ModelC

    Client-&gt;&gt;Router: 请求(gpt-4-turbo)
    Router-&gt;&gt;ModelA: 调用主模型
    ModelA--&gt;&gt;Router: 失败(超时)
    Router-&gt;&gt;ModelB: 回退(claude-3-opus)
    ModelB--&gt;&gt;Router: 失败(策略违规)
    Router-&gt;&gt;ModelC: 回退(deepseek-chat)
    ModelC--&gt;&gt;Router: 成功响应
    Router--&gt;&gt;Client: 返回结果</code></pre></p>
<h3 id="_54">完整工作流示例</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIError</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="c1"># 定义模型池</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="p">{</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;deepseek-chat&quot;</span><span class="p">,</span>  <span class="c1"># 模型别名-&gt;具有相同&#39;model_name&#39;的模型之间的负载平衡</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># litellm completion/embedding 实际调用参数</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/deepseek-chat&quot;</span><span class="p">,</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com/v1&quot;</span><span class="p">,</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>            <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">),</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>        <span class="p">},</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}</span>  
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>    <span class="p">},</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>    <span class="p">{</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/qwen-turbo&quot;</span><span class="p">,</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>            <span class="c1"># &quot;api_key&quot;: os.getenv(&quot;BAILIAN_API_KEY&quot;),</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>        <span class="p">},</span>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a>        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">}</span>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a>    <span class="p">},</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="p">]</span>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="c1"># 创建路由</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a>    <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a>    <span class="n">routing_strategy</span><span class="o">=</span><span class="s2">&quot;simple-shuffle&quot;</span><span class="p">,</span>  
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a>    <span class="n">set_verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a>
</span><span id="__span-29-33"><a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a>    <span class="c1"># 回退策略</span>
</span><span id="__span-29-34"><a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a>    <span class="n">default_fallbacks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;deepseek-chat&quot;</span><span class="p">],</span>
</span><span id="__span-29-35"><a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a>    <span class="n">fallbacks</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">:</span> <span class="s2">&quot;claude-3-opus&quot;</span><span class="p">}],</span>
</span><span id="__span-29-36"><a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a>    <span class="n">context_window_fallbacks</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">:</span> <span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}],</span>
</span><span id="__span-29-37"><a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a>    <span class="n">content_policy_fallbacks</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">:</span> <span class="s2">&quot;deepseek-chat&quot;</span><span class="p">}],</span>
</span><span id="__span-29-38"><a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a>
</span><span id="__span-29-39"><a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a>    <span class="c1"># 重试配置</span>
</span><span id="__span-29-40"><a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a>    <span class="n">num_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 失败重试 3 次</span>
</span><span id="__span-29-41"><a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a>    <span class="n">retry_after</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 重试失败的请求之前等待 5 秒</span>
</span><span id="__span-29-42"><a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a>    <span class="c1"># cache_responses=True  # 在生产中，我们建议使用Redis缓存。为了在本地快速测试，我们还支持简单的内存缓存。</span>
</span><span id="__span-29-43"><a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a><span class="p">)</span>
</span><span id="__span-29-44"><a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a>
</span><span id="__span-29-45"><a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;你是谁&quot;</span><span class="p">}]</span>
</span><span id="__span-29-46"><a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a>
</span><span id="__span-29-47"><a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-29-48"><a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a>    <span class="c1"># 使用路由</span>
</span><span id="__span-29-49"><a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
</span><span id="__span-29-50"><a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a>        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;qwen-turbo&quot;</span><span class="p">,</span> 
</span><span id="__span-29-51"><a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a>        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
</span><span id="__span-29-52"><a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a>    <span class="p">)</span>
</span><span id="__span-29-53"><a id="__codelineno-29-53" name="__codelineno-29-53" href="#__codelineno-29-53"></a>
</span><span id="__span-29-54"><a id="__codelineno-29-54" name="__codelineno-29-54" href="#__codelineno-29-54"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-29-55"><a id="__codelineno-29-55" name="__codelineno-29-55" href="#__codelineno-29-55"></a><span class="k">except</span> <span class="n">OpenAIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-29-56"><a id="__codelineno-29-56" name="__codelineno-29-56" href="#__codelineno-29-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>15:20:23 - LiteLLM Router:INFO: router.py:660 - Routing strategy: simple-shuffle
15:20:23 - LiteLLM Router:INFO: router.py:911 - litellm.completion(model=openai/qwen-turbo)[31m Exception litellm.AuthenticationError: AuthenticationError: OpenAIException - The api_key client option must be set either by passing api_key to the client or by setting the OPENAI_API_KEY environment variable
15:20:23 - LiteLLM Router:INFO: router.py:3379 - Trying to fallback b/w models
15:20:23 - LiteLLM Router:INFO: fallback_event_handlers.py:128 - Falling back to model_group = c
15:20:23 - LiteLLM Router:INFO: router.py:911 - litellm.completion(model=None)[31m Exception litellm.BadRequestError: You passed in model=c. There is no &#39;model_name&#39; with this string 
15:20:23 - LiteLLM Router:INFO: router.py:3379 - Trying to fallback b/w models
15:20:23 - LiteLLM Router:INFO: fallback_event_handlers.py:128 - Falling back to model_group = deepseek-chat
15:20:31 - LiteLLM Router:INFO: router.py:893 - litellm.completion(model=openai/deepseek-chat)[32m 200 OK
15:20:31 - LiteLLM Router:INFO: fallback_event_handlers.py:142 - Successful fallback b/w models.
15:20:31 - LiteLLM Router:INFO: fallback_event_handlers.py:142 - Successful fallback b/w models.


ModelResponse(id=&#39;f2e51863-6047-49fe-a562-db168ded247e&#39;, created=1749194424, model=&#39;deepseek-chat&#39;, object=&#39;chat.completion&#39;, system_fingerprint=&#39;fp_8802369eaa_prod0425fp8&#39;, choices=[Choices(finish_reason=&#39;stop&#39;, index=0, message=Message(content=&#39;我是DeepSeek Chat，由深度求索公司开发的智能AI助手！✨ 我的使命是帮助你解答问题、提供信息、陪你聊天，还能帮你处理各种文本、文件内容。无论是学习、工作，还是日常生活中的小困惑，都可以来找我聊聊！😊  \n\n有什么我可以帮你的吗？&#39;, role=&#39;assistant&#39;, tool_calls=None, function_call=None, provider_specific_fields={&#39;refusal&#39;: None}))], usage=Usage(completion_tokens=65, prompt_tokens=4, total_tokens=69, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=4), service_tier=None)
</code></pre></div>
<h2 id="jupyter-notebook-markdown">将 jupyter notebook 转换为 markdown 格式</h2>
<p>安装nbconverter: <code>pip install nbconvert</code></p>
<p>执行命令：<code>jupyter nbconvert --to FORMAT notebook.ipynb</code></p>
<p>这里FORMAT 用具体的格式替换，如 markdown, html等</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="err">!</span><span class="n">jupyter</span> <span class="n">nbconvert</span> <span class="o">--</span><span class="n">to</span> <span class="n">markdown</span> <span class="n">litellm_use</span><span class="o">.</span><span class="n">ipynb</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[NbConvertApp] Converting notebook litellm_use.ipynb to markdown
[NbConvertApp] Writing 103765 bytes to litellm_use.md
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.select"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>