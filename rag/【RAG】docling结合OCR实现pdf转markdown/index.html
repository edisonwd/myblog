
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../%E3%80%90RAG%E3%80%91chunk%E5%88%86%E5%9D%97%E7%90%86%E8%AE%BA%E7%AF%87/">
      
      
        <link rel="next" href="../%E3%80%90RAG%E3%80%91%E4%BD%BF%E7%94%A8PyMuPDF4LLM%E8%A7%A3%E6%9E%90PDF%E7%9A%84%E5%9B%BE%E7%89%87%E5%92%8C%E8%A1%A8%E6%A0%BC/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>【RAG】docling结合OCR实现pdf转markdown - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#doclingocrpdfmarkdown" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              【RAG】docling结合OCR实现pdf转markdown
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    首页
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Devops
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Devops
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/apisix%E5%9C%A8k8s%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    apisix在k8s中的实践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/devops%E5%B7%A5%E5%85%B7zadig%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    devops工具zadig实践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/Docker%E6%9E%84%E5%BB%BA%E6%8F%90%E9%80%9F%E8%83%8C%E5%90%8E%E7%9A%84%E7%9C%9F%E7%9B%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker构建提速背后的真相
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/k8s%E4%B8%AD%E7%9A%84nginx-ingress%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E8%B7%AF%E5%BE%84%E9%87%8D%E5%AE%9A%E5%90%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    k8s中的nginx-ingress如何配置路径重定向
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%9C%A8k8s%E4%B8%AD%E5%AE%89%E8%A3%85%E5%B9%B6%E4%BD%BF%E7%94%A8jenkins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    在k8s中安装并使用jenkins
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%9C%A8k8s%E4%B8%AD%E5%AE%89%E8%A3%85%E5%B9%B6%E4%BD%BF%E7%94%A8nexus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    在k8s中安装并使用nexus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98docker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何提高docker容器的安全性
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Go
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Go
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/go%E8%AF%AD%E8%A8%80grpc%E6%A1%86%E6%9E%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    go语言grpc框架从入门到实践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/%E3%80%90golang%E3%80%91%E4%BD%BF%E7%94%A8chan%E6%94%B6%E9%9B%86%E5%A4%9A%E5%8D%8F%E7%A8%8B%E6%89%A7%E8%A1%8C%E7%9A%84%E7%BB%93%E6%9E%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【golang】使用chan收集多协程执行的结果
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/%E3%80%90golang%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E3%80%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【golang学习记录】环境搭建
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Image
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Image
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    收集的学习资料
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    收集的学习资料
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../image/%E6%94%B6%E9%9B%86%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/%E5%9C%A8%E7%BA%BF%E9%98%85%E8%AF%BB%E4%B9%A6%E7%B1%8D%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    在线阅读书籍汇总
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%20%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java 编程思想
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java11%E5%92%8CJava17%E4%B9%8B%E9%97%B4%E6%9C%89%E5%93%AA%E4%BA%9B%E6%96%B0%E5%8F%98%E5%8C%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java11和Java17之间有哪些新变化
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/java%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    java中如何实现线程间通信
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E4%B8%AD%E8%8E%B7%E5%8F%96ThreadDumps%E7%9A%848%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java中获取ThreadDumps的8种方式汇总
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%92%8Cgo%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0LRU%E7%AE%97%E6%B3%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java和go语言实现LRU算法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java异常
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E8%AE%BE%E8%AE%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java异常处理设计
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/maven%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    maven基础知识汇总
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Mockito%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mockito单元测试框架使用指南
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Mockito%E7%9A%84%E5%B8%B8%E8%A7%81%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E5%8F%8A%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mockito的常见核心功能及最佳实践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/springboot%E4%BD%BF%E7%94%A8k8s%E7%9A%84configMap%E4%BD%9C%E4%B8%BA%E5%A4%96%E9%83%A8%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    springboot使用k8s的configMap作为外部配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E4%BD%BF%E7%94%A8maven%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用maven自定义插件实现devops
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7%20Java%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何监控 Java 垃圾回收
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E5%A6%82%E4%BD%95%E8%B0%83%E4%BC%98%20Java%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何调优 Java 垃圾收集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E6%98%AF%E4%BB%80%E4%B9%88%E8%AE%A9Java%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84CPU%E4%BD%BF%E7%94%A8%E7%8E%87%E9%A3%99%E5%8D%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    是什么让Java应用程序的CPU使用率飙升
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3%20Java%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    简单理解 Java 垃圾收集器
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E9%98%85%E8%AF%BB%E9%98%BF%E9%87%8CJava%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    阅读阿里Java开发手册记录
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Other
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Other
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/Python%E8%84%9A%E6%9C%AC%E5%A4%84%E7%90%86Markdown%E5%9B%BE%E7%89%87%E6%9C%AC%E5%9C%B0%E5%8C%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python脚本处理Markdown图片本地化
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E4%BC%98%E7%A7%80%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    优秀博客汇总
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E4%BD%BF%E7%94%A8Awescnb%E6%9E%84%E5%BB%BA%E9%85%B7%E7%82%AB%E7%9A%84%E5%8D%9A%E5%AE%A2%E5%9B%AD%E7%9A%AE%E8%82%A4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用Awescnb构建酷炫的博客园皮肤
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E5%9C%A8markdown%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%A1%A8%E6%83%85%E7%AC%A6%E5%8F%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    在markdown中使用表情符号
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    学习笔记
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/gunicorn%E8%B6%85%E6%97%B6%E6%8A%A5%E9%94%99/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    gunicorn超时报错
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E4%B8%ADThreadPoolExecutor%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    python中ThreadPoolExecutor运行原理解析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%8F%90%E5%8F%96json%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%80%BC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    python使用正则表达式提取json字符串的值
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E5%AE%9E%E7%8E%B0%E6%8E%98%E9%87%91%E5%AE%9A%E6%97%B6%E7%AD%BE%E5%88%B0%E6%8A%BD%E5%A5%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    python实现掘金定时签到抽奖
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/%E4%BD%BF%E7%94%A8python%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用python问题总结
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Rag
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rag
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PDF%E9%A1%B5%E7%9C%89%E9%A1%B5%E8%84%9A%E8%AF%86%E5%88%AB%E4%B8%8E%E5%8E%BB%E9%99%A4%E6%96%B9%E6%A1%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PDF页眉页脚识别与去除方案
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../RAG%E6%8A%80%E6%9C%AF%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E6%8C%91%E6%88%98%E5%88%86%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG技术及其应用挑战分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90langgraph%E3%80%91%E5%9C%A8%E6%9C%AC%E5%9C%B0%E8%BF%90%E8%A1%8CLangSmith%20Studio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【langgraph】在本地运行LangSmith Studio
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91chunk%E5%88%86%E5%9D%97%E5%AE%9E%E8%B7%B5%E7%AF%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【RAG】chunk分块实践篇
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91chunk%E5%88%86%E5%9D%97%E7%90%86%E8%AE%BA%E7%AF%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【RAG】chunk分块理论篇
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    【RAG】docling结合OCR实现pdf转markdown
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    【RAG】docling结合OCR实现pdf转markdown
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        概述
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pdf-markdown" class="md-nav__link">
    <span class="md-ellipsis">
      
        pdf 转 markdown 文件效果演示
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclingocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        docling支持的OCR模型
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclingrapidocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        下载docling模型和RapidOCR模型
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclinglangchain" class="md-nav__link">
    <span class="md-ellipsis">
      
        docling集成langchain
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rapidocrcpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        部署RapidOCR到CPU
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rapidocrgpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        部署RapidOCR到GPU
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="部署RapidOCR到GPU">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        如何选择推理引擎
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu-rapidocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        在 gpu 上面运行 RapidOCR 步骤
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在 gpu 上面运行 RapidOCR 步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paddlepaddlegpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        安装PaddlePaddle框架GPU版
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rapidocr_paddle" class="md-nav__link">
    <span class="md-ellipsis">
      
        安装rapidocr_paddle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        基本使用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oss" class="md-nav__link">
    <span class="md-ellipsis">
      
        保存图片并存储到oss
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docling" class="md-nav__link">
    <span class="md-ellipsis">
      
        修改docling源码
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        完整代码实现
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclingcpugpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        docling在cpu和gpu的效率对比
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        问题记录
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91%E4%BD%BF%E7%94%A8PyMuPDF4LLM%E8%A7%A3%E6%9E%90PDF%E7%9A%84%E5%9B%BE%E7%89%87%E5%92%8C%E8%A1%A8%E6%A0%BC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【RAG】使用PyMuPDF4LLM解析PDF的图片和表格
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91%E6%9E%84%E5%BB%BA%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【RAG】构建向量数据库索引
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91%E5%B0%86pdf%E5%92%8Cdocx%E8%BD%AC%E6%8D%A2%E4%B8%BAmarkdown%E6%A0%BC%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【RAG优化】将pdf和docx转换为markdown格式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%BD%BF%E7%94%A8Nanonets-OCR-s%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0PDF%E6%96%87%E4%BB%B6%E8%BD%ACmarkdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用Nanonets-OCR-s模型实现PDF文件转markdown
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Redis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Redis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/%E4%B8%80%E5%B0%8F%E6%97%B6%E6%8E%8C%E6%8F%A1RediSearch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    一小时掌握RediSearch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Springboot
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Springboot
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20Validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spring Boot 中使用 Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%E4%B8%AD%E4%BD%BF%E7%94%A8MyBatis%20Generator%E7%94%9F%E6%88%90%E5%8A%A8%E6%80%81SQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spring Boot中使用MyBatis Generator生成动态SQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%E9%A1%B9%E7%9B%AE%E8%87%AA%E5%B7%B1%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AA%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spring Boot项目自己封装一个分页查询工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%20%E5%A4%A7%E5%9E%8B%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%8C%85%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%28DDD%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    springboot 大型复杂项目的包结构设计(DDD)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%E4%B8%AD%E4%BD%BF%E7%94%A8MapStruct%E6%95%99%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    springboot中使用MapStruct教程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%E9%A1%B9%E7%9B%AE%E4%B8%AD%20PO%20BO%20VO%20DTO%20POJO%20DAO%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8%EF%BC%88%E9%99%84%E8%BD%AC%E6%8D%A2%E5%9B%BE%EF%BC%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    springboot项目中 PO BO VO DTO POJO DAO概念及其作用（附转换图）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%8D%81%E5%88%86%E9%92%9F%E5%AE%9E%E7%8E%B0springboot%20%2B%20MyBatis%20Dynamic%20SQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    从零开始十分钟实现springboot + MyBatis Dynamic SQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    大模型
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    大模型
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/langchain%E4%BD%BF%E7%94%A8token%E5%88%87%E5%88%86chunk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    langchain使用token切分chunk
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/LLM%E7%BB%9F%E4%B8%80%E7%BD%91%E5%85%B3%EF%BC%9ALiteLLM%20%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM统一网关：LiteLLM 详细介绍
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    大模型工具调用原理和实践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E5%A6%82%E4%BD%95%E8%AE%A9%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何让大模型输出结构化数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    工具
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    工具
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%B7%A5%E5%85%B7/%E4%BD%BF%E7%94%A8uv%E5%AE%9E%E7%8E%B0python%E9%A1%B9%E7%9B%AE%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用uv实现python项目依赖管理实践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%B7%A5%E5%85%B7/%E4%BD%BF%E7%94%A8%E8%BF%87%E7%9A%84%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用过的开源工具
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    爬虫
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    爬虫
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/BeautifulSoup%E7%9A%84%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BeautifulSoup的使用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/selenium%E5%A6%82%E4%BD%95%E6%8B%96%E5%8A%A8%E6%BB%9A%E5%8A%A8%E6%9D%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    selenium如何拖动滚动条
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/%E3%80%90%E7%88%AC%E8%99%AB%E3%80%91docker%E9%83%A8%E7%BD%B2python%2Bselenium%2Bfirefox-headless/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【爬虫】docker部署python+selenium+firefox-headless
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/%E3%80%90%E7%88%AC%E8%99%AB%E3%80%91python%2Bselenium%2Bfirefox%E4%BD%BF%E7%94%A8%E4%B8%8E%E9%83%A8%E7%BD%B2%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    【爬虫】python+selenium+firefox使用与部署详解
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    算法
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            
  
    算法
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%AE%97%E6%B3%95/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E5%9B%BE%E6%96%87%E8%AE%B2%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    归并排序图文讲解
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        概述
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pdf-markdown" class="md-nav__link">
    <span class="md-ellipsis">
      
        pdf 转 markdown 文件效果演示
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclingocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        docling支持的OCR模型
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclingrapidocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        下载docling模型和RapidOCR模型
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclinglangchain" class="md-nav__link">
    <span class="md-ellipsis">
      
        docling集成langchain
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rapidocrcpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        部署RapidOCR到CPU
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rapidocrgpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        部署RapidOCR到GPU
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="部署RapidOCR到GPU">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        如何选择推理引擎
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu-rapidocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        在 gpu 上面运行 RapidOCR 步骤
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在 gpu 上面运行 RapidOCR 步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paddlepaddlegpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        安装PaddlePaddle框架GPU版
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rapidocr_paddle" class="md-nav__link">
    <span class="md-ellipsis">
      
        安装rapidocr_paddle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        基本使用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oss" class="md-nav__link">
    <span class="md-ellipsis">
      
        保存图片并存储到oss
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docling" class="md-nav__link">
    <span class="md-ellipsis">
      
        修改docling源码
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        完整代码实现
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#doclingcpugpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        docling在cpu和gpu的效率对比
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        问题记录
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="doclingocrpdfmarkdown">docling结合OCR实现pdf转markdown</h1>
<h2 id="_1">概述</h2>
<p>前面写了一篇文章 <strong>将pdf和docx转换为markdown格式</strong> 介绍了使用一些开源工具转换pdf为markdown的效果对比，得出的结论是： 使用 docling 转换 pdf 为 markdown 格式的效果最好，并且docling使用的是 MIT licence。</p>
<p>在直接使用docling模型转换pdf文件为markdown格式时，如果pdf文件中有很多图片，或者pdf中的内容被模型直接识别为了图片，这种情况如何使用 docling 将 pdf 中图片中的内容提取出来呢？这就需要使用docling结合OCR实现pdf转markdown，本文主要介绍一下docling结合OCR的详细使用方法。</p>
<p>本文是在阅读了 docling 的官方文档和源码，以及 RapidOCR 的官方文档，并且经过大量测试和实践进行总结，在实践过程中踩了一些坑，比如：</p>
<ul>
<li>如何下载ocr模型</li>
<li>如何与langchain结合</li>
<li>如何实现 docling + ocr 在gpu上面运行</li>
<li>如何保存图片并存储到oss</li>
</ul>
<blockquote>
<p>如果有兴趣可以先查看下面的文档</p>
<p>docling 官方文档：<a href="https://docling-project.github.io/docling/examples/rapidocr_with_custom_models/">https://docling-project.github.io/docling/examples/rapidocr_with_custom_models/</a></p>
<p>RapidOCR 官方文档：<a href="https://rapidai.github.io/RapidOCRDocs/install_usage/rapidocr_paddle/usage/">https://rapidai.github.io/RapidOCRDocs/install_usage/rapidocr_paddle/usage/</a>
</p>
</blockquote>
<p>记录本文的目的是帮助有同样需求的小伙伴少走弯路，避免踩坑，如果你觉得本文内容对你有帮助，欢迎点赞收藏😀，如果发现有疏漏或者错误的地方，也欢迎评论🤝。</p>
<p>通过本文的学习你将部署一个生产可用的高效的pdf转markdown的服务，特别是在RAG应用中非常有用，后续我将写一篇文章介绍如何将markdown文件切分为有层级结构的chunk（按照标题和段落切分），帮助在RAG应用提高问答的准确率，请持续关注。</p>
<h2 id="pdf-markdown">pdf 转 markdown 文件效果演示</h2>
<p>在 arxv 上面找一个pdf文件，然后使用docling 集成 ocr 转换为 markdown 文件格式示例如下：</p>
<table>
<thead>
<tr>
<th><a href="https://arxiv.org/pdf/2505.02171">原pdf</a></th>
<th>转换后的markdown，并保存图片到oss，可以直接预览图片</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/5faa88f1.png" /></td>
<td><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/d523efde.png" /></td>
</tr>
</tbody>
</table>
<h2 id="doclingocr">docling支持的OCR模型</h2>
<p>首先查看<a href="https://github.com/docling-project/docling/blob/main/docling/models/plugins/defaults.py">docling源码支持哪些ocr模型</a>，如下所示：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.models.easyocr_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">EasyOcrModel</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.models.ocr_mac_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">OcrMacModel</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.models.picture_description_api_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">PictureDescriptionApiModel</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.models.picture_description_vlm_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">PictureDescriptionVlmModel</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.models.rapid_ocr_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RapidOcrModel</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.models.tesseract_ocr_cli_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">TesseractOcrCliModel</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.models.tesseract_ocr_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">TesseractOcrModel</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">ocr_engines</span><span class="p">():</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="s2">&quot;ocr_engines&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="n">EasyOcrModel</span><span class="p">,</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="n">OcrMacModel</span><span class="p">,</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="n">RapidOcrModel</span><span class="p">,</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="n">TesseractOcrModel</span><span class="p">,</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="n">TesseractOcrCliModel</span><span class="p">,</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="p">]</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="p">}</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">picture_description</span><span class="p">():</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="s2">&quot;picture_description&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">PictureDescriptionVlmModel</span><span class="p">,</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="n">PictureDescriptionApiModel</span><span class="p">,</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="p">]</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="p">}</span>
</span></code></pre></div>
<p>可以看到 docling 默认支持 5 种 ocr 模型，使用模型总结一下它们的区别，详细的区别请查阅相关文档。</p>
<p>以下是列出的五种 OCR 引擎模型的区别、优缺点及对应的技术背景分析：</p>
<table>
<thead>
<tr>
<th>引擎</th>
<th>速度</th>
<th>精度</th>
<th>资源占用</th>
<th>多语言</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>EasyOCR</td>
<td>中</td>
<td>高</td>
<td>高</td>
<td>80+</td>
<td>自然场景、多语言混合</td>
</tr>
<tr>
<td>macOS OCR</td>
<td>快</td>
<td>中</td>
<td>低</td>
<td>10+</td>
<td>macOS 生态、实时性要求高</td>
</tr>
<tr>
<td>RapidOCR</td>
<td>极快</td>
<td>中高</td>
<td>低</td>
<td>20+</td>
<td>实时处理、低配硬件</td>
</tr>
<tr>
<td>Tesseract</td>
<td>慢</td>
<td>中</td>
<td>中</td>
<td>100+</td>
<td>扫描文档、结构化文本</td>
</tr>
<tr>
<td>Tesseract CLI</td>
<td>慢</td>
<td>中</td>
<td>中</td>
<td>100+</td>
<td>批量处理、自动化脚本</td>
</tr>
</tbody>
</table>
<p>这里选择 RapidOCR 模型和 docling 进行集成，关于 <a href="https://rapidai.github.io/RapidOCRDocs/main/">RapidOCR 的介绍</a>如下：</p>
<p><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/a931f62d.png" /></p>
<h2 id="doclingrapidocr">下载docling模型和RapidOCR模型</h2>
<p>在国内直接从 <a href="https://www.modelscope.cn/models">modelscope</a> 下载<a href="https://www.modelscope.cn/models/ds4sd/docling-models/files">docling模型</a>和RapidOCR模型即可。</p>
<ol>
<li>在下载前，请先通过如下命令安装ModelScope</li>
</ol>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>pip<span class="w"> </span>install<span class="w"> </span>modelscope
</span></code></pre></div>
<ol>
<li>下载模型到指定目录</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">modelscope</span><span class="w"> </span><span class="kn">import</span> <span class="n">snapshot_download</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1"># docling 模型下载，local_dir指定模型路径</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">docling_model_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">model_id</span><span class="o">=</span><span class="s1">&#39;ds4sd/docling-models&#39;</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">local_dir</span><span class="o">=</span><span class="s1">&#39;./docling_model&#39;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;下载docling模型路径: </span><span class="si">{</span><span class="n">docling_model_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1"># rapidocr 模型下载，local_dir指定模型路径</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">rapidocr_model_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">model_id</span><span class="o">=</span><span class="s1">&#39;RapidAI/RapidOCR&#39;</span><span class="p">,</span> 
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">local_dir</span><span class="o">=</span><span class="s1">&#39;./rapidocr_model&#39;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="p">)</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;下载ocr模型路径: </span><span class="si">{</span><span class="n">rapidocr_model_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="doclinglangchain">docling集成langchain</h2>
<p>在 github 上面有一个开源库<a href="https://github.com/docling-project/docling-langchain">docling-langchain</a> 已经将 docling 和 langchain 进行了集成，有兴趣可以查看<a href="https://python.langchain.com/docs/integrations/document_loaders/docling/">langchain中的文档</a>。因为后面会将 pdf 中的图片保存到 oss 中，这些自定义的功能在这个开源库中不方便实现，所以这里我将通过自定义一个类 <code>Pdf2MarkdownLoader</code> 继承 <code>langchain</code> 的 <code>BasePDFLoader</code>，并重新实现<code>load()</code>方法来实现相关的功能，实现代码如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pdf2MarkdownLoader</span><span class="p">(</span><span class="n">BasePDFLoader</span><span class="p">):</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>            <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>            <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;/Users/xiniao/大模型/RAG_Techniques/docling-models&#39;</span><span class="p">,</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>            <span class="n">do_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>            <span class="n">generate_picture_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>            <span class="n">images_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>            <span class="n">do_image_upload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>            <span class="n">bucket</span><span class="p">:</span> <span class="n">oss2</span><span class="o">.</span><span class="n">Bucket</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>            <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>            <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;markdown_files&#39;</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with a file path.&quot;&quot;&quot;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">docling.document_converter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentConverter</span>  <span class="c1"># noqa:F401</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>                <span class="s2">&quot;`docling` package not found, please install it with &quot;</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>                <span class="s2">&quot;`pip install docling`&quot;</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>            <span class="p">)</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">do_ocr</span> <span class="o">=</span> <span class="n">do_ocr</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_picture_images</span> <span class="o">=</span> <span class="n">generate_picture_images</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">images_scale</span> <span class="o">=</span> <span class="n">images_scale</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">do_image_upload</span> <span class="o">=</span> <span class="n">do_image_upload</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>        <span class="c1"># todo 在后续的介绍中实现</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>        <span class="k">pass</span>
</span></code></pre></div>
<h2 id="rapidocrcpu">部署RapidOCR到CPU</h2>
<p>参考docling的文档，docling 集成 rapidocr 在 cpu 运行的代码如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.datamodel.pipeline_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfPipelineOptions</span><span class="p">,</span> <span class="n">RapidOcrOptions</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">docling.document_converter</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="n">ConversionResult</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">DocumentConverter</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">InputFormat</span><span class="p">,</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">PdfFormatOption</span><span class="p">,</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="p">)</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="c1"># Source document to convert</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;https://arxiv.org/pdf/2408.09869v4&quot;</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="c1"># Setup RapidOcrOptions for english detection</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">det_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="n">rapidocr_model_dir</span><span class="p">,</span> <span class="s2">&quot;PP-OCRv4&quot;</span><span class="p">,</span> <span class="s2">&quot;en_PP-OCRv3_det_infer.onnx&quot;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="p">)</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">rec_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="n">rapidocr_model_dir</span><span class="p">,</span> <span class="s2">&quot;PP-OCRv4&quot;</span><span class="p">,</span> <span class="s2">&quot;ch_PP-OCRv4_rec_server_infer.onnx&quot;</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="p">)</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="n">cls_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="n">rapidocr_model_dir</span><span class="p">,</span> <span class="s2">&quot;PP-OCRv3&quot;</span><span class="p">,</span> <span class="s2">&quot;ch_ppocr_mobile_v2.0_cls_train.onnx&quot;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="p">)</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="n">ocr_options</span> <span class="o">=</span> <span class="n">RapidOcrOptions</span><span class="p">(</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="n">det_model_path</span><span class="o">=</span><span class="n">det_model_path</span><span class="p">,</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="n">rec_model_path</span><span class="o">=</span><span class="n">rec_model_path</span><span class="p">,</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="n">cls_model_path</span><span class="o">=</span><span class="n">cls_model_path</span><span class="p">,</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="p">)</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>    <span class="n">pipeline_options</span> <span class="o">=</span> <span class="n">PdfPipelineOptions</span><span class="p">(</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="n">ocr_options</span><span class="o">=</span><span class="n">ocr_options</span><span class="p">,</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>    <span class="p">)</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>    <span class="c1"># Convert the document</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>    <span class="n">converter</span> <span class="o">=</span> <span class="n">DocumentConverter</span><span class="p">(</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="n">format_options</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>            <span class="n">InputFormat</span><span class="o">.</span><span class="n">PDF</span><span class="p">:</span> <span class="n">PdfFormatOption</span><span class="p">(</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>                <span class="n">pipeline_options</span><span class="o">=</span><span class="n">pipeline_options</span><span class="p">,</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="p">),</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="p">},</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>    <span class="p">)</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="n">conversion_result</span><span class="p">:</span> <span class="n">ConversionResult</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>    <span class="n">doc</span> <span class="o">=</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">document</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>    <span class="n">md</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">export_to_markdown</span><span class="p">()</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="rapidocrgpu">部署RapidOCR到GPU</h2>
<h3 id="_2">如何选择推理引擎</h3>
<p>参考 <a href="https://rapidai.github.io/RapidOCRDocs/v1.4.4/blog/2022/10/04/which-inference/">RapidOCR推理引擎选择指南</a>，将RapidOCR部署到GPU推荐使用：<code>rapidocr_paddle</code>。</p>
<p><strong>推荐理由：</strong></p>
<p>PaddleOCR模型本身就是由PaddlePaddle框架训练而来的，PaddlePaddle框架原生支持在CPU和GPU上推理PaddleOCR相关模型。</p>
<p>rapidocr_paddle包是基于PaddlePaddle框架作为推理引擎的，支持CPU和GPU上推理，推荐GPU端使用。</p>
<p>原因是ONNXRuntime和OpenVINO在GPU上支持较差：</p>
<ul>
<li>onnxruntime-gpu：在动态输入情况下，推理速度要比CPU慢很多，而OCR任务就是动态输入，因此不推荐使用onnxruntime-gpu版推理。</li>
<li>rapidocr_openvino: 出自英特尔，只适配自家GPU。</li>
</ul>
<p>CPU端还是以rapidocr_onnxruntime和rapidocr_openvino为主。毕竟PaddlePaddle的CPU端还是比较重的。</p>
<p>值得说明的是，这个包和PaddleOCR相比，代码基本都是一样的，只不过这个库将里面核心推理代码抽了出来，更加精简而已。</p>
<h3 id="gpu-rapidocr">在 gpu 上面运行 RapidOCR 步骤</h3>
<h4 id="paddlepaddlegpu">安装PaddlePaddle框架GPU版</h4>
<p>安装PaddlePaddle框架GPU版，并验证可行性，详细参见: <a href="https://www.paddlepaddle.org.cn/install/quick?docurl=/documentation/docs/zh/install/pip/linux-pip.html">官方教程</a>。这里打算将rapidocr部署到 linux 系统中，使用英伟达的 GPU 版本为 12.1。</p>
<blockquote>
<p>直接查看 CUDA 工具包版本的命令为：<code>**nvcc --version**</code></p>
<p><strong>快速查看 CUDA 版本（依赖驱动）的命令为：</strong><code>**nvidia-smi**</code>
</p>
</blockquote>
<p>选择如下图所示：</p>
<p><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/6c02b5a7.png" /></p>
<p>使用 pip 安装 <code>paddlepaddle-gpu</code>的命令如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>paddlepaddle-gpu<span class="o">==</span><span class="m">3</span>.0.0<span class="w"> </span>-i<span class="w"> </span>https://www.paddlepaddle.org.cn/packages/stable/cu126/
</span></code></pre></div>
<p>直接运行前面的命令会报错，报错信息如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w"> </span>~<span class="w"> </span>%<span class="w">  </span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>paddlepaddle-gpu<span class="o">==</span><span class="m">3</span>.0.0<span class="w"> </span>-i<span class="w"> </span>https://www.paddlepaddle.org.cn/packages/stable/cu126/
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Looking<span class="w"> </span><span class="k">in</span><span class="w"> </span>indexes:<span class="w"> </span>https://www.paddlepaddle.org.cn/packages/stable/cu126/
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>ERROR:<span class="w"> </span>Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>a<span class="w"> </span>version<span class="w"> </span>that<span class="w"> </span>satisfies<span class="w"> </span>the<span class="w"> </span>requirement<span class="w"> </span>paddlepaddle-gpu<span class="o">==</span><span class="m">3</span>.0.0<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>versions:<span class="w"> </span>none<span class="o">)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="o">[</span>notice<span class="o">]</span><span class="w"> </span>A<span class="w"> </span>new<span class="w"> </span>release<span class="w"> </span>of<span class="w"> </span>pip<span class="w"> </span>is<span class="w"> </span>available:<span class="w"> </span><span class="m">24</span>.3.1<span class="w"> </span>-&gt;<span class="w"> </span><span class="m">25</span>.1.1
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="o">[</span>notice<span class="o">]</span><span class="w"> </span>To<span class="w"> </span>update,<span class="w"> </span>run:<span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>ERROR:<span class="w"> </span>No<span class="w"> </span>matching<span class="w"> </span>distribution<span class="w"> </span>found<span class="w"> </span><span class="k">for</span><span class="w"> </span>paddlepaddle-gpu<span class="o">==</span><span class="m">3</span>.0.0
</span></code></pre></div>
<p>从报错信息可以发现，在仓库 <code>[https://www.paddlepaddle.org.cn/packages/stable/cu126/](https://www.paddlepaddle.org.cn/packages/stable/cu126/)</code>中找不到 <code>paddlepaddle-gpu==3.0.0</code>，接下来将介绍一下我是如何一步步解决这个问题的。</p>
<ol>
<li>首先 <a href="https://pypi.org/project/paddlepaddle-gpu/">pypi 仓库</a>中搜索 <code>paddlepaddle-gpu</code>对应的包信息，发现最新的只有<code>paddlepaddle-gpu 2.6.2</code>，它不支持 cuda 12.1。</li>
<li>然后进入仓库 <code>[https://www.paddlepaddle.org.cn/packages/stable/cu126/](https://www.paddlepaddle.org.cn/packages/stable/cu126/)</code>，找到<code>paddlepaddle-gpu</code>，如下图所示：</li>
</ol>
<p><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/ae656f4e.png" /></p>
<ol>
<li>最后进入 <code>paddlepaddle-gpu</code>目录，因为这里使用的使用 python3.10，使用的是 linux系统，所以下载的python包如下图所示，你可以根据你的系统和python版本下载对应的 python 包：</li>
</ol>
<p><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/89dbf8fa.png" /></p>
<ol>
<li>下载完成后，将对应的包传入到服务器中，然后使用下面的命令安装 <code>paddlepaddle-gpu</code>包：</li>
</ol>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>pip<span class="w"> </span>install<span class="w"> </span>paddlepaddle_gpu-3.0.0-cp310-cp310-linux_x86_64.whl
</span></code></pre></div>
<ol>
<li>安装 <code>paddlepaddle-gpu</code>包完成后，可以使用下面的代码来验证是否安装成功：</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">paddle</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">paddle</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">run_check</span><span class="p">())</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="c1"># 如果出现PaddlePaddle is installed successfully!，说明您已成功安装。</span>
</span></code></pre></div>
<p>这里在notebook中的运行结果如下图所示，说明<code>paddlepaddle-gpu</code>包已经安装成功：</p>
<p><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/db3bacd6.png" /></p>
<h4 id="rapidocr_paddle">安装rapidocr_paddle</h4>
<p>安装<code>paddlepaddle-gpu</code>包成功后，需要使用下面的命令安装 <code>rapidocr_paddle</code>包：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>pip<span class="w"> </span>install<span class="w"> </span>rapidocr_paddle
</span></code></pre></div>
<h4 id="_3">基本使用</h4>
<p>安装<code>paddlepaddle-gpu</code>包和 <code>rapidocr_paddle</code>包都成功后，可以使用下面的代码来验证 rapidocr 模型是否能正常运行：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rapidocr_paddle</span><span class="w"> </span><span class="kn">import</span> <span class="n">RapidOCR</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="c1"># 注意这里的参数</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">RapidOCR</span><span class="p">(</span><span class="n">det_use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cls_use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rec_use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="n">image_path</span> <span class="o">=</span> <span class="s2">&quot;tests/test_files/ch_en_num.jpg&quot;</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="n">result</span><span class="p">,</span> <span class="n">elapse_list</span> <span class="o">=</span> <span class="n">engine</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
</span></code></pre></div>
<p>在运行过程中可以使用下面的命令查看 gpu 的使用情况，实时监控 GPU 使用率命令（每 2 秒刷新一次）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>nvidia-smi<span class="w"> </span>-l<span class="w"> </span><span class="m">2</span>
</span></code></pre></div>
<p>运行的结果如下图所示，这里的gpu使用率达到了 72%：</p>
<p><img alt="" src="../../image/%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/80299da6.png" /></p>
<h2 id="oss">保存图片并存储到oss</h2>
<p>接下来介绍一下如何将pdf转markdown过程中，模型识别出的图片保存下来，并自动上传到oss中，以便在markdown文件中预览图片。</p>
<p>将pdf转markdown过程中，保存模型识别出的图片有两个步骤：</p>
<ol>
<li>查阅 <a href="https://docling-project.github.io/docling/examples/export_figures/">docling 的官方文档</a>，发现可以在创建 <code>PdfPipelineOptions</code>时，通过设置参数 <code>generate_picture_images = True</code>来控制是否生成图片。</li>
</ol>
<p>代码示例如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">pipeline_options</span> <span class="o">=</span> <span class="n">PdfPipelineOptions</span><span class="p">(</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>            <span class="n">artifacts_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="c1"># docling模型的路径</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>            <span class="n">do_ocr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_ocr</span><span class="p">,</span>  <span class="c1"># 控制是否进行 ocr 识别</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>            <span class="n">ocr_options</span><span class="o">=</span><span class="n">ocr_options</span><span class="p">,</span>  <span class="c1"># ocr 模型相关的配置</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>            <span class="c1"># do_picture_description=True,</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>            <span class="n">generate_picture_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_picture_images</span><span class="p">,</span> <span class="c1"># 控制是否生成图片</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>            <span class="n">images_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">images_scale</span><span class="err">。</span><span class="c1"># 保存图片的像素比例 scale * 72</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="p">)</span>
</span></code></pre></div>
<ol>
<li>在使用<code>document.save_as_markdown()</code>方法保存markdown文件内容的时候需要指定参数 <code>image_mode=ImageRefMode.REFERENCED</code>，在 <code>ImageRefMode</code>中有三种保存图片的模式：</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImageRefMode</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ImageRefMode.&quot;&quot;&quot;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="n">PLACEHOLDER</span> <span class="o">=</span> <span class="s2">&quot;placeholder&quot;</span>  <span class="c1"># just a place-holder</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="n">EMBEDDED</span> <span class="o">=</span> <span class="s2">&quot;embedded&quot;</span>  <span class="c1"># embed the image as a base64</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="n">REFERENCED</span> <span class="o">=</span> <span class="s2">&quot;referenced&quot;</span>  <span class="c1"># reference the image via uri</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th><strong>模式</strong></th>
<th><strong>描述</strong></th>
<th><strong>典型场景</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PLACEHOLDER</code></td>
<td>仅保留图像的占位符，不实际存储或引用图像数据。</td>
<td>图像尚未加载、临时标记、或仅需要位置标记的场景。</td>
</tr>
<tr>
<td><code>EMBEDDED</code></td>
<td>将图像数据直接嵌入到当前载体中（如通过 Base64 编码）。</td>
<td>需要将图像与文档/数据包绑定（如 PDF、JSON 配置）。</td>
</tr>
<tr>
<td><code>REFERENCED</code></td>
<td>通过 URI（如 URL、文件路径）引用外部图像资源。</td>
<td>图像存储在独立位置（如网络图片、本地文件系统）。</td>
</tr>
</tbody>
</table>
<p>代码示例如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># 没有提供artifacts_dir的时候，函数会根据filename自动生成一个目录路径。</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="c1"># 比如，假设filename是/path/to/file.txt，那么artifacts_dir会被设置为/path/to/file_artifacts。</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1"># 这里的逻辑是去掉原文件的扩展名，然后在后面加上_artifacts作为目录名</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="n">conv_res</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">save_as_markdown</span><span class="p">(</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="n">filename</span><span class="o">=</span><span class="n">md_filename</span><span class="p">,</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="n">image_mode</span><span class="o">=</span><span class="n">ImageRefMode</span><span class="o">.</span><span class="n">REFERENCED</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="p">)</span>
</span></code></pre></div>
<p>使用上面两个步骤，可以将pdf中的图片保存到本地，下面定义一个方法，用于将 markdown 文件中的图片上传到 oss 中，并用 oss 的地址替换原来的图片：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">replace_local_images_with_oss_url</span><span class="p">(</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        <span class="n">bucket</span><span class="p">:</span> <span class="n">oss2</span><span class="o">.</span><span class="n">Bucket</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="n">expires</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kg/document/image/&#39;</span><span class="p">,</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="n">image_folder</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">):</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="sd">    替换Markdown文件中的本地图片路径为OSS URL</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="sd">    @param content: Markdown文件内容</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="sd">    @param bucket: oss2.Bucket对象</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="sd">    @param expires: 预览链接过期时间，单位秒，默认为一年</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="sd">    @param location: OSS文件夹路径</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;bucket is None, 请检查oss2.Bucket对象是否正确初始化, 返回原始内容&#39;</span><span class="p">)</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="k">return</span> <span class="n">content</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="c1"># 匹配Markdown文件中的图片路径</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;!\[(.*?)\]\((.*?)\)&#39;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;匹配到 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s1"> 张图片&#39;</span><span class="p">)</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>    <span class="n">replace_num</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>    <span class="n">new_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>    <span class="c1"># 上传并替换图片</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>    <span class="k">for</span> <span class="n">alt_text</span><span class="p">,</span> <span class="n">image_path</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>        <span class="n">old_image_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;![</span><span class="si">{</span><span class="n">alt_text</span><span class="si">}</span><span class="s2">](</span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>        <span class="c1"># 判断图片文件是否存在</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>        <span class="n">img_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="k">if</span> <span class="n">image_folder</span><span class="p">:</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>            <span class="n">img_path</span> <span class="o">=</span> <span class="n">image_folder</span> <span class="o">/</span> <span class="n">img_path</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">img_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;图片文件不存在: </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>            <span class="k">continue</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">img_path</span><span class="o">.</span><span class="n">stem</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>        <span class="n">suffix</span> <span class="o">=</span> <span class="n">img_path</span><span class="o">.</span><span class="n">suffix</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>        <span class="c1"># 构造OSS文件名，确保不重复</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>        <span class="n">unique_name</span> <span class="o">=</span> <span class="n">generate_uuid</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>        <span class="n">file_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unique_name</span><span class="si">}</span><span class="s2">_image_</span><span class="si">{</span><span class="n">replace_num</span><span class="si">:</span><span class="s2">03</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>        <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>            <span class="n">file_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}{</span><span class="n">file_key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>            <span class="n">file_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">img_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>        <span class="c1"># 上传图片到OSS</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>            <span class="n">preview_url</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">sign_url</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">)</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;图片上传失败: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>            <span class="n">preview_url</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>        <span class="c1"># 替换图片路径</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>        <span class="k">if</span> <span class="n">preview_url</span><span class="p">:</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>            <span class="n">preview_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">preview_url</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;internal&#39;</span><span class="p">,</span> <span class="s1">&#39;office&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>            <span class="c1"># 如果预览地址过期，可以通过new_alt_text，将&quot;_&quot;替换为&quot;/&quot;作为oss的key，重新生成预览地址</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>            <span class="n">new_alt_text</span> <span class="o">=</span> <span class="n">file_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>            <span class="n">new_image_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;![</span><span class="si">{</span><span class="n">new_alt_text</span><span class="si">}</span><span class="s2">](</span><span class="si">{</span><span class="n">preview_url</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>            <span class="n">new_content</span> <span class="o">=</span> <span class="n">new_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old_image_path</span><span class="p">,</span> <span class="n">new_image_path</span><span class="p">)</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>            <span class="n">replace_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replacing </span><span class="si">{</span><span class="n">old_image_path</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">new_image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;替换完成，共替换 </span><span class="si">{</span><span class="n">replace_num</span><span class="si">}</span><span class="s2"> 张图片&quot;</span><span class="p">)</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>    <span class="k">return</span> <span class="n">new_content</span>
</span></code></pre></div>
<h2 id="docling">修改docling源码</h2>
<p>使用 docling 集成 RapidOCR 模型在 GPU 上面运行时，查看docling源码 <a href="https://github.com/docling-project/docling/blob/main/docling/models/rapid_ocr_model.py">https://github.com/docling-project/docling/blob/main/docling/models/rapid_ocr_model.py</a>，<strong>rapid_ocr_model.py</strong> 默认情况下使用的是</p>
<p><code>from rapidocr_onnxruntime import RapidOCR</code>。</p>
<p>如果直接运行的话，会有如下的告警信息：</p>
<blockquote>
<p>github相同issue: <a href="https://github.com/docling-project/docling/issues/1143">https://github.com/docling-project/docling/issues/1143</a>
</p>
</blockquote>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>XGPU-lite:<span class="w"> </span>L-222:vGPU<span class="w"> </span>version:<span class="w"> </span><span class="m">2010</span>,<span class="w"> </span>CUDA<span class="w"> </span>driver<span class="w"> </span>version:<span class="w"> </span><span class="m">12010</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>XGPU-lite:<span class="w"> </span>L-142:vGPUs:VGPU-34d49a72-ff09-9917-96e1-77378cb1f695.2<span class="w"> </span>count:1<span class="w"> </span>pGPUs:GPU-34d49a72-ff09-9917-96e1-77378cb1f695
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>XGPU-lite:<span class="w"> </span>L-73:vgpu<span class="w"> </span>client<span class="w"> </span>init<span class="w"> </span><span class="k">done</span>,<span class="w"> </span>hostID:90c56bdef158<span class="w"> </span>PID:423712<span class="w"> </span>gpuCnt:1<span class="w"> </span>vir-ratio:1<span class="w"> </span>vdev-ratio:1
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>XGPU-lite:<span class="w"> </span>L-86:pGPU<span class="w"> </span>used:GPU-34d49a72-ff09-9917-96e1-77378cb1f695
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>XGPU-lite:<span class="w"> </span>L-98:Job<span class="w"> </span>hostID:90c56bdef158<span class="w"> </span>pid:423712<span class="w"> </span>desc:python3.10<span class="w"> </span>connecting<span class="w"> </span>to<span class="w"> </span>XGPU<span class="w"> </span>service<span class="w"> </span>...
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>XGPU-lite:<span class="w"> </span>L-127:HostID:90c56bdef158<span class="w"> </span>pid:423712<span class="w"> </span>XGPU<span class="w"> </span>connected<span class="w"> </span>jobIdx:0<span class="w"> </span>token:0
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>XGPU-lite:<span class="w"> </span>L-150:Client<span class="w"> </span>configuration:<span class="w"> </span><span class="nv">use_uma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>,<span class="w"> </span>compute_schedule_mode:<span class="w"> </span><span class="m">4</span>,<span class="w"> </span>need_launch_kernel_admission:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>time_slice_spin_or_cv:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>enable_heart_beat:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>enable_monitor:<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>XGPU-lite:<span class="w"> </span>L-235:func:<span class="w"> </span>cuInit,<span class="w"> </span>pid:<span class="w"> </span><span class="m">423712</span>,<span class="w"> </span>tid:<span class="w"> </span><span class="m">423712</span>,<span class="w"> </span>flags:<span class="w"> </span><span class="m">0</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>XGPU-lite:<span class="w"> </span>L-115:The<span class="w"> </span>device<span class="w"> </span>count<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>XGPU-lite:<span class="w"> </span>L-135:The<span class="w"> </span>device<span class="w"> </span>uuid<span class="w"> </span>string<span class="w"> </span>is<span class="w"> </span>34d49a72-ff09-9917-96e1-77378cb1f695.
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>XGPU-lite:<span class="w"> </span>L-142:Find<span class="w"> </span>vGPU<span class="w"> </span>VGPU-34d49a72-ff09-9917-96e1-77378cb1f695.2<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>pGPU<span class="w"> </span>34d49a72-ff09-9917-96e1-77378cb1f695
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,030<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>WARNING:<span class="w"> </span>CUDAExecutionProvider<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span><span class="k">in</span><span class="w"> </span>available<span class="w"> </span>providers<span class="w"> </span><span class="o">([</span><span class="s1">&#39;AzureExecutionProvider&#39;</span>,<span class="w"> </span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="o">])</span>.<span class="w"> </span>Use<span class="w"> </span>AzureExecutionProvider<span class="w"> </span>inference<span class="w"> </span>by<span class="w"> </span>default.
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>INFO:<span class="w"> </span>!!!Recommend<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>rapidocr_paddle<span class="w"> </span><span class="k">for</span><span class="w"> </span>inference<span class="w"> </span>on<span class="w"> </span>GPU.
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>INFO:<span class="w"> </span><span class="o">(</span>For<span class="w"> </span>reference<span class="w"> </span>only<span class="o">)</span><span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>GPU<span class="w"> </span>acceleration,<span class="w"> </span>you<span class="w"> </span>must<span class="w"> </span><span class="k">do</span>:
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>INFO:<span class="w"> </span>First,<span class="w"> </span>uninstall<span class="w"> </span>all<span class="w"> </span>onnxruntime<span class="w"> </span>pakcages<span class="w"> </span><span class="k">in</span><span class="w"> </span>current<span class="w"> </span>environment.
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>INFO:<span class="w"> </span>Second,<span class="w"> </span>install<span class="w"> </span>onnxruntime-gpu<span class="w"> </span>by<span class="w"> </span><span class="sb">`</span>pip<span class="w"> </span>install<span class="w"> </span>onnxruntime-gpu<span class="sb">`</span>.
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>INFO:<span class="w">       </span>Note<span class="w"> </span>the<span class="w"> </span>onnxruntime-gpu<span class="w"> </span>version<span class="w"> </span>must<span class="w"> </span>match<span class="w"> </span>your<span class="w"> </span>cuda<span class="w"> </span>and<span class="w"> </span>cudnn<span class="w"> </span>version.
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>INFO:<span class="w">       </span>You<span class="w"> </span>can<span class="w"> </span>refer<span class="w"> </span>this<span class="w"> </span>link:<span class="w"> </span>https://onnxruntime.ai/docs/execution-providers/CUDA-EP.html
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>INFO:<span class="w"> </span>Third,<span class="w"> </span>ensure<span class="w"> </span>CUDAExecutionProvider<span class="w"> </span>is<span class="w"> </span><span class="k">in</span><span class="w"> </span>available<span class="w"> </span>providers<span class="w"> </span>list.<span class="w"> </span>e.g.<span class="w"> </span><span class="o">[</span><span class="s1">&#39;CUDAExecutionProvider&#39;</span>,<span class="w"> </span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="o">]</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,031<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>WARNING:<span class="w"> </span>DirectML<span class="w"> </span>is<span class="w"> </span>only<span class="w"> </span>supported<span class="w"> </span><span class="k">in</span><span class="w"> </span>Windows<span class="w"> </span>OS.<span class="w"> </span>The<span class="w"> </span>current<span class="w"> </span>OS<span class="w"> </span>is<span class="w"> </span>Linux.<span class="w"> </span>Use<span class="w"> </span>AzureExecutionProvider<span class="w"> </span>inference<span class="w"> </span>by<span class="w"> </span>default.
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="m">2025</span>-05-07<span class="w"> </span><span class="m">19</span>:59:54,080<span class="w"> </span>-<span class="w"> </span>OrtInferSession<span class="w"> </span>-<span class="w"> </span>WARNING:<span class="w"> </span>CUDAExecutionProvider<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span><span class="k">in</span><span class="w"> </span>available<span class="w"> </span>providers<span class="w"> </span><span class="o">([</span><span class="s1">&#39;AzureExecutionProvider&#39;</span>,<span class="w"> </span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="o">])</span>.<span class="w"> </span>Use<span class="w"> </span>AzureExecutionProvider<span class="w"> </span>inference<span class="w"> </span>by<span class="w"> </span>default.
</span></code></pre></div>
<p>从告警信息中可以看到，如果在 GPU 上面运行推荐使用 <code>rapidocr_paddle</code>，为了能够让 docling 使用 <code>rapidocr_paddle</code>运行 ocr 模型，那么需要将 <strong>rapid_ocr_model.py</strong>文件进行如下修改即可：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">原来的</span><span class="p">:</span> <span class="kn">from</span><span class="w"> </span><span class="nn">rapidocr_onnxruntime</span><span class="w"> </span><span class="kn">import</span> <span class="n">RapidOCR</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">替换为</span><span class="p">:</span> <span class="kn">from</span><span class="w"> </span><span class="nn">rapidocr_paddle</span><span class="w"> </span><span class="kn">import</span> <span class="n">RapidOCR</span>
</span></code></pre></div>
<blockquote>
<p>如果不想修改源码，在 docling 中也支持通过插件的方式注册自定义的 OCR 模型，详细可以查看文档：</p>
<p><a href="https://docling-project.github.io/docling/concepts/plugins/">https://docling-project.github.io/docling/concepts/plugins/</a>
</p>
</blockquote>
<h2 id="_4">完整代码实现</h2>
<p>接下来将前面所有的代码进行整合，整合后的代码支持如下功能：</p>
<ul>
<li>目前只支持 RapidOCR </li>
<li>支持和langchain集成</li>
<li>支持在cpu和gpu运行</li>
<li>支持上传图片到 oss</li>
</ul>
<p>完整代码如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">oss2</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.document_loaders.pdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">BasePDFLoader</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># SDK模型下载</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">modelscope</span><span class="w"> </span><span class="kn">import</span> <span class="n">snapshot_download</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="c1"># docling 模型下载，local_dir指定模型路径</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="n">docling_model_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>    <span class="n">model_id</span><span class="o">=</span><span class="s1">&#39;ds4sd/docling-models&#39;</span><span class="p">,</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>    <span class="n">local_dir</span><span class="o">=</span><span class="s1">&#39;./docling_model&#39;</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="p">)</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;下载docling模型路径: </span><span class="si">{</span><span class="n">docling_model_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="c1"># rapidocr 模型下载，local_dir指定模型路径</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="n">rapidocr_model_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>    <span class="n">model_id</span><span class="o">=</span><span class="s1">&#39;RapidAI/RapidOCR&#39;</span><span class="p">,</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>    <span class="n">local_dir</span><span class="o">=</span><span class="s1">&#39;./rapidocr_model&#39;</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="p">)</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;下载ocr模型路径: </span><span class="si">{</span><span class="n">rapidocr_model_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_uuid</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a UUID for a document based on content.&quot;&quot;&quot;</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>    <span class="n">md5_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">md5_hash</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">replace_local_images_with_oss_url</span><span class="p">(</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>        <span class="n">bucket</span><span class="p">:</span> <span class="n">oss2</span><span class="o">.</span><span class="n">Bucket</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>        <span class="n">expires</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>        <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kg/document/image/&#39;</span><span class="p">,</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>        <span class="n">image_folder</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a><span class="p">):</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a><span class="sd">    替换Markdown文件中的本地图片路径为OSS URL</span>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a><span class="sd">    @param content: Markdown文件内容</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a><span class="sd">    @param bucket: oss2.Bucket对象</span>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="sd">    @param expires: 预览链接过期时间，单位秒，默认为一年</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a><span class="sd">    @param location: OSS文件夹路径</span>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;bucket is None, 请检查oss2.Bucket对象是否正确初始化, 返回原始内容&#39;</span><span class="p">)</span>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>        <span class="k">return</span> <span class="n">content</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>
</span><span id="__span-18-55"><a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>    <span class="c1"># 匹配Markdown文件中的图片路径</span>
</span><span id="__span-18-56"><a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;!\[(.*?)\]\((.*?)\)&#39;</span>
</span><span id="__span-18-57"><a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span id="__span-18-58"><a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;匹配到 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s1"> 张图片&#39;</span><span class="p">)</span>
</span><span id="__span-18-59"><a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>    <span class="n">replace_num</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-18-60"><a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>
</span><span id="__span-18-61"><a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a>    <span class="n">new_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="__span-18-62"><a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a>    <span class="c1"># 上传并替换图片</span>
</span><span id="__span-18-63"><a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a>    <span class="k">for</span> <span class="n">alt_text</span><span class="p">,</span> <span class="n">image_path</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="__span-18-64"><a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>        <span class="n">old_image_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;![</span><span class="si">{</span><span class="n">alt_text</span><span class="si">}</span><span class="s2">](</span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="__span-18-65"><a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a>        <span class="c1"># 判断图片文件是否存在</span>
</span><span id="__span-18-66"><a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a>        <span class="n">img_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
</span><span id="__span-18-67"><a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a>        <span class="k">if</span> <span class="n">image_folder</span><span class="p">:</span>
</span><span id="__span-18-68"><a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>            <span class="n">img_path</span> <span class="o">=</span> <span class="n">image_folder</span> <span class="o">/</span> <span class="n">img_path</span>
</span><span id="__span-18-69"><a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">img_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="__span-18-70"><a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;图片文件不存在: </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-71"><a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a>            <span class="k">continue</span>
</span><span id="__span-18-72"><a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">img_path</span><span class="o">.</span><span class="n">stem</span>
</span><span id="__span-18-73"><a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a>        <span class="n">suffix</span> <span class="o">=</span> <span class="n">img_path</span><span class="o">.</span><span class="n">suffix</span>
</span><span id="__span-18-74"><a id="__codelineno-18-74" name="__codelineno-18-74" href="#__codelineno-18-74"></a>        <span class="c1"># 构造OSS文件名，确保不重复</span>
</span><span id="__span-18-75"><a id="__codelineno-18-75" name="__codelineno-18-75" href="#__codelineno-18-75"></a>        <span class="n">unique_name</span> <span class="o">=</span> <span class="n">generate_uuid</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="__span-18-76"><a id="__codelineno-18-76" name="__codelineno-18-76" href="#__codelineno-18-76"></a>        <span class="n">file_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unique_name</span><span class="si">}</span><span class="s2">_image_</span><span class="si">{</span><span class="n">replace_num</span><span class="si">:</span><span class="s2">03</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-18-77"><a id="__codelineno-18-77" name="__codelineno-18-77" href="#__codelineno-18-77"></a>        <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
</span><span id="__span-18-78"><a id="__codelineno-18-78" name="__codelineno-18-78" href="#__codelineno-18-78"></a>            <span class="n">file_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}{</span><span class="n">file_key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-18-79"><a id="__codelineno-18-79" name="__codelineno-18-79" href="#__codelineno-18-79"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-80"><a id="__codelineno-18-80" name="__codelineno-18-80" href="#__codelineno-18-80"></a>            <span class="n">file_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-18-81"><a id="__codelineno-18-81" name="__codelineno-18-81" href="#__codelineno-18-81"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">img_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
</span><span id="__span-18-82"><a id="__codelineno-18-82" name="__codelineno-18-82" href="#__codelineno-18-82"></a>        <span class="c1"># 上传图片到OSS</span>
</span><span id="__span-18-83"><a id="__codelineno-18-83" name="__codelineno-18-83" href="#__codelineno-18-83"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
</span><span id="__span-18-84"><a id="__codelineno-18-84" name="__codelineno-18-84" href="#__codelineno-18-84"></a>        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-18-85"><a id="__codelineno-18-85" name="__codelineno-18-85" href="#__codelineno-18-85"></a>            <span class="n">preview_url</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">sign_url</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">)</span>
</span><span id="__span-18-86"><a id="__codelineno-18-86" name="__codelineno-18-86" href="#__codelineno-18-86"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-87"><a id="__codelineno-18-87" name="__codelineno-18-87" href="#__codelineno-18-87"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;图片上传失败: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-88"><a id="__codelineno-18-88" name="__codelineno-18-88" href="#__codelineno-18-88"></a>            <span class="n">preview_url</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-89"><a id="__codelineno-18-89" name="__codelineno-18-89" href="#__codelineno-18-89"></a>
</span><span id="__span-18-90"><a id="__codelineno-18-90" name="__codelineno-18-90" href="#__codelineno-18-90"></a>        <span class="c1"># 替换图片路径</span>
</span><span id="__span-18-91"><a id="__codelineno-18-91" name="__codelineno-18-91" href="#__codelineno-18-91"></a>        <span class="k">if</span> <span class="n">preview_url</span><span class="p">:</span>
</span><span id="__span-18-92"><a id="__codelineno-18-92" name="__codelineno-18-92" href="#__codelineno-18-92"></a>            <span class="n">preview_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">preview_url</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;internal&#39;</span><span class="p">,</span> <span class="s1">&#39;office&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-18-93"><a id="__codelineno-18-93" name="__codelineno-18-93" href="#__codelineno-18-93"></a>            <span class="c1"># 如果预览地址过期，可以通过new_alt_text，将&quot;_&quot;替换为&quot;/&quot;作为oss的key，重新生成预览地址</span>
</span><span id="__span-18-94"><a id="__codelineno-18-94" name="__codelineno-18-94" href="#__codelineno-18-94"></a>            <span class="n">new_alt_text</span> <span class="o">=</span> <span class="n">file_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="__span-18-95"><a id="__codelineno-18-95" name="__codelineno-18-95" href="#__codelineno-18-95"></a>            <span class="n">new_image_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;![</span><span class="si">{</span><span class="n">new_alt_text</span><span class="si">}</span><span class="s2">](</span><span class="si">{</span><span class="n">preview_url</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="__span-18-96"><a id="__codelineno-18-96" name="__codelineno-18-96" href="#__codelineno-18-96"></a>
</span><span id="__span-18-97"><a id="__codelineno-18-97" name="__codelineno-18-97" href="#__codelineno-18-97"></a>            <span class="n">new_content</span> <span class="o">=</span> <span class="n">new_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old_image_path</span><span class="p">,</span> <span class="n">new_image_path</span><span class="p">)</span>
</span><span id="__span-18-98"><a id="__codelineno-18-98" name="__codelineno-18-98" href="#__codelineno-18-98"></a>            <span class="n">replace_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-18-99"><a id="__codelineno-18-99" name="__codelineno-18-99" href="#__codelineno-18-99"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replacing </span><span class="si">{</span><span class="n">old_image_path</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">new_image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-100"><a id="__codelineno-18-100" name="__codelineno-18-100" href="#__codelineno-18-100"></a>
</span><span id="__span-18-101"><a id="__codelineno-18-101" name="__codelineno-18-101" href="#__codelineno-18-101"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;替换完成，共替换 </span><span class="si">{</span><span class="n">replace_num</span><span class="si">}</span><span class="s2"> 张图片&quot;</span><span class="p">)</span>
</span><span id="__span-18-102"><a id="__codelineno-18-102" name="__codelineno-18-102" href="#__codelineno-18-102"></a>    <span class="k">return</span> <span class="n">new_content</span>
</span><span id="__span-18-103"><a id="__codelineno-18-103" name="__codelineno-18-103" href="#__codelineno-18-103"></a>
</span><span id="__span-18-104"><a id="__codelineno-18-104" name="__codelineno-18-104" href="#__codelineno-18-104"></a>
</span><span id="__span-18-105"><a id="__codelineno-18-105" name="__codelineno-18-105" href="#__codelineno-18-105"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pdf2MarkdownLoader</span><span class="p">(</span><span class="n">BasePDFLoader</span><span class="p">):</span>
</span><span id="__span-18-106"><a id="__codelineno-18-106" name="__codelineno-18-106" href="#__codelineno-18-106"></a>
</span><span id="__span-18-107"><a id="__codelineno-18-107" name="__codelineno-18-107" href="#__codelineno-18-107"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-18-108"><a id="__codelineno-18-108" name="__codelineno-18-108" href="#__codelineno-18-108"></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-18-109"><a id="__codelineno-18-109" name="__codelineno-18-109" href="#__codelineno-18-109"></a>            <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-18-110"><a id="__codelineno-18-110" name="__codelineno-18-110" href="#__codelineno-18-110"></a>            <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">docling_model_dir</span><span class="p">,</span>
</span><span id="__span-18-111"><a id="__codelineno-18-111" name="__codelineno-18-111" href="#__codelineno-18-111"></a>            <span class="n">rapidocr_model_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">rapidocr_model_dir</span><span class="p">,</span>
</span><span id="__span-18-112"><a id="__codelineno-18-112" name="__codelineno-18-112" href="#__codelineno-18-112"></a>            <span class="n">do_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-113"><a id="__codelineno-18-113" name="__codelineno-18-113" href="#__codelineno-18-113"></a>            <span class="n">generate_picture_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-114"><a id="__codelineno-18-114" name="__codelineno-18-114" href="#__codelineno-18-114"></a>            <span class="n">images_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="__span-18-115"><a id="__codelineno-18-115" name="__codelineno-18-115" href="#__codelineno-18-115"></a>            <span class="n">do_image_upload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-18-116"><a id="__codelineno-18-116" name="__codelineno-18-116" href="#__codelineno-18-116"></a>            <span class="n">bucket</span><span class="p">:</span> <span class="n">oss2</span><span class="o">.</span><span class="n">Bucket</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-18-117"><a id="__codelineno-18-117" name="__codelineno-18-117" href="#__codelineno-18-117"></a>            <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>
</span><span id="__span-18-118"><a id="__codelineno-18-118" name="__codelineno-18-118" href="#__codelineno-18-118"></a>            <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;markdown_files&#39;</span>
</span><span id="__span-18-119"><a id="__codelineno-18-119" name="__codelineno-18-119" href="#__codelineno-18-119"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-120"><a id="__codelineno-18-120" name="__codelineno-18-120" href="#__codelineno-18-120"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with a file path.&quot;&quot;&quot;</span>
</span><span id="__span-18-121"><a id="__codelineno-18-121" name="__codelineno-18-121" href="#__codelineno-18-121"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-122"><a id="__codelineno-18-122" name="__codelineno-18-122" href="#__codelineno-18-122"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">docling.document_converter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentConverter</span>  <span class="c1"># noqa:F401</span>
</span><span id="__span-18-123"><a id="__codelineno-18-123" name="__codelineno-18-123" href="#__codelineno-18-123"></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="__span-18-124"><a id="__codelineno-18-124" name="__codelineno-18-124" href="#__codelineno-18-124"></a>            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="__span-18-125"><a id="__codelineno-18-125" name="__codelineno-18-125" href="#__codelineno-18-125"></a>                <span class="s2">&quot;`docling` package not found, please install it with &quot;</span>
</span><span id="__span-18-126"><a id="__codelineno-18-126" name="__codelineno-18-126" href="#__codelineno-18-126"></a>                <span class="s2">&quot;`pip install docling`&quot;</span>
</span><span id="__span-18-127"><a id="__codelineno-18-127" name="__codelineno-18-127" href="#__codelineno-18-127"></a>            <span class="p">)</span>
</span><span id="__span-18-128"><a id="__codelineno-18-128" name="__codelineno-18-128" href="#__codelineno-18-128"></a>
</span><span id="__span-18-129"><a id="__codelineno-18-129" name="__codelineno-18-129" href="#__codelineno-18-129"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-18-130"><a id="__codelineno-18-130" name="__codelineno-18-130" href="#__codelineno-18-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
</span><span id="__span-18-131"><a id="__codelineno-18-131" name="__codelineno-18-131" href="#__codelineno-18-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rapidocr_model_dir</span> <span class="o">=</span> <span class="n">rapidocr_model_dir</span>
</span><span id="__span-18-132"><a id="__codelineno-18-132" name="__codelineno-18-132" href="#__codelineno-18-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">do_ocr</span> <span class="o">=</span> <span class="n">do_ocr</span>
</span><span id="__span-18-133"><a id="__codelineno-18-133" name="__codelineno-18-133" href="#__codelineno-18-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_picture_images</span> <span class="o">=</span> <span class="n">generate_picture_images</span>
</span><span id="__span-18-134"><a id="__codelineno-18-134" name="__codelineno-18-134" href="#__codelineno-18-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">images_scale</span> <span class="o">=</span> <span class="n">images_scale</span>
</span><span id="__span-18-135"><a id="__codelineno-18-135" name="__codelineno-18-135" href="#__codelineno-18-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">do_image_upload</span> <span class="o">=</span> <span class="n">do_image_upload</span>
</span><span id="__span-18-136"><a id="__codelineno-18-136" name="__codelineno-18-136" href="#__codelineno-18-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
</span><span id="__span-18-137"><a id="__codelineno-18-137" name="__codelineno-18-137" href="#__codelineno-18-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="__span-18-138"><a id="__codelineno-18-138" name="__codelineno-18-138" href="#__codelineno-18-138"></a>
</span><span id="__span-18-139"><a id="__codelineno-18-139" name="__codelineno-18-139" href="#__codelineno-18-139"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
</span><span id="__span-18-140"><a id="__codelineno-18-140" name="__codelineno-18-140" href="#__codelineno-18-140"></a>
</span><span id="__span-18-141"><a id="__codelineno-18-141" name="__codelineno-18-141" href="#__codelineno-18-141"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_rapidocr_pipeline_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-18-142"><a id="__codelineno-18-142" name="__codelineno-18-142" href="#__codelineno-18-142"></a>
</span><span id="__span-18-143"><a id="__codelineno-18-143" name="__codelineno-18-143" href="#__codelineno-18-143"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">docling.datamodel.pipeline_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfPipelineOptions</span><span class="p">,</span> <span class="n">RapidOcrOptions</span>
</span><span id="__span-18-144"><a id="__codelineno-18-144" name="__codelineno-18-144" href="#__codelineno-18-144"></a>        <span class="n">download_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rapidocr_model_dir</span>
</span><span id="__span-18-145"><a id="__codelineno-18-145" name="__codelineno-18-145" href="#__codelineno-18-145"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span>
</span><span id="__span-18-146"><a id="__codelineno-18-146" name="__codelineno-18-146" href="#__codelineno-18-146"></a>            <span class="c1"># pip install rapidocr_onnxruntime</span>
</span><span id="__span-18-147"><a id="__codelineno-18-147" name="__codelineno-18-147" href="#__codelineno-18-147"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-148"><a id="__codelineno-18-148" name="__codelineno-18-148" href="#__codelineno-18-148"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">rapidocr_onnxruntime</span><span class="w"> </span><span class="kn">import</span> <span class="n">RapidOCR</span>  <span class="c1"># type: ignore</span>
</span><span id="__span-18-149"><a id="__codelineno-18-149" name="__codelineno-18-149" href="#__codelineno-18-149"></a>            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="__span-18-150"><a id="__codelineno-18-150" name="__codelineno-18-150" href="#__codelineno-18-150"></a>                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="__span-18-151"><a id="__codelineno-18-151" name="__codelineno-18-151" href="#__codelineno-18-151"></a>                    <span class="s2">&quot;RapidOCR is not installed. Please install it via `pip install rapidocr_onnxruntime` to use this OCR engine. &quot;</span>
</span><span id="__span-18-152"><a id="__codelineno-18-152" name="__codelineno-18-152" href="#__codelineno-18-152"></a>                    <span class="s2">&quot;Alternatively, Docling has support for other OCR engines. See the documentation.&quot;</span>
</span><span id="__span-18-153"><a id="__codelineno-18-153" name="__codelineno-18-153" href="#__codelineno-18-153"></a>                <span class="p">)</span>
</span><span id="__span-18-154"><a id="__codelineno-18-154" name="__codelineno-18-154" href="#__codelineno-18-154"></a>            <span class="n">det_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-18-155"><a id="__codelineno-18-155" name="__codelineno-18-155" href="#__codelineno-18-155"></a>                <span class="n">download_path</span><span class="p">,</span> <span class="s2">&quot;onnx/PP-OCRv4/det&quot;</span><span class="p">,</span> <span class="s2">&quot;Multilingual_PP-OCRv3_det_infer.onnx&quot;</span>
</span><span id="__span-18-156"><a id="__codelineno-18-156" name="__codelineno-18-156" href="#__codelineno-18-156"></a>            <span class="p">)</span>
</span><span id="__span-18-157"><a id="__codelineno-18-157" name="__codelineno-18-157" href="#__codelineno-18-157"></a>            <span class="n">rec_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-18-158"><a id="__codelineno-18-158" name="__codelineno-18-158" href="#__codelineno-18-158"></a>                <span class="n">download_path</span><span class="p">,</span> <span class="s2">&quot;onnx/PP-OCRv4/rec&quot;</span><span class="p">,</span> <span class="s2">&quot;ch_PP-OCRv4_rec_server_infer.onnx&quot;</span>
</span><span id="__span-18-159"><a id="__codelineno-18-159" name="__codelineno-18-159" href="#__codelineno-18-159"></a>            <span class="p">)</span>
</span><span id="__span-18-160"><a id="__codelineno-18-160" name="__codelineno-18-160" href="#__codelineno-18-160"></a>            <span class="n">cls_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-18-161"><a id="__codelineno-18-161" name="__codelineno-18-161" href="#__codelineno-18-161"></a>                <span class="n">download_path</span><span class="p">,</span> <span class="s2">&quot;onnx/PP-OCRv4/cls&quot;</span><span class="p">,</span> <span class="s2">&quot;ch_ppocr_mobile_v2.0_cls_infer.onnx&quot;</span><span class="p">,</span>
</span><span id="__span-18-162"><a id="__codelineno-18-162" name="__codelineno-18-162" href="#__codelineno-18-162"></a>            <span class="p">)</span>
</span><span id="__span-18-163"><a id="__codelineno-18-163" name="__codelineno-18-163" href="#__codelineno-18-163"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-164"><a id="__codelineno-18-164" name="__codelineno-18-164" href="#__codelineno-18-164"></a>            <span class="c1"># pip install rapidocr_paddle</span>
</span><span id="__span-18-165"><a id="__codelineno-18-165" name="__codelineno-18-165" href="#__codelineno-18-165"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-166"><a id="__codelineno-18-166" name="__codelineno-18-166" href="#__codelineno-18-166"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">rapidocr_paddle</span><span class="w"> </span><span class="kn">import</span> <span class="n">RapidOCR</span>  <span class="c1"># type: ignore</span>
</span><span id="__span-18-167"><a id="__codelineno-18-167" name="__codelineno-18-167" href="#__codelineno-18-167"></a>            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="__span-18-168"><a id="__codelineno-18-168" name="__codelineno-18-168" href="#__codelineno-18-168"></a>                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="__span-18-169"><a id="__codelineno-18-169" name="__codelineno-18-169" href="#__codelineno-18-169"></a>                    <span class="s2">&quot;RapidOCR is not installed. Please install it via `pip install rapidocr_paddle` to use this OCR engine. &quot;</span>
</span><span id="__span-18-170"><a id="__codelineno-18-170" name="__codelineno-18-170" href="#__codelineno-18-170"></a>                    <span class="s2">&quot;Alternatively, Docling has support for other OCR engines. See the documentation.&quot;</span>
</span><span id="__span-18-171"><a id="__codelineno-18-171" name="__codelineno-18-171" href="#__codelineno-18-171"></a>                <span class="p">)</span>
</span><span id="__span-18-172"><a id="__codelineno-18-172" name="__codelineno-18-172" href="#__codelineno-18-172"></a>            <span class="n">det_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-18-173"><a id="__codelineno-18-173" name="__codelineno-18-173" href="#__codelineno-18-173"></a>                <span class="n">download_path</span><span class="p">,</span> <span class="s2">&quot;paddle/PP-OCRv4/det&quot;</span><span class="p">,</span> <span class="s2">&quot;ch_PP-OCRv4_det_server_infer&quot;</span>
</span><span id="__span-18-174"><a id="__codelineno-18-174" name="__codelineno-18-174" href="#__codelineno-18-174"></a>            <span class="p">)</span>
</span><span id="__span-18-175"><a id="__codelineno-18-175" name="__codelineno-18-175" href="#__codelineno-18-175"></a>            <span class="n">rec_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-18-176"><a id="__codelineno-18-176" name="__codelineno-18-176" href="#__codelineno-18-176"></a>                <span class="n">download_path</span><span class="p">,</span> <span class="s2">&quot;paddle/PP-OCRv4/rec&quot;</span><span class="p">,</span> <span class="s2">&quot;ch_PP-OCRv4_rec_server_infer&quot;</span>
</span><span id="__span-18-177"><a id="__codelineno-18-177" name="__codelineno-18-177" href="#__codelineno-18-177"></a>            <span class="p">)</span>
</span><span id="__span-18-178"><a id="__codelineno-18-178" name="__codelineno-18-178" href="#__codelineno-18-178"></a>            <span class="n">cls_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-18-179"><a id="__codelineno-18-179" name="__codelineno-18-179" href="#__codelineno-18-179"></a>                <span class="n">download_path</span><span class="p">,</span> <span class="s2">&quot;paddle/PP-OCRv4/cls&quot;</span><span class="p">,</span> <span class="s2">&quot;ch_ppocr_mobile_v2_cls_infer&quot;</span>
</span><span id="__span-18-180"><a id="__codelineno-18-180" name="__codelineno-18-180" href="#__codelineno-18-180"></a>            <span class="p">)</span>
</span><span id="__span-18-181"><a id="__codelineno-18-181" name="__codelineno-18-181" href="#__codelineno-18-181"></a>
</span><span id="__span-18-182"><a id="__codelineno-18-182" name="__codelineno-18-182" href="#__codelineno-18-182"></a>        <span class="n">ocr_options</span> <span class="o">=</span> <span class="n">RapidOcrOptions</span><span class="p">(</span>
</span><span id="__span-18-183"><a id="__codelineno-18-183" name="__codelineno-18-183" href="#__codelineno-18-183"></a>            <span class="n">det_model_path</span><span class="o">=</span><span class="n">det_model_path</span><span class="p">,</span>
</span><span id="__span-18-184"><a id="__codelineno-18-184" name="__codelineno-18-184" href="#__codelineno-18-184"></a>            <span class="n">rec_model_path</span><span class="o">=</span><span class="n">rec_model_path</span><span class="p">,</span>
</span><span id="__span-18-185"><a id="__codelineno-18-185" name="__codelineno-18-185" href="#__codelineno-18-185"></a>            <span class="n">cls_model_path</span><span class="o">=</span><span class="n">cls_model_path</span><span class="p">,</span>
</span><span id="__span-18-186"><a id="__codelineno-18-186" name="__codelineno-18-186" href="#__codelineno-18-186"></a>            <span class="n">force_full_page_ocr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-187"><a id="__codelineno-18-187" name="__codelineno-18-187" href="#__codelineno-18-187"></a>        <span class="p">)</span>
</span><span id="__span-18-188"><a id="__codelineno-18-188" name="__codelineno-18-188" href="#__codelineno-18-188"></a>
</span><span id="__span-18-189"><a id="__codelineno-18-189" name="__codelineno-18-189" href="#__codelineno-18-189"></a>        <span class="n">pipeline_options</span> <span class="o">=</span> <span class="n">PdfPipelineOptions</span><span class="p">(</span>
</span><span id="__span-18-190"><a id="__codelineno-18-190" name="__codelineno-18-190" href="#__codelineno-18-190"></a>            <span class="n">artifacts_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span>
</span><span id="__span-18-191"><a id="__codelineno-18-191" name="__codelineno-18-191" href="#__codelineno-18-191"></a>            <span class="n">do_ocr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_ocr</span><span class="p">,</span>
</span><span id="__span-18-192"><a id="__codelineno-18-192" name="__codelineno-18-192" href="#__codelineno-18-192"></a>            <span class="n">ocr_options</span><span class="o">=</span><span class="n">ocr_options</span><span class="p">,</span>
</span><span id="__span-18-193"><a id="__codelineno-18-193" name="__codelineno-18-193" href="#__codelineno-18-193"></a>            <span class="c1"># do_picture_description=True,</span>
</span><span id="__span-18-194"><a id="__codelineno-18-194" name="__codelineno-18-194" href="#__codelineno-18-194"></a>            <span class="n">generate_picture_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_picture_images</span><span class="p">,</span>
</span><span id="__span-18-195"><a id="__codelineno-18-195" name="__codelineno-18-195" href="#__codelineno-18-195"></a>            <span class="n">images_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">images_scale</span>
</span><span id="__span-18-196"><a id="__codelineno-18-196" name="__codelineno-18-196" href="#__codelineno-18-196"></a>        <span class="p">)</span>
</span><span id="__span-18-197"><a id="__codelineno-18-197" name="__codelineno-18-197" href="#__codelineno-18-197"></a>
</span><span id="__span-18-198"><a id="__codelineno-18-198" name="__codelineno-18-198" href="#__codelineno-18-198"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;使用ocr模型解析：</span><span class="si">{</span><span class="n">ocr_options</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-18-199"><a id="__codelineno-18-199" name="__codelineno-18-199" href="#__codelineno-18-199"></a>        <span class="k">return</span> <span class="n">pipeline_options</span>
</span><span id="__span-18-200"><a id="__codelineno-18-200" name="__codelineno-18-200" href="#__codelineno-18-200"></a>
</span><span id="__span-18-201"><a id="__codelineno-18-201" name="__codelineno-18-201" href="#__codelineno-18-201"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_lazy_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
</span><span id="__span-18-202"><a id="__codelineno-18-202" name="__codelineno-18-202" href="#__codelineno-18-202"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">docling.datamodel.base_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">InputFormat</span>
</span><span id="__span-18-203"><a id="__codelineno-18-203" name="__codelineno-18-203" href="#__codelineno-18-203"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">docling.datamodel.pipeline_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfPipelineOptions</span>
</span><span id="__span-18-204"><a id="__codelineno-18-204" name="__codelineno-18-204" href="#__codelineno-18-204"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">docling.document_converter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentConverter</span><span class="p">,</span> <span class="n">PdfFormatOption</span>
</span><span id="__span-18-205"><a id="__codelineno-18-205" name="__codelineno-18-205" href="#__codelineno-18-205"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">docling_core.types.doc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageRefMode</span>
</span><span id="__span-18-206"><a id="__codelineno-18-206" name="__codelineno-18-206" href="#__codelineno-18-206"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_ocr</span><span class="p">:</span>
</span><span id="__span-18-207"><a id="__codelineno-18-207" name="__codelineno-18-207" href="#__codelineno-18-207"></a>            <span class="n">pipeline_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rapidocr_pipeline_options</span><span class="p">()</span>
</span><span id="__span-18-208"><a id="__codelineno-18-208" name="__codelineno-18-208" href="#__codelineno-18-208"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-209"><a id="__codelineno-18-209" name="__codelineno-18-209" href="#__codelineno-18-209"></a>            <span class="c1"># 这里不提取图片内容，所以do_ocr=False，默认为True，则需要下载OCR模型</span>
</span><span id="__span-18-210"><a id="__codelineno-18-210" name="__codelineno-18-210" href="#__codelineno-18-210"></a>            <span class="n">pipeline_options</span> <span class="o">=</span> <span class="n">PdfPipelineOptions</span><span class="p">(</span><span class="n">artifacts_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">do_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-18-211"><a id="__codelineno-18-211" name="__codelineno-18-211" href="#__codelineno-18-211"></a>
</span><span id="__span-18-212"><a id="__codelineno-18-212" name="__codelineno-18-212" href="#__codelineno-18-212"></a>        <span class="n">doc_converter</span> <span class="o">=</span> <span class="n">DocumentConverter</span><span class="p">(</span>
</span><span id="__span-18-213"><a id="__codelineno-18-213" name="__codelineno-18-213" href="#__codelineno-18-213"></a>            <span class="n">format_options</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-18-214"><a id="__codelineno-18-214" name="__codelineno-18-214" href="#__codelineno-18-214"></a>                <span class="n">InputFormat</span><span class="o">.</span><span class="n">PDF</span><span class="p">:</span> <span class="n">PdfFormatOption</span><span class="p">(</span><span class="n">pipeline_options</span><span class="o">=</span><span class="n">pipeline_options</span><span class="p">)</span>
</span><span id="__span-18-215"><a id="__codelineno-18-215" name="__codelineno-18-215" href="#__codelineno-18-215"></a>            <span class="p">}</span>
</span><span id="__span-18-216"><a id="__codelineno-18-216" name="__codelineno-18-216" href="#__codelineno-18-216"></a>        <span class="p">)</span>
</span><span id="__span-18-217"><a id="__codelineno-18-217" name="__codelineno-18-217" href="#__codelineno-18-217"></a>
</span><span id="__span-18-218"><a id="__codelineno-18-218" name="__codelineno-18-218" href="#__codelineno-18-218"></a>        <span class="c1"># source支持本地文件和远程URL</span>
</span><span id="__span-18-219"><a id="__codelineno-18-219" name="__codelineno-18-219" href="#__codelineno-18-219"></a>        <span class="n">conv_res</span> <span class="o">=</span> <span class="n">doc_converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-18-220"><a id="__codelineno-18-220" name="__codelineno-18-220" href="#__codelineno-18-220"></a>
</span><span id="__span-18-221"><a id="__codelineno-18-221" name="__codelineno-18-221" href="#__codelineno-18-221"></a>        <span class="n">markdown_content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="__span-18-222"><a id="__codelineno-18-222" name="__codelineno-18-222" href="#__codelineno-18-222"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_picture_images</span><span class="p">:</span>
</span><span id="__span-18-223"><a id="__codelineno-18-223" name="__codelineno-18-223" href="#__codelineno-18-223"></a>
</span><span id="__span-18-224"><a id="__codelineno-18-224" name="__codelineno-18-224" href="#__codelineno-18-224"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-18-225"><a id="__codelineno-18-225" name="__codelineno-18-225" href="#__codelineno-18-225"></a>            <span class="n">doc_filename</span> <span class="o">=</span> <span class="n">conv_res</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">stem</span>
</span><span id="__span-18-226"><a id="__codelineno-18-226" name="__codelineno-18-226" href="#__codelineno-18-226"></a>
</span><span id="__span-18-227"><a id="__codelineno-18-227" name="__codelineno-18-227" href="#__codelineno-18-227"></a>            <span class="c1"># Save markdown with externally referenced pictures</span>
</span><span id="__span-18-228"><a id="__codelineno-18-228" name="__codelineno-18-228" href="#__codelineno-18-228"></a>            <span class="n">md_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doc_filename</span><span class="si">}</span><span class="s2">.md&quot;</span>
</span><span id="__span-18-229"><a id="__codelineno-18-229" name="__codelineno-18-229" href="#__codelineno-18-229"></a>            <span class="c1"># 没有提供artifacts_dir的时候，函数会根据filename自动生成一个目录路径。</span>
</span><span id="__span-18-230"><a id="__codelineno-18-230" name="__codelineno-18-230" href="#__codelineno-18-230"></a>            <span class="c1"># 比如，假设filename是/path/to/file.txt，那么artifacts_dir会被设置为/path/to/file_artifacts。</span>
</span><span id="__span-18-231"><a id="__codelineno-18-231" name="__codelineno-18-231" href="#__codelineno-18-231"></a>            <span class="c1"># 这里的逻辑是去掉原文件的扩展名，然后在后面加上_artifacts作为目录名</span>
</span><span id="__span-18-232"><a id="__codelineno-18-232" name="__codelineno-18-232" href="#__codelineno-18-232"></a>            <span class="n">conv_res</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">save_as_markdown</span><span class="p">(</span>
</span><span id="__span-18-233"><a id="__codelineno-18-233" name="__codelineno-18-233" href="#__codelineno-18-233"></a>                <span class="n">filename</span><span class="o">=</span><span class="n">md_filename</span><span class="p">,</span>
</span><span id="__span-18-234"><a id="__codelineno-18-234" name="__codelineno-18-234" href="#__codelineno-18-234"></a>                <span class="n">image_mode</span><span class="o">=</span><span class="n">ImageRefMode</span><span class="o">.</span><span class="n">REFERENCED</span>
</span><span id="__span-18-235"><a id="__codelineno-18-235" name="__codelineno-18-235" href="#__codelineno-18-235"></a>            <span class="p">)</span>
</span><span id="__span-18-236"><a id="__codelineno-18-236" name="__codelineno-18-236" href="#__codelineno-18-236"></a>            <span class="k">if</span> <span class="n">md_filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="__span-18-237"><a id="__codelineno-18-237" name="__codelineno-18-237" href="#__codelineno-18-237"></a>                <span class="c1"># 读取markdown文件内容</span>
</span><span id="__span-18-238"><a id="__codelineno-18-238" name="__codelineno-18-238" href="#__codelineno-18-238"></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">md_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-18-239"><a id="__codelineno-18-239" name="__codelineno-18-239" href="#__codelineno-18-239"></a>                    <span class="n">markdown_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="__span-18-240"><a id="__codelineno-18-240" name="__codelineno-18-240" href="#__codelineno-18-240"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-241"><a id="__codelineno-18-241" name="__codelineno-18-241" href="#__codelineno-18-241"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Markdown file not found: </span><span class="si">{</span><span class="n">md_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-242"><a id="__codelineno-18-242" name="__codelineno-18-242" href="#__codelineno-18-242"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-243"><a id="__codelineno-18-243" name="__codelineno-18-243" href="#__codelineno-18-243"></a>            <span class="n">markdown_content</span> <span class="o">=</span> <span class="n">conv_res</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">export_to_markdown</span><span class="p">()</span>
</span><span id="__span-18-244"><a id="__codelineno-18-244" name="__codelineno-18-244" href="#__codelineno-18-244"></a>
</span><span id="__span-18-245"><a id="__codelineno-18-245" name="__codelineno-18-245" href="#__codelineno-18-245"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_image_upload</span><span class="p">:</span>
</span><span id="__span-18-246"><a id="__codelineno-18-246" name="__codelineno-18-246" href="#__codelineno-18-246"></a>            <span class="c1"># 上传图片到OSS</span>
</span><span id="__span-18-247"><a id="__codelineno-18-247" name="__codelineno-18-247" href="#__codelineno-18-247"></a>            <span class="n">markdown_content</span> <span class="o">=</span> <span class="n">replace_local_images_with_oss_url</span><span class="p">(</span>
</span><span id="__span-18-248"><a id="__codelineno-18-248" name="__codelineno-18-248" href="#__codelineno-18-248"></a>                <span class="n">content</span><span class="o">=</span><span class="n">markdown_content</span><span class="p">,</span>
</span><span id="__span-18-249"><a id="__codelineno-18-249" name="__codelineno-18-249" href="#__codelineno-18-249"></a>                <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
</span><span id="__span-18-250"><a id="__codelineno-18-250" name="__codelineno-18-250" href="#__codelineno-18-250"></a>                <span class="n">expires</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
</span><span id="__span-18-251"><a id="__codelineno-18-251" name="__codelineno-18-251" href="#__codelineno-18-251"></a>                <span class="n">image_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
</span><span id="__span-18-252"><a id="__codelineno-18-252" name="__codelineno-18-252" href="#__codelineno-18-252"></a>            <span class="p">)</span>
</span><span id="__span-18-253"><a id="__codelineno-18-253" name="__codelineno-18-253" href="#__codelineno-18-253"></a>
</span><span id="__span-18-254"><a id="__codelineno-18-254" name="__codelineno-18-254" href="#__codelineno-18-254"></a>        <span class="k">yield</span> <span class="n">Document</span><span class="p">(</span>
</span><span id="__span-18-255"><a id="__codelineno-18-255" name="__codelineno-18-255" href="#__codelineno-18-255"></a>            <span class="n">page_content</span><span class="o">=</span><span class="n">markdown_content</span><span class="p">,</span>
</span><span id="__span-18-256"><a id="__codelineno-18-256" name="__codelineno-18-256" href="#__codelineno-18-256"></a>            <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span>
</span><span id="__span-18-257"><a id="__codelineno-18-257" name="__codelineno-18-257" href="#__codelineno-18-257"></a>        <span class="p">)</span>
</span><span id="__span-18-258"><a id="__codelineno-18-258" name="__codelineno-18-258" href="#__codelineno-18-258"></a>
</span><span id="__span-18-259"><a id="__codelineno-18-259" name="__codelineno-18-259" href="#__codelineno-18-259"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
</span><span id="__span-18-260"><a id="__codelineno-18-260" name="__codelineno-18-260" href="#__codelineno-18-260"></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lazy_load</span><span class="p">())</span>
</span><span id="__span-18-261"><a id="__codelineno-18-261" name="__codelineno-18-261" href="#__codelineno-18-261"></a>
</span><span id="__span-18-262"><a id="__codelineno-18-262" name="__codelineno-18-262" href="#__codelineno-18-262"></a>
</span><span id="__span-18-263"><a id="__codelineno-18-263" name="__codelineno-18-263" href="#__codelineno-18-263"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-18-264"><a id="__codelineno-18-264" name="__codelineno-18-264" href="#__codelineno-18-264"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-18-265"><a id="__codelineno-18-265" name="__codelineno-18-265" href="#__codelineno-18-265"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">oss_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">oss_client</span>
</span><span id="__span-18-266"><a id="__codelineno-18-266" name="__codelineno-18-266" href="#__codelineno-18-266"></a>
</span><span id="__span-18-267"><a id="__codelineno-18-267" name="__codelineno-18-267" href="#__codelineno-18-267"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-18-268"><a id="__codelineno-18-268" name="__codelineno-18-268" href="#__codelineno-18-268"></a>    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;/Users/xiniao/Downloads/法人金融机构洗钱和恐怖融资风险自评估指引.pdf&quot;</span>
</span><span id="__span-18-269"><a id="__codelineno-18-269" name="__codelineno-18-269" href="#__codelineno-18-269"></a>    <span class="n">doc</span> <span class="o">=</span> <span class="n">Pdf2MarkdownLoader</span><span class="p">(</span>
</span><span id="__span-18-270"><a id="__codelineno-18-270" name="__codelineno-18-270" href="#__codelineno-18-270"></a>        <span class="n">file_path</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
</span><span id="__span-18-271"><a id="__codelineno-18-271" name="__codelineno-18-271" href="#__codelineno-18-271"></a>        <span class="n">do_ocr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-272"><a id="__codelineno-18-272" name="__codelineno-18-272" href="#__codelineno-18-272"></a>        <span class="n">do_image_upload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-273"><a id="__codelineno-18-273" name="__codelineno-18-273" href="#__codelineno-18-273"></a>        <span class="n">bucket</span><span class="o">=</span><span class="n">oss_client</span><span class="o">.</span><span class="n">bucket</span>
</span><span id="__span-18-274"><a id="__codelineno-18-274" name="__codelineno-18-274" href="#__codelineno-18-274"></a>    <span class="p">)</span>
</span><span id="__span-18-275"><a id="__codelineno-18-275" name="__codelineno-18-275" href="#__codelineno-18-275"></a>    <span class="n">docs</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span id="__span-18-276"><a id="__codelineno-18-276" name="__codelineno-18-276" href="#__codelineno-18-276"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">docs</span><span class="p">:</span>
</span><span id="__span-18-277"><a id="__codelineno-18-277" name="__codelineno-18-277" href="#__codelineno-18-277"></a>        <span class="n">markdown_content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="__span-18-278"><a id="__codelineno-18-278" name="__codelineno-18-278" href="#__codelineno-18-278"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-279"><a id="__codelineno-18-279" name="__codelineno-18-279" href="#__codelineno-18-279"></a>        <span class="n">markdown_content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">)</span>
</span><span id="__span-18-280"><a id="__codelineno-18-280" name="__codelineno-18-280" href="#__codelineno-18-280"></a>
</span><span id="__span-18-281"><a id="__codelineno-18-281" name="__codelineno-18-281" href="#__codelineno-18-281"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">markdown_content</span><span class="p">)</span>
</span><span id="__span-18-282"><a id="__codelineno-18-282" name="__codelineno-18-282" href="#__codelineno-18-282"></a>    <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-18-283"><a id="__codelineno-18-283" name="__codelineno-18-283" href="#__codelineno-18-283"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function took </span><span class="si">{</span><span class="n">execution_time</span><span class="si">}</span><span class="s2"> seconds to run.&quot;</span><span class="p">)</span>
</span><span id="__span-18-284"><a id="__codelineno-18-284" name="__codelineno-18-284" href="#__codelineno-18-284"></a>    <span class="c1"># 在mac中解析132页pdf耗时：27分钟</span>
</span><span id="__span-18-285"><a id="__codelineno-18-285" name="__codelineno-18-285" href="#__codelineno-18-285"></a>    <span class="c1"># 使用 onnx 的 rapidocr模型，在gpu上面，解析21页pdf，耗时：2915秒</span>
</span><span id="__span-18-286"><a id="__codelineno-18-286" name="__codelineno-18-286" href="#__codelineno-18-286"></a>    <span class="c1"># 使用 onnx 的 rapidocr模型，在gpu上面，解析5页pdf，耗时：744秒</span>
</span><span id="__span-18-287"><a id="__codelineno-18-287" name="__codelineno-18-287" href="#__codelineno-18-287"></a>    <span class="c1"># 使用 paddle 的 rapidocr模型，在paddlepaddle-gpu==3.0.0上面，解析5页pdf，耗时：29秒</span>
</span></code></pre></div>
<blockquote>
<p>注意：有时候在解析pdf时，docling 模型会将整个或者部分pdf识别为图片，导致部分内容无法正确转换为markdown的内容，所以为了提高解析的准确率，可以考虑在创建 <code>RapidOcrOptions</code>时，指定参数：</p>
<p><code>force_full_page_ocr=True</code>该参数的作用是将所有的页面都作为图片，通过ocr进行识别转换。
</p>
</blockquote>
<h2 id="doclingcpugpu">docling在cpu和gpu的效率对比</h2>
<table>
<thead>
<tr>
<th><strong>试场景</strong></th>
<th><strong>环境</strong></th>
<th><strong>是否使用OCR模型</strong></th>
<th><strong>模型及配置</strong></th>
<th><strong>PDF页数</strong></th>
<th><strong>耗时（秒）</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>不使用 RapidOCR 模型</td>
<td>CPU</td>
<td>否</td>
<td>无模型（仅基础解析）</td>
<td>6</td>
<td>14</td>
</tr>
<tr>
<td>使用 RapidOCR（ONNX Runtime-GPU）</td>
<td>GPU</td>
<td>是</td>
<td>RapidOCR + ONNX Runtime-GPU</td>
<td>6</td>
<td>72</td>
</tr>
<tr>
<td>在 Mac 上运行，使用OCR模型</td>
<td>Mac</td>
<td>是</td>
<td>RapidOCR + ONNX Runtime-GPU</td>
<td>6</td>
<td>110</td>
</tr>
<tr>
<td>在 Mac 上不使用OCR模型</td>
<td>Mac</td>
<td>否</td>
<td>无模型（仅基础解析）</td>
<td>6</td>
<td>6</td>
</tr>
<tr>
<td>ONNX Runtime-GPU + RapidOCR（全页OCR）</td>
<td>GPU</td>
<td>是</td>
<td>RapidOCR + ONNX Runtime-GPU +  <code>force_full_page_ocr=True</code></td>
<td>5</td>
<td>744</td>
</tr>
<tr>
<td>PaddlePaddle-GPU 3.0.0 + RapidOCR（全页OCR）</td>
<td>GPU</td>
<td>是</td>
<td>RapidOCR + PaddlePaddle-GPU 3.0.0 +  <code>force_full_page_ocr=True</code></td>
<td>5</td>
<td>29</td>
</tr>
</tbody>
</table>
<h2 id="_5">问题记录</h2>
<p>使用在 gpu 上面使用cuda版本 <strong><code>cuda_12.1.r12.1</code></strong> 安装 <strong><code>paddlepaddle-gpu==2.6.2</code>报错信息如下</strong></p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>File<span class="w"> </span><span class="s2">&quot;/usr/local/lib/python3.7/dist-packages/paddle/fluid/framework.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">3621</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>append_op
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">      </span><span class="nv">attrs</span><span class="o">=</span>kwargs.get<span class="o">(</span><span class="s2">&quot;attrs&quot;</span>,<span class="w"> </span>None<span class="o">))</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>File<span class="w"> </span><span class="s2">&quot;/usr/local/lib/python3.7/dist-packages/paddle/fluid/framework.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">2635</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>__init__
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span>frame<span class="w"> </span><span class="k">in</span><span class="w"> </span>traceback.extract_stack<span class="o">()</span>:
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>ExternalError:<span class="w"> </span>CUDNN<span class="w"> </span>error<span class="o">(</span><span class="m">9</span><span class="o">)</span>,<span class="w"> </span>CUDNN_STATUS_NOT_SUPPORTED.<span class="w"> </span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">  </span><span class="o">[</span>Hint:<span class="w"> </span><span class="s1">&#39;CUDNN_STATUS_NOT_SUPPORTED&#39;</span>.<span class="w">  </span>The<span class="w"> </span>functionality<span class="w"> </span>requested<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>presently<span class="w"> </span>supported<span class="w"> </span>by<span class="w"> </span>cuDNN.<span class="w">  </span><span class="o">]</span><span class="w"> </span><span class="o">(</span>at<span class="w"> </span>/paddle/paddle/phi/kernels/fusion/gpu/fused_conv2d_add_act_kernel.cu:610<span class="o">)</span>
</span></code></pre></div>
<p><strong>报错原因：因为<code>paddlepaddle-gpu==2.6.2</code>不支持当前的 cuda_12.1</strong></p>
<p><strong>解决方法：升级paddlepaddle-gpu的版本为 <code>paddlepaddle-gpu==3.0.0</code></strong></p>
<p>参考文档</p>
<ol>
<li><a href="https://docling-project.github.io/docling/examples/full_page_ocr/">https://docling-project.github.io/docling/examples/full_page_ocr/</a></li>
<li><a href="https://python.langchain.com/docs/integrations/document_loaders/docling/">https://python.langchain.com/docs/integrations/document_loaders/docling/</a></li>
<li><a href="https://rapidai.github.io/RapidOCRDocs/install_usage/rapidocr_paddle/usage/">https://rapidai.github.io/RapidOCRDocs/install_usage/rapidocr_paddle/usage/</a></li>
<li><a href="https://python.langchain.com/docs/integrations/document_loaders/docling/">https://python.langchain.com/docs/integrations/document_loaders/docling/</a></li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.select"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>