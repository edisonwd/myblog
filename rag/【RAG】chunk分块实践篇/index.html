
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../RAG%E6%8A%80%E6%9C%AF%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E6%8C%91%E6%88%98%E5%88%86%E6%9E%90/">
      
      
        <link rel="next" href="../%E3%80%90RAG%E3%80%91chunk%E5%88%86%E5%9D%97%E7%90%86%E8%AE%BA%E7%AF%87/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>【RAG】chunk分块实践篇 - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chunk" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              【RAG】chunk分块实践篇
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Devops
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Devops
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/apisix%E5%9C%A8k8s%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    apisix在k8s中的实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/devops%E5%B7%A5%E5%85%B7zadig%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    devops工具zadig实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/k8s%E4%B8%AD%E7%9A%84nginx-ingress%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E8%B7%AF%E5%BE%84%E9%87%8D%E5%AE%9A%E5%90%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    k8s中的nginx-ingress如何配置路径重定向
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%9C%A8k8s%E4%B8%AD%E5%AE%89%E8%A3%85%E5%B9%B6%E4%BD%BF%E7%94%A8jenkins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在k8s中安装并使用jenkins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%9C%A8k8s%E4%B8%AD%E5%AE%89%E8%A3%85%E5%B9%B6%E4%BD%BF%E7%94%A8nexus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在k8s中安装并使用nexus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98docker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何提高docker容器的安全性
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Go
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Go
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/go%E8%AF%AD%E8%A8%80grpc%E6%A1%86%E6%9E%B6%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    go语言grpc框架从入门到实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/%E3%80%90golang%E3%80%91%E4%BD%BF%E7%94%A8chan%E6%94%B6%E9%9B%86%E5%A4%9A%E5%8D%8F%E7%A8%8B%E6%89%A7%E8%A1%8C%E7%9A%84%E7%BB%93%E6%9E%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【golang】使用chan收集多协程执行的结果
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../go/%E3%80%90golang%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E3%80%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【golang学习记录】环境搭建
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Image
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Image
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    收集的学习资料
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            收集的学习资料
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../image/%E6%94%B6%E9%9B%86%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/%E5%9C%A8%E7%BA%BF%E9%98%85%E8%AF%BB%E4%B9%A6%E7%B1%8D%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在线阅读书籍汇总
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%20%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java 编程思想
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java11%E5%92%8CJava17%E4%B9%8B%E9%97%B4%E6%9C%89%E5%93%AA%E4%BA%9B%E6%96%B0%E5%8F%98%E5%8C%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java11和Java17之间有哪些新变化
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/java%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    java中如何实现线程间通信
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E4%B8%AD%E8%8E%B7%E5%8F%96ThreadDumps%E7%9A%848%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java中获取ThreadDumps的8种方式汇总
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%92%8Cgo%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0LRU%E7%AE%97%E6%B3%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java和go语言实现LRU算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java异常
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Java%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E8%AE%BE%E8%AE%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java异常处理设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/maven%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    maven基础知识汇总
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Mockito%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mockito单元测试框架使用指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/Mockito%E7%9A%84%E5%B8%B8%E8%A7%81%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E5%8F%8A%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mockito的常见核心功能及最佳实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/springboot%E4%BD%BF%E7%94%A8k8s%E7%9A%84configMap%E4%BD%9C%E4%B8%BA%E5%A4%96%E9%83%A8%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot使用k8s的configMap作为外部配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E4%BD%BF%E7%94%A8maven%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用maven自定义插件实现devops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7%20Java%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何监控 Java 垃圾回收
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E5%A6%82%E4%BD%95%E8%B0%83%E4%BC%98%20Java%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何调优 Java 垃圾收集
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E6%98%AF%E4%BB%80%E4%B9%88%E8%AE%A9Java%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84CPU%E4%BD%BF%E7%94%A8%E7%8E%87%E9%A3%99%E5%8D%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    是什么让Java应用程序的CPU使用率飙升
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3%20Java%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    简单理解 Java 垃圾收集器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/%E9%98%85%E8%AF%BB%E9%98%BF%E9%87%8CJava%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C%E8%AE%B0%E5%BD%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    阅读阿里Java开发手册记录
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Other
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Other
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/Python%E8%84%9A%E6%9C%AC%E5%A4%84%E7%90%86Markdown%E5%9B%BE%E7%89%87%E6%9C%AC%E5%9C%B0%E5%8C%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python脚本处理Markdown图片本地化
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E4%BC%98%E7%A7%80%E5%8D%9A%E5%AE%A2%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    优秀博客汇总
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E4%BD%BF%E7%94%A8Awescnb%E6%9E%84%E5%BB%BA%E9%85%B7%E7%82%AB%E7%9A%84%E5%8D%9A%E5%AE%A2%E5%9B%AD%E7%9A%AE%E8%82%A4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用Awescnb构建酷炫的博客园皮肤
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E5%9C%A8markdown%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%A1%A8%E6%83%85%E7%AC%A6%E5%8F%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    在markdown中使用表情符号
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/gunicorn%E8%B6%85%E6%97%B6%E6%8A%A5%E9%94%99/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    gunicorn超时报错
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E4%B8%ADThreadPoolExecutor%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python中ThreadPoolExecutor运行原理解析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%8F%90%E5%8F%96json%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%80%BC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python使用正则表达式提取json字符串的值
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/python%E5%AE%9E%E7%8E%B0%E6%8E%98%E9%87%91%E5%AE%9A%E6%97%B6%E7%AD%BE%E5%88%B0%E6%8A%BD%E5%A5%96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python实现掘金定时签到抽奖
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/%E4%BD%BF%E7%94%A8python%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用python问题总结
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Rag
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Rag
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PDF%E9%A1%B5%E7%9C%89%E9%A1%B5%E8%84%9A%E8%AF%86%E5%88%AB%E4%B8%8E%E5%8E%BB%E9%99%A4%E6%96%B9%E6%A1%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF页眉页脚识别与去除方案
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../RAG%E6%8A%80%E6%9C%AF%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E6%8C%91%E6%88%98%E5%88%86%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAG技术及其应用挑战分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    【RAG】chunk分块实践篇
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    【RAG】chunk分块实践篇
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      按字符分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按字符分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      按单字符分块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      按多字符递归分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按多字符递归分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      设置中文场景分隔符
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token" class="md-nav__link">
    <span class="md-ellipsis">
      按 token 分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按 token 分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modelscope-tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      从 modelscope 下载 tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#from_huggingface_tokenizer-token" class="md-nav__link">
    <span class="md-ellipsis">
      使用 from_huggingface_tokenizer 方法按照token分块
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token_1" class="md-nav__link">
    <span class="md-ellipsis">
      字符分块和token分块对比
    </span>
  </a>
  
    <nav class="md-nav" aria-label="字符分块和token分块对比">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义与原理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 优缺点对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 示例对比
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 示例对比">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      输入文本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      分块结果
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 适用场景
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 关键差异总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 选择建议
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      按照语义分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按照语义分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      核心思路
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      具体步骤示例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="具体步骤示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      输入文本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      分块过程
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      优点与缺点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      关键参数与调优建议
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      改进方向
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      适用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      语义分块代码实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="语义分块代码实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#embedding" class="md-nav__link">
    <span class="md-ellipsis">
      选择embedding模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding_1" class="md-nav__link">
    <span class="md-ellipsis">
      加载embedding模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semanticchunker" class="md-nav__link">
    <span class="md-ellipsis">
      使用 SemanticChunker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#markdown" class="md-nav__link">
    <span class="md-ellipsis">
      按标题拆分 Markdown
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按标题拆分 Markdown">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#markdownheadertextsplitter" class="md-nav__link">
    <span class="md-ellipsis">
      使用 MarkdownHeaderTextSplitter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      如何限制块的大小
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#markdown_1" class="md-nav__link">
    <span class="md-ellipsis">
      markdown 分块其他挑战
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      动态分块
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91chunk%E5%88%86%E5%9D%97%E7%90%86%E8%AE%BA%E7%AF%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】chunk分块理论篇
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91docling%E7%BB%93%E5%90%88OCR%E5%AE%9E%E7%8E%B0pdf%E8%BD%ACmarkdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】docling结合OCR实现pdf转markdown
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91%E4%BD%BF%E7%94%A8PyMuPDF4LLM%E8%A7%A3%E6%9E%90PDF%E7%9A%84%E5%9B%BE%E7%89%87%E5%92%8C%E8%A1%A8%E6%A0%BC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】使用PyMuPDF4LLM解析PDF的图片和表格
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E3%80%91%E6%9E%84%E5%BB%BA%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG】构建向量数据库索引
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E3%80%90RAG%E4%BC%98%E5%8C%96%E3%80%91%E5%B0%86pdf%E5%92%8Cdocx%E8%BD%AC%E6%8D%A2%E4%B8%BAmarkdown%E6%A0%BC%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【RAG优化】将pdf和docx转换为markdown格式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%BD%BF%E7%94%A8Nanonets-OCR-s%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0PDF%E6%96%87%E4%BB%B6%E8%BD%ACmarkdown/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用Nanonets-OCR-s模型实现PDF文件转markdown
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Springboot
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Springboot
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20Validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spring Boot 中使用 Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%E4%B8%AD%E4%BD%BF%E7%94%A8MyBatis%20Generator%E7%94%9F%E6%88%90%E5%8A%A8%E6%80%81SQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spring Boot中使用MyBatis Generator生成动态SQL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/Spring%20Boot%E9%A1%B9%E7%9B%AE%E8%87%AA%E5%B7%B1%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AA%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spring Boot项目自己封装一个分页查询工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%20%E5%A4%A7%E5%9E%8B%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%8C%85%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%28DDD%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot 大型复杂项目的包结构设计(DDD)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%E4%B8%AD%E4%BD%BF%E7%94%A8MapStruct%E6%95%99%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot中使用MapStruct教程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/springboot%E9%A1%B9%E7%9B%AE%E4%B8%AD%20PO%20BO%20VO%20DTO%20POJO%20DAO%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8%EF%BC%88%E9%99%84%E8%BD%AC%E6%8D%A2%E5%9B%BE%EF%BC%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    springboot项目中 PO BO VO DTO POJO DAO概念及其作用（附转换图）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../springboot/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%8D%81%E5%88%86%E9%92%9F%E5%AE%9E%E7%8E%B0springboot%20%2B%20MyBatis%20Dynamic%20SQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    从零开始十分钟实现springboot + MyBatis Dynamic SQL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    大模型
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            大模型
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/langchain%E4%BD%BF%E7%94%A8token%E5%88%87%E5%88%86chunk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    langchain使用token切分chunk
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/LLM%E7%BB%9F%E4%B8%80%E7%BD%91%E5%85%B3%EF%BC%9ALiteLLM%20%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM统一网关：LiteLLM 详细介绍
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    大模型工具调用原理和实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E5%A6%82%E4%BD%95%E8%AE%A9%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何让大模型输出结构化数据
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%B7%A5%E5%85%B7/%E4%BD%BF%E7%94%A8%E8%BF%87%E7%9A%84%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用过的开源工具
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    爬虫
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            爬虫
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/BeautifulSoup%E7%9A%84%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BeautifulSoup的使用
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/selenium%E5%A6%82%E4%BD%95%E6%8B%96%E5%8A%A8%E6%BB%9A%E5%8A%A8%E6%9D%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    selenium如何拖动滚动条
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/%E3%80%90%E7%88%AC%E8%99%AB%E3%80%91docker%E9%83%A8%E7%BD%B2python%2Bselenium%2Bfirefox-headless/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【爬虫】docker部署python+selenium+firefox-headless
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%88%AC%E8%99%AB/%E3%80%90%E7%88%AC%E8%99%AB%E3%80%91python%2Bselenium%2Bfirefox%E4%BD%BF%E7%94%A8%E4%B8%8E%E9%83%A8%E7%BD%B2%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    【爬虫】python+selenium+firefox使用与部署详解
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    算法
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            算法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%AE%97%E6%B3%95/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E5%9B%BE%E6%96%87%E8%AE%B2%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    归并排序图文讲解
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      按字符分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按字符分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      按单字符分块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      按多字符递归分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按多字符递归分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      设置中文场景分隔符
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token" class="md-nav__link">
    <span class="md-ellipsis">
      按 token 分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按 token 分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modelscope-tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      从 modelscope 下载 tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#from_huggingface_tokenizer-token" class="md-nav__link">
    <span class="md-ellipsis">
      使用 from_huggingface_tokenizer 方法按照token分块
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token_1" class="md-nav__link">
    <span class="md-ellipsis">
      字符分块和token分块对比
    </span>
  </a>
  
    <nav class="md-nav" aria-label="字符分块和token分块对比">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义与原理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 优缺点对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 示例对比
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 示例对比">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      输入文本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      分块结果
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 适用场景
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 关键差异总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 选择建议
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      按照语义分块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按照语义分块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      核心思路
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      具体步骤示例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="具体步骤示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      输入文本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      分块过程
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      优点与缺点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      关键参数与调优建议
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      改进方向
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      适用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      语义分块代码实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="语义分块代码实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#embedding" class="md-nav__link">
    <span class="md-ellipsis">
      选择embedding模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding_1" class="md-nav__link">
    <span class="md-ellipsis">
      加载embedding模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semanticchunker" class="md-nav__link">
    <span class="md-ellipsis">
      使用 SemanticChunker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#markdown" class="md-nav__link">
    <span class="md-ellipsis">
      按标题拆分 Markdown
    </span>
  </a>
  
    <nav class="md-nav" aria-label="按标题拆分 Markdown">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#markdownheadertextsplitter" class="md-nav__link">
    <span class="md-ellipsis">
      使用 MarkdownHeaderTextSplitter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      如何限制块的大小
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#markdown_1" class="md-nav__link">
    <span class="md-ellipsis">
      markdown 分块其他挑战
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      动态分块
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="chunk">chunk分块实践篇</h1>
<blockquote>
<p>RAG 的尽头就是 Agent
</p>
</blockquote>
<h2 id="_1">概述</h2>
<p>本文是chunk分块的实践篇，chunk分块的理论可以查看前一篇文章<a href="https://yuque.antfin.com/xiniao.wd/tcc9h6/ax7d5kzzd427dhh6">chunk分块理论篇</a>。</p>
<p>接下来主要使用 langchain 提供的工具对前面的chunk分块方法进行实践，下面内容都是在jupyter notebook中进行实践的，然后将内容转换为markdown格式。</p>
<blockquote>
<p>可以使用下面的命令将 jupyter notebook 转换为 markdown 格式文件：</p>
<ol>
<li>安装 nbconvert：<code>pip install nbconvert</code></li>
<li>执行转换命令：<code>jupyter nbconvert --to markdown your_notebook.ipynb</code>
</li>
</ol>
</blockquote>
<p>进行实践之前需要安装相关依赖 </p>
<blockquote>
<p>查看相关接口文档：<a href="https://python.langchain.com/api_reference/text_splitters/index.html#">langchain-text-splitters接口文档</a>
</p>
</blockquote>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">qU</span> <span class="n">langchain</span><span class="o">-</span><span class="n">text</span><span class="o">-</span><span class="n">splitters</span>
</span></code></pre></div>
<h2 id="_2">按字符分块</h2>
<h3 id="_3">按单字符分块</h3>
<p>使用 <code>langchain</code> 的 <code>CharacterTextSplitter</code> 这是最简单的方法(在应用中不推荐使用)，它根据给定的字符序列进行拆分，默认为<code>\n\n</code>，chunk长度以字符数来衡量。</p>
<ul>
<li>文本的分割方式：按单个字符分隔符。</li>
<li>如何测量块大小：按字符数。</li>
<li>要直接获取字符串内容，使用.split_text。</li>
<li>要创建 LangChain Document对象（例如，用于下游任务），使用.create_documents。</li>
<li>内部使用的是 <code>_splits = re.split(f"({separator})", text)</code> 进行实现的</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_text_splitters</span><span class="w"> </span><span class="kn">import</span> <span class="n">CharacterTextSplitter</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="s2"># 固定长度分块</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="s2">使用 `langchain` 的 `CharacterTextSplitter` 这是最简单的方法，它根据给定的字符序列进行拆分，默认为`</span><span class="se">\n\n</span><span class="s2">`，chunk长度以字符数来衡量。</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="s2">- 文本的分割方式：按单个字符分隔符。</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="s2">- 如何测量块大小：按字符数。</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="s2">- 要直接获取字符串内容，使用.split_text。</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="s2">- 要创建 LangChain Document对象（例如，用于下游任务），使用.create_documents。</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="s2">- 内部使用的是 `_splits = re.split(f&quot;(</span><span class="si">{separator}</span><span class="s2">)&quot;, text)` 进行实现的</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">CharacterTextSplitter</span><span class="p">(</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="n">length_function</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="n">is_separator_regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="p">)</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">create_documents</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="nb">print</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</span></code></pre></div>
<p>输出结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>[Document(metadata={}, page_content=&#39;# 固定长度分块\n使用 `langchain` 的 `CharacterTextSplitter` 这是最简单的方法，它根据给定的字符序列进行拆分，默认为`\n\n`，chunk长度以字符数来衡量。&#39;), Document(metadata={}, page_content=&#39;- 文本的分割方式：按单个字符分隔符。\n- 如何测量块大小：按字符数。\n- 要直接获取字符串内容，使用.split_text。\n- 要创建 LangChain Document对象（例如，用于下游任务），使用.create_documents。\n- 内部使用的是 `_splits = re.split(f&quot;({separator})&quot;, text)` 进行实现的&#39;)]
</span></code></pre></div>
<p>让我们来看看上面设置的参数：</p>
<ul>
<li><code>chunk_size</code>：块的最大大小，其中大小由决定 <code>length_function</code>。</li>
<li><code>chunk_overlap</code>：目标块之间的重叠。重叠块有助于减少上下文在块之间划分时的信息丢失。</li>
<li><code>length_function</code>：确定块大小的函数，默认为 <code>len</code>。</li>
<li><code>is_separator_regex</code>：分隔符（默认为"\n\n"）是否应解释为正则表达式。</li>
</ul>
<p><strong>在使用.create_documents的使用，指定metadatas将与每个文档关联的元数据与chunk关联</strong>：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">metadatas</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">create_documents</span><span class="p">(</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="p">)</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</span></code></pre></div>
<p>输出结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>[Document(metadata={&#39;document&#39;: 1}, page_content=&#39;# 固定长度分块\n使用 `langchain` 的 `CharacterTextSplitter` 这是最简单的方法，它根据给定的字符序列进行拆分，默认为`\n\n`，chunk长度以字符数来衡量。&#39;), Document(metadata={&#39;document&#39;: 1}, page_content=&#39;- 文本的分割方式：按单个字符分隔符。\n- 如何测量块大小：按字符数。\n- 要直接获取字符串内容，使用.split_text。\n- 要创建 LangChain Document对象（例如，用于下游任务），使用.create_documents。\n- 内部使用的是 `_splits = re.split(f&quot;({separator})&quot;, text)` 进行实现的&#39;)]
</span></code></pre></div>
<p><strong>使用.split_text，直接获取切分后的字符串内容列表</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">text_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></code></pre></div>
<p>输出结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>[&#39;# 固定长度分块\n使用 `langchain` 的 `CharacterTextSplitter` 这是最简单的方法，它根据给定的字符序列进行拆分，默认为`\n\n`，chunk长度以字符数来衡量。&#39;,
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a> &#39;- 文本的分割方式：按单个字符分隔符。\n- 如何测量块大小：按字符数。\n- 要直接获取字符串内容，使用.split_text。\n- 要创建 LangChain Document对象（例如，用于下游任务），使用.create_documents。\n- 内部使用的是 `_splits = re.split(f&quot;({separator})&quot;, text)` 进行实现的&#39;]
</span></code></pre></div>
<h3 id="_4">按多字符递归分块</h3>
<p>文本分割器 <code>RecursiveCharacterTextSplitter</code> 是<strong>推荐用于通用文本的分割器</strong>，它会使用一个字符列表(默认列表为 <code>["\n\n", "\n", " ", ""]</code>)按顺序分割文本，直到块的大小达到指定长度。这样做的目的是尽可能地将所有段落（然后是句子，最后是单词）保持在一起，因为这些段落通常看起来是语义上最相关的文本片段。</p>
<ul>
<li>文本的拆分方式：按字符列表。</li>
<li>如何测量块大小：按字符数。</li>
</ul>
<p>下面我们展示示例用法。</p>
<ul>
<li>要直接获取字符串内容，请使用<code>.split_text</code>。</li>
<li>要创建 LangChain <code>Document</code>对象（例如，用于下游任务），请使用 <code>.create_documents</code>。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_text_splitters</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="s2">## 按多字符递归分块</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="s2">文本分割器 `RecursiveCharacterTextSplitter` 是**推荐用于通用文本的分割器**，它会使用一个字符列表(默认列表为`[&quot;</span><span class="se">\n\n</span><span class="s2">&quot;, &quot;</span><span class="se">\n</span><span class="s2">&quot;, &quot; &quot;, &quot;&quot;]`)按顺序分割文本，直到块的大小达到指定长度。这样做的目的是尽可能地将所有段落（然后是句子，最后是单词）保持在一起，因为这些段落通常看起来是语义上最相关的文本片段。</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="s2">- 文本的拆分方式：按字符列表。</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="s2">- 如何测量块大小：按字符数。</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="s2">下面我们展示示例用法。</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="s2">- 要直接获取字符串内容，请使用`.split_text`。</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="s2">- 要创建 LangChain `Document`对象（例如，用于下游任务），请使用 `.create_documents`。</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="c1"># Set a really small chunk size, just to show.</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>    <span class="n">length_function</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="n">is_separator_regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 默认为 False</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="p">)</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">create_documents</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="n">chunks</span>
</span></code></pre></div>
<p>输出结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>[Document(metadata={}, page_content=&#39;## 按多字符递归分块&#39;),
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a> Document(metadata={}, page_content=&#39;文本分割器 `RecursiveCharacterTextSplitter`&#39;),
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a> Document(metadata={}, page_content=&#39;是**推荐用于通用文本的分割器**，它会使用一个字符列表(默认列表为`[&quot;&#39;),
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a> Document(metadata={}, page_content=&#39;&quot;, &quot;&#39;),
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a> Document(metadata={}, page_content=&#39;&quot;, &quot; &quot;,&#39;),
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a> Document(metadata={}, page_content=&#39;&quot;&quot;]`)按顺序分割文本，直到块的大小达到指定长度。这样做的目的是尽可能地将所有段落（然后是句子，最后是单词）保持在一起，因为这些段落通常&#39;),
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a> Document(metadata={}, page_content=&#39;看起来是语义上最相关的文本片段。&#39;),
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a> Document(metadata={}, page_content=&#39;- 文本的拆分方式：按字符列表。\n- 如何测量块大小：按字符数。\n\n下面我们展示示例用法。&#39;),
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a> Document(metadata={}, page_content=&#39;- 要直接获取字符串内容，请使用`.split_text`。&#39;),
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a> Document(metadata={}, page_content=&#39;- 要创建 LangChain `Document`对象（例如，用于下游任务），请使用 `.create_documents`。&#39;)]
</span></code></pre></div>
<p>让我们来看看上面设置的参数：</p>
<ul>
<li><code>chunk_size</code>：块的最大大小，其中大小由决定 <code>length_function</code>。</li>
<li><code>chunk_overlap</code>：目标块之间的重叠。重叠块有助于减少上下文在块之间划分时的信息丢失。</li>
<li><code>length_function</code>：确定块大小的函数，默认为 <code>len</code>。</li>
<li><code>is_separator_regex</code>：分隔符列表（默认为["\n\n", "\n", " ", ""]）是否应解释为正则表达式。</li>
</ul>
<p>某些文字没有单词边界，例如中文、日语和泰语，使用默认分隔符列表拆分文本["\n\n", "\n", " ", ""]可能会导致单词被拆分成多个块。为了保持单词完整，可以覆盖分隔符列表以添加其他标点符号。</p>
<h4 id="_5">设置中文场景分隔符</h4>
<p>RecursiveCharacterTextSplitter的工作流程：它首先尝试用第一个分隔符分割文本，如果生成的块太大，就继续用下一个分隔符进行递归分割，直到所有块都符合大小要求。因此，分隔符的顺序很重要，应该从最自然的分隔符开始，比如段落分隔符，然后是句子分隔符，再是其他可能的符号。</p>
<p>中文常用的段落分隔符是两个换行符（\n\n），而句子通常以句号、问号、感叹号结尾，但中文的句号是“。”，不同于英文的“.”。因此，在separators中应该包含这些中文标点。另外，中文有时也会使用分号、逗号来分隔，但逗号分隔可能太细，导致分块过小，需要根据具体情况调整。</p>
<p>可能还需要考虑一些特殊情况，比如省略号“……”，或者顿号“、”，但这些可能不适合作为分隔符，因为分割得太细。此外，中文的引号如“”和‘’可能包围重要内容，分割时需要避免在这些位置拆分。</p>
<p>因此，合理的separators设置可能是先按段落分隔，再按句子分隔，然后按其他标点。例如：<code>["\n\n", "\n", "。", "！", "？", "；", "，"]</code>，但需要考虑分割后的块大小是否符合chunk_size的要求，如果使用太多分隔符，可能导致递归分割次数增加，影响效率。</p>
<p><strong>中文场景下的推荐设置</strong></p>
<p>默认的英文分隔符为 <code>["\n\n", "\n", " ", ""]</code>，但中文文本具有以下特点：</p>
<ul>
<li>无空格分词：中文词语间无空格分隔。</li>
<li>标点差异：中文使用全角标点（如 。！？），而非英文半角标点（如 .!?）。</li>
<li>段落结构：段落通常以换行符分隔。</li>
</ul>
<p>优化后的中文分隔符</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">separators</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>    <span class="c1"># 优先按段落切分（双换行符）</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>      <span class="c1"># 其次按单换行符切分</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="s2">&quot;。&quot;</span><span class="p">,</span>      <span class="c1"># 按句号切分</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="s2">&quot;！&quot;</span><span class="p">,</span>      <span class="c1"># 按感叹号切分</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="s2">&quot;？&quot;</span><span class="p">,</span>      <span class="c1"># 按问号切分</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="s2">&quot;；&quot;</span><span class="p">,</span>      <span class="c1"># 按分号切分</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="s2">&quot;，&quot;</span><span class="p">,</span>      <span class="c1"># 按逗号切分（慎用，可能过细）</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="s2">&quot;”&quot;</span><span class="p">,</span>       <span class="c1"># 按右引号切分（适配对话场景）</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="s2">&quot;…&quot;</span><span class="p">,</span>       <span class="c1"># 按省略号切分</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="s2">&quot;&quot;</span><span class="p">,</span>        <span class="c1"># 最后按字符切分（保底）</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="p">]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>          <span class="c1"># 目标块大小（单位：字符）</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>        <span class="c1"># 块间重叠字符数</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="n">separators</span><span class="o">=</span><span class="n">separators</span><span class="p">,</span>   <span class="c1"># 自定义中文分隔符</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="n">length_function</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span>     <span class="c1"># 长度计算函数（按字符数）</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="p">)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">create_documents</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="n">chunks</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>[Document(metadata={}, page_content=&#39;## 按多字符递归分块&#39;),
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a> Document(metadata={}, page_content=&#39;文本分割器 `RecursiveCharacterTextSplitter` 是**推荐用于通用文本的分割器**&#39;),
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a> Document(metadata={}, page_content=&#39;，它会使用一个字符列表(默认列表为`[&quot;&#39;),
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a> Document(metadata={}, page_content=&#39;&quot;, &quot;&#39;),
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a> Document(metadata={}, page_content=&#39;&quot;, &quot; &quot;, &quot;&quot;]`)按顺序分割文本，直到块的大小达到指定长度&#39;),
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a> Document(metadata={}, page_content=&#39;。这样做的目的是尽可能地将所有段落（然后是句子，最后是单词）保持在一起，因为这些段落通常看起来是语义上最相关的文本片段。&#39;),
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a> Document(metadata={}, page_content=&#39;- 文本的拆分方式：按字符列表。\n- 如何测量块大小：按字符数。\n\n下面我们展示示例用法。&#39;),
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a> Document(metadata={}, page_content=&#39;- 要直接获取字符串内容，请使用`.split_text`。&#39;),
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a> Document(metadata={}, page_content=&#39;- 要创建 LangChain `Document`对象（例如，用于下游任务），请使用 `.create_documents`。&#39;)]
</span></code></pre></div>
<h2 id="token">按 token 分块</h2>
<p>语言模型有 token 数量限制，我们在使用时不应超过该限制，因此在将文本拆分成块时，最好计算 token 的数量。tokenizer 有很多，计算文本中的 token 数量时，建议使用与语言模型中相同的tokenizer（在模型仓库中模型文件和 tokenizer 文件放在一起的）。</p>
<p>我们可以使用 tokenizer 来计算文本中的 token 长度，按照 token 切分的逻辑如下：</p>
<ul>
<li>文本的分割方式：按传入的字符。</li>
<li>如何测量块大小：通过 <code>len(tokenizer.tokenize(text))</code> 计算的 token 数。</li>
</ul>
<p>按 token 分块步骤：</p>
<ul>
<li>下载 tokenizer，因为在国内无法直接访问 HuggingFace，所以这里从 modelscope 中的模型仓库中下载，只需要下载 tokenizer 文件，不需要下载模型文件（<code>*.bin</code>, <code>*.safetensors</code>结尾的文件是模型文件）</li>
<li>使用 <code>AutoTokenizer.from_pretrained</code> 加载 tokenizer </li>
<li>使用 <code>TextSplitter.from_huggingface_tokenizer</code>方法指定 <code>tokenizer</code> 参数，其他参数与前面的相同</li>
</ul>
<h3 id="modelscope-tokenizer">从 modelscope 下载 tokenizer</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># 从 modelscope 下载 tokenizer</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">download_from_modelscope</span><span class="p">(</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>                             <span class="n">local_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>                             <span class="n">ignore_patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>                             <span class="o">**</span><span class="n">kwargs</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>                             <span class="p">):</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="sd">    从modelscope下载模型</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="sd">    如何没有指定local_dir，默认保存模型文件到 ~/.cache/modelscope/hub/models/ 文件夹中</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="sd">    modelscope 地址：https://modelscope.cn/models</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">modelscope.hub.snapshot_download</span><span class="w"> </span><span class="kn">import</span> <span class="n">snapshot_download</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;开始下载模型: </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>                                  <span class="n">local_dir</span><span class="o">=</span><span class="n">local_dir</span><span class="p">,</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>                                  <span class="n">ignore_patterns</span><span class="o">=</span><span class="n">ignore_patterns</span><span class="p">,</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;模型下载完成保存目录: </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>    <span class="k">return</span> <span class="n">model_dir</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="n">modelscope_args</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>    <span class="c1"># 可配置参数，查看：modelscope.hub.snapshot_download</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>    <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span><span class="p">,</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>    <span class="s2">&quot;ignore_patterns&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;*.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;*.safetensors&quot;</span><span class="p">],</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>    <span class="s2">&quot;local_dir&quot;</span><span class="p">:</span> <span class="s1">&#39;./Qwen2.5-72B-Instruct&#39;</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="p">}</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a><span class="n">model_dir</span> <span class="o">=</span> <span class="n">download_from_modelscope</span><span class="p">(</span><span class="o">**</span><span class="n">modelscope_args</span><span class="p">)</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>./Qwen2.5-72B-Instruct
</span></code></pre></div>
<h3 id="from_huggingface_tokenizer-token">使用 from_huggingface_tokenizer 方法按照token分块</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># 使用 `AutoTokenizer.from_pretrained` 加载 tokenizer </span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="c1"># 使用 `TextSplitter.from_huggingface_tokenizer`方法指定 `tokenizer` 参数，其他参数与前面的相同</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="s2">## 按多字符递归分块</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="s2">文本分割器 `RecursiveCharacterTextSplitter` 是**推荐用于通用文本的分割器**，它会使用一个字符列表(默认列表为`[&quot;</span><span class="se">\n\n</span><span class="s2">&quot;, &quot;</span><span class="se">\n</span><span class="s2">&quot;, &quot; &quot;, &quot;&quot;]`)按顺序分割文本，直到块的大小达到指定长度。这样做的目的是尽可能地将所有段落（然后是句子，最后是单词）保持在一起，因为这些段落通常看起来是语义上最相关的文本片段。</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="s2">- 文本的拆分方式：按字符列表。</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="s2">- 如何测量块大小：按字符数。</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="s2">下面我们展示示例用法。</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="s2">- 要直接获取字符串内容，请使用`.split_text`。</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="s2">- 要创建 LangChain `Document`对象（例如，用于下游任务），请使用 `.create_documents`。</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="o">.</span><span class="n">from_huggingface_tokenizer</span><span class="p">(</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>    <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>    <span class="c1"># separators=separators,</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="p">)</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">create_documents</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="n">chunks</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>[Document(metadata={}, page_content=&#39;## 按多字符递归分块\n\n文本分割器 `RecursiveCharacterTextSplitter` 是**推荐用于通用文本的分割器**，它会使用一个字符列表(默认列表为`[&quot;&#39;),
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a> Document(metadata={}, page_content=&#39;&quot;, &quot;\n&quot;, &quot; &quot;, &quot;&quot;]`)按顺序分割文本，直到块的大小达到指定长度。这样做的目的是尽可能地将所有段落（然后是句子，最后是单词）保持在一起，因为这些段落通常看起来是语义上最相关的文本片段。&#39;),
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a> Document(metadata={}, page_content=&#39;- 文本的拆分方式：按字符列表。\n- 如何测量块大小：按字符数。\n\n下面我们展示示例用法。\n\n- 要直接获取字符串内容，请使用`.split_text`。&#39;),
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a> Document(metadata={}, page_content=&#39;- 要创建 LangChain `Document`对象（例如，用于下游任务），请使用 `.create_documents`。&#39;)]
</span></code></pre></div>
<h2 id="token_1">字符分块和token分块对比</h2>
<p>从前面的结果对比可以看到，使用相同的 chunk_size，按照字符数和token数分块后，按字符分块的数量比按token分块的数量要多，原因如下：</p>
<p>token分块则是根据模型的分词器，比如BERT或GPT使用的WordPiece或BPE算法，将文本分成有意义的<strong>子词单元</strong>，也就是说一个token可能是一个词语，所以分块的数量更少。</p>
<p>以下是 <strong>字符分块</strong> 和 <strong>Token 分块</strong> 的核心区别总结：</p>
<hr />
<h3 id="1"><strong>1. 定义与原理</strong></h3>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>字符分块</strong></th>
<th><strong>Token 分块</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>分块单位</strong></td>
<td>按<strong>字符数</strong>切分（如每 200 个字符一个块）。</td>
<td>按模型分词器（Tokenizer）的 <strong>Token 数</strong> 切分（如每 256 tokens 一个块）。</td>
</tr>
<tr>
<td><strong>底层逻辑</strong></td>
<td>直接基于文本的物理长度切割，无语言语义分析。</td>
<td>依赖分词算法（如 BPE、WordPiece）将文本转换为有意义的子词单元。</td>
</tr>
<tr>
<td><strong>典型场景</strong></td>
<td>简单文本预处理、日志切割、多语言混合文本。</td>
<td>适配预训练模型（如 BERT、GPT）的输入限制，需与模型分词逻辑对齐。</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="2"><strong>2. 优缺点对比</strong></h3>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>字符分块</strong></th>
<th><strong>Token 分块</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>优点</strong></td>
<td>✅ 实现简单，无需依赖分词工具   ✅ 无视语言差异（如中文、阿拉伯文）</td>
<td>✅ 适配模型输入限制（如 GPT-4 的 8k tokens）   ✅ 保留词语完整性（如 <code>"ChatGPT"</code> 不被切分）</td>
</tr>
<tr>
<td><strong>缺点</strong></td>
<td>❌ 破坏语义单元（如切分词语/句子）   ❌ 无法适配模型需求</td>
<td>❌ 依赖分词器性能（如未登录词处理）   ❌ 不同模型分词结果不同（如 BERT vs GPT）</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="3"><strong>3. 示例对比</strong></h3>
<h4 id="_6"><strong>输入文本</strong></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>自然语言处理（NLP）是人工智能的核心领域之一。
</span></code></pre></div>
<h4 id="_7"><strong>分块结果</strong></h4>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>分块结果（假设块大小=10）</strong></th>
<th><strong>问题说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>字符分块</strong></td>
<td><code>["自然语言处理（NLP", "）是人工智能的核"]</code></td>
<td>切分词语（<code>NLP)</code> 被拆开）、破坏标点结构。</td>
</tr>
<tr>
<td><strong>Token 分块</strong></td>
<td><code>["自然", "语言", "处理", "（", "NLP", "）", "..."]</code> → 合并为有效块</td>
<td>保留完整词语，适配模型输入。</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="4"><strong>4. 适用场景</strong></h3>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>推荐场景</strong></th>
<th><strong>避免场景</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>字符分块</strong></td>
<td>- 日志文件切割   - 多语言混合文本快速处理   - 无模型依赖的简单任务</td>
<td>- 需语义连贯的任务（如问答、摘要）   - 适配预训练模型</td>
</tr>
<tr>
<td><strong>Token 分块</strong></td>
<td>- 预训练模型输入（如 BERT、GPT）   - 语义敏感任务（如机器翻译）   - 精确控制模型计算成本</td>
<td>- 无分词工具的简单系统</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="5"><strong>5. 关键差异总结</strong></h3>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>字符分块</strong></th>
<th><strong>Token 分块</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>语言适配性</strong></td>
<td>通用所有语言，但破坏语义</td>
<td>依赖分词器，适配特定语言（如中文需专用分词器）</td>
</tr>
<tr>
<td><strong>模型适配性</strong></td>
<td>与模型无关</td>
<td>需与模型的分词器对齐（如 GPT-3 用 BPE）</td>
</tr>
<tr>
<td><strong>计算效率</strong></td>
<td>高（直接切片）</td>
<td>中（需分词计算）</td>
</tr>
<tr>
<td><strong>语义保留能力</strong></td>
<td>低</td>
<td>高</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="6"><strong>6. 选择建议</strong></h3>
<ul>
<li><strong>优先 Token 分块</strong>：涉及预训练模型的任务（如 RAG、文本生成）。</li>
<li><strong>仅用字符分块</strong>：简单文本处理、多语言混合且无需语义保留的场景（如日志分析）。</li>
<li><strong>中文特别注意</strong>：  <ul>
<li>字符分块易破坏中文词语（如 <code>“人工智能”</code> → <code>“人工智 能”</code>）。  </li>
<li>Token 分块需使用中文分词器（如 <code>bert-base-chinese</code>）。</li>
</ul>
</li>
</ul>
<h2 id="_8">按照语义分块</h2>
<p><code>langchain</code> 的 <code>SemanticChunker</code> 语义分块是参考：<a href="https://github.com/FullStackRetrieval-com/RetrievalTutorials/blob/main/tutorials/LevelsOfTextSplitting/5_Levels_Of_Text_Splitting.ipynb">5_Levels_Of_Text_Splitting</a> 实现的。</p>
<p>要使用 <code>SemanticChunker</code> 需要使用如下命令安装 <code>langchain_experimental</code>:<br />
<code>pip install --quiet langchain_experimental</code></p>
<p>以下是基于语义相似度的分块实现思路总结，该方法通过 <strong>嵌入距离检测语义边界</strong> 实现智能分块：</p>
<hr />
<h3 id="_9"><strong>核心思路</strong></h3>
<ol>
<li><strong>分句处理</strong><br />
将原始文本按句子粒度拆分（如使用 <code>spaCy</code>、<code>nltk</code> 或标点规则）。</li>
<li><strong>滑动窗口聚合</strong><br />
将连续句子组成 <strong>窗口</strong>（如 3 个句子为一个窗口），计算窗口的嵌入表示。</li>
<li><strong>嵌入距离计算</strong><br />
滑动窗口逐步后移（如每次移除前一句，添加下一句），计算相邻窗口嵌入的相似度（如余弦距离）。</li>
<li><strong>断点检测</strong><br />
若相邻窗口的嵌入距离超过预设 <strong>阈值</strong>，则认为此处存在语义边界，触发分块。</li>
<li><strong>合并相邻块</strong><br />
将未触发断点的相邻窗口合并为同一块，保持语义连贯性。</li>
</ol>
<hr />
<h3 id="_10"><strong>具体步骤示例</strong></h3>
<h4 id="_11"><strong>输入文本</strong></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>句子1：深度学习是机器学习的分支。  
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>句子2：它通过神经网络模拟人脑的学习过程。  
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>句子3：常见的模型包括CNN和RNN。  
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>句子4：自然语言处理（NLP）是其重要应用领域。  
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>句子5：BERT和GPT是NLP中的代表性模型。  
</span></code></pre></div>
<h4 id="_12"><strong>分块过程</strong></h4>
<ol>
<li><strong>窗口生成</strong>  <ul>
<li>窗口1：[句子1, 句子2, 句子3]  </li>
<li>窗口2：[句子2, 句子3, 句子4]  </li>
<li>窗口3：[句子3, 句子4, 句子5]</li>
</ul>
</li>
<li><strong>嵌入计算</strong>  <ul>
<li>获取每个窗口的嵌入向量（如使用 Sentence-BERT）。</li>
</ul>
</li>
<li><strong>距离比较</strong>  <ul>
<li>计算窗口1与窗口2的嵌入距离 → 假设距离较小（主题连续：深度学习→模型）。  </li>
<li>计算窗口2与窗口3的嵌入距离 → 假设距离较大（主题切换：模型→NLP应用）。</li>
</ul>
</li>
<li><strong>断点触发</strong>  <ul>
<li>在窗口2与窗口3之间触发分块。</li>
</ul>
</li>
<li><strong>最终分块</strong>  <ul>
<li>块1：[句子1, 句子2, 句子3]  </li>
<li>块2：[句子4, 句子5]</li>
</ul>
</li>
</ol>
<hr />
<h3 id="_13"><strong>优点与缺点</strong></h3>
<table>
<thead>
<tr>
<th><strong>优点</strong></th>
<th><strong>缺点</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>✅ 自适应语义边界，避免机械切分</td>
<td>❌ 计算成本高（需多次嵌入计算和相似度比较）</td>
</tr>
<tr>
<td>✅ 减少噪声（窗口聚合降低单句波动影响）</td>
<td>❌ 依赖嵌入模型质量（如语义表示不准确则分块失效）</td>
</tr>
<tr>
<td>✅ 适配不同文本类型（技术文档、对话等）</td>
<td>❌ 参数敏感（需调优窗口大小、阈值）</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_14"><strong>关键参数与调优建议</strong></h3>
<ol>
<li><strong>窗口大小</strong>  <ul>
<li>过小：噪声敏感（如窗口=1时退化为单句比较）。  </li>
<li>过大：语义边界模糊（如窗口=5可能掩盖局部变化）。  </li>
<li><strong>建议值</strong>：2-4 个句子（根据文本密度调整）。</li>
</ul>
</li>
<li><strong>相似度阈值</strong>  <ul>
<li>过高：分块过少，块内语义混杂。  </li>
<li>过低：分块过多，破坏连贯性。  </li>
<li><strong>调优方法</strong>：通过验证集测试不同阈值下的分块质量（如人工评估或检索召回率）。</li>
</ul>
</li>
<li><strong>嵌入模型选择</strong>  <ul>
<li>优先领域适配模型（如技术文本用 <code>all-mpnet-base-v2</code>，通用文本用 <code>text-embedding-3-small</code>）。</li>
</ul>
</li>
</ol>
<hr />
<h3 id="_15"><strong>改进方向</strong></h3>
<ol>
<li><strong>动态窗口调整</strong><br />
根据文本复杂度自动扩展/收缩窗口（如密集段落用小窗口，冗余内容用大窗口）。  </li>
<li><strong>混合分块策略</strong><br />
先按标题/段落粗分块，再对长段落应用语义分块。  </li>
<li><strong>轻量化计算</strong>  <ul>
<li>使用低维嵌入（如 PCA 降维）。  </li>
<li>缓存嵌入结果减少重复计算。</li>
</ul>
</li>
</ol>
<hr />
<h3 id="_16"><strong>适用场景</strong></h3>
<ul>
<li><strong>技术文档</strong>：精准切分章节、案例、代码块。  </li>
<li><strong>长对话记录</strong>：按话题切换分割会话阶段。  </li>
<li><strong>跨段落推理任务</strong>：确保块内语义高度相关。</li>
</ul>
<p>通过该方法，可显著提升 RAG 等应用中检索内容的语义连贯性和相关性。</p>
<h2 id="_17">语义分块代码实现</h2>
<p>接下来使用 langchain 的 <code>SemanticChunker</code> 来演示语义分块代码实现。</p>
<h3 id="embedding">选择embedding模型</h3>
<p>要实例化 <code>SemanticChunker</code>，必须指定一个 embedding 模型。因为在国内无法直接从 huggingface 下载模型，所以这里选择从 modelscope 下载 embedding 模型。<br />
在 modelscope 的模型库中找到文本向量模型，我这里选择下载量和喜欢数最多的 embedding 模型 <code>iic/nlp_gte_sentence-embedding_chinese-large</code>。</p>
<h3 id="embedding_1">加载embedding模型</h3>
<p>在 modelscope 中查看 <code>iic/nlp_gte_sentence-embedding_chinese-large</code> 的模型介绍，可以知道它的使用方法，即可以通过简单ModelScope框架的Pipeline调用来使用GTE文本向量表示模型。ModelScope封装了统一的接口对外提供单句向量表示、双句文本相似度、多候选相似度计算功能。</p>
<p>在 <code>langchain_community</code> 中对 ModelScope 框架的 Pipeline 加载 embedding 模型进行了集成，使用 <code>from langchain_community.embeddings import ModelScopeEmbeddings</code> 即可，方便在langchain的技术体系使用。</p>
<p>接下来使用 <code>ModelScopeEmbeddings</code> 加载 embedding 模型。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.embeddings</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelScopeEmbeddings</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c1"># 因为语义分块是按照语义相似度进行分块的，所以需要一个计算语义相似度的 embedding 模型。</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="n">model_id</span> <span class="o">=</span> <span class="s2">&quot;iic/nlp_gte_sentence-embedding_chinese-large&quot;</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">embed</span> <span class="o">=</span> <span class="n">ModelScopeEmbeddings</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">embed</span><span class="p">)</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="n">embedding</span> <span class="o">=</span> <span class="n">embed</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="s1">&#39;测试embedding&#39;</span><span class="p">)</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="nb">len</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>2025-05-22 10:15:44,137 - modelscope - WARNING - Model revision not specified, use revision: v1.1.0
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>2025-05-22 10:15:45,588 - modelscope - WARNING - Model revision not specified, use revision: v1.1.0
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>Downloading Model from https://www.modelscope.cn to directory: /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>2025-05-22 10:15:45,800 - modelscope - INFO - initiate model from /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>2025-05-22 10:15:45,802 - modelscope - INFO - initiate model from location /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large.
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>2025-05-22 10:15:45,818 - modelscope - INFO - initialize model from /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>2025-05-22 10:15:49,278 - modelscope - WARNING - No preprocessor field found in cfg.
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>2025-05-22 10:15:49,278 - modelscope - WARNING - No val key and type key found in preprocessor domain of configuration.json file.
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>2025-05-22 10:15:49,278 - modelscope - WARNING - Cannot find available config to build preprocessor at mode inference, current config: {&#39;model_dir&#39;: &#39;/Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large&#39;}. trying to build by task and model information.
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>2025-05-22 10:15:49,309 - modelscope - INFO - cuda is not available, using cpu instead.
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>2025-05-22 10:15:49,311 - modelscope - WARNING - No preprocessor field found in cfg.
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>2025-05-22 10:15:49,312 - modelscope - WARNING - No val key and type key found in preprocessor domain of configuration.json file.
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>2025-05-22 10:15:49,312 - modelscope - WARNING - Cannot find available config to build preprocessor at mode inference, current config: {&#39;model_dir&#39;: &#39;/Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large&#39;, &#39;sequence_length&#39;: 128}. trying to build by task and model information.
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>embed=&lt;modelscope.pipelines.nlp.sentence_embedding_pipeline.SentenceEmbeddingPipeline object at 0x1766e5d60&gt; model_id=&#39;iic/nlp_gte_sentence-embedding_chinese-large&#39; model_revision=None
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>1024
</span></code></pre></div>
<blockquote>
<p>注意⚠️： 在使用 langchain_community 实现的 ModelScopeEmbeddings 时，从前面的 WARNING 内容中可以看到，embedding模型默认最长文本长度为128<code>'sequence_length': 128</code>，并且无法修改。
</p>
</blockquote>
<p>为了允许接受更长的文本，下面将 ModelScopeEmbeddings 的实现进行重写，添加了 sequence_length 设置参数，代码实现如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.embeddings</span><span class="w"> </span><span class="kn">import</span> <span class="n">Embeddings</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ConfigDict</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">ModelScopeEmbeddings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">Embeddings</span><span class="p">):</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ModelScopeHub embedding models.</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="sd">    To use, you should have the ``modelscope`` python package installed.</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="sd">    Example:</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="sd">        .. code-block:: python</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="sd">            from langchain_community.embeddings import ModelScopeEmbeddings</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="sd">            model_id = &quot;damo/nlp_corom_sentence-embedding_english-base&quot;</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="sd">            embed = ModelScopeEmbeddings(model_id=model_id, model_revision=&quot;v1.0.0&quot;)</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>    <span class="n">embed</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;damo/nlp_corom_sentence-embedding_english-base&quot;</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Model name to use.&quot;&quot;&quot;</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>    <span class="n">model_revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>    <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span> <span class="c1"># sequence_length 代表最大文本长度</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the modelscope&quot;&quot;&quot;</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">modelscope.pipelines</span><span class="w"> </span><span class="kn">import</span> <span class="n">pipeline</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">modelscope.utils.constant</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tasks</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>                <span class="s2">&quot;Could not import some python packages.&quot;</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>                <span class="s2">&quot;Please install it with `pip install modelscope`.&quot;</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>            <span class="n">Tasks</span><span class="o">.</span><span class="n">sentence_embedding</span><span class="p">,</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>            <span class="n">model_revision</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_revision</span><span class="p">,</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>            <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>        <span class="p">)</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">,</span> <span class="n">protected_namespaces</span><span class="o">=</span><span class="p">())</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute doc embeddings using a modelscope embedding model.</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a><span class="sd">        Args:</span>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a><span class="sd">            texts: The list of texts to embed.</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a><span class="sd">        Returns:</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a><span class="sd">            List of embeddings, one for each text.</span>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-20-55"><a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a>        <span class="n">texts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="n">texts</span><span class="p">))</span>
</span><span id="__span-20-56"><a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source_sentence&quot;</span><span class="p">:</span> <span class="n">texts</span><span class="p">}</span>
</span><span id="__span-20-57"><a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">inputs</span><span class="p">)[</span><span class="s2">&quot;text_embedding&quot;</span><span class="p">]</span>
</span><span id="__span-20-58"><a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a>        <span class="k">return</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="__span-20-59"><a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a>
</span><span id="__span-20-60"><a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">embed_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="__span-20-61"><a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute query embeddings using a modelscope embedding model.</span>
</span><span id="__span-20-62"><a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a>
</span><span id="__span-20-63"><a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a><span class="sd">        Args:</span>
</span><span id="__span-20-64"><a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a><span class="sd">            text: The text to embed.</span>
</span><span id="__span-20-65"><a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a>
</span><span id="__span-20-66"><a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a><span class="sd">        Returns:</span>
</span><span id="__span-20-67"><a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a><span class="sd">            Embeddings for the text.</span>
</span><span id="__span-20-68"><a id="__codelineno-20-68" name="__codelineno-20-68" href="#__codelineno-20-68"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-20-69"><a id="__codelineno-20-69" name="__codelineno-20-69" href="#__codelineno-20-69"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="__span-20-70"><a id="__codelineno-20-70" name="__codelineno-20-70" href="#__codelineno-20-70"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source_sentence&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">text</span><span class="p">]}</span>
</span><span id="__span-20-71"><a id="__codelineno-20-71" name="__codelineno-20-71" href="#__codelineno-20-71"></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">inputs</span><span class="p">)[</span><span class="s2">&quot;text_embedding&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-20-72"><a id="__codelineno-20-72" name="__codelineno-20-72" href="#__codelineno-20-72"></a>        <span class="k">return</span> <span class="n">embedding</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="__span-20-73"><a id="__codelineno-20-73" name="__codelineno-20-73" href="#__codelineno-20-73"></a>
</span><span id="__span-20-74"><a id="__codelineno-20-74" name="__codelineno-20-74" href="#__codelineno-20-74"></a>
</span><span id="__span-20-75"><a id="__codelineno-20-75" name="__codelineno-20-75" href="#__codelineno-20-75"></a><span class="n">model_id</span> <span class="o">=</span> <span class="s2">&quot;iic/nlp_gte_sentence-embedding_chinese-large&quot;</span>
</span><span id="__span-20-76"><a id="__codelineno-20-76" name="__codelineno-20-76" href="#__codelineno-20-76"></a><span class="n">embed</span> <span class="o">=</span> <span class="n">ModelScopeEmbeddings</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
</span><span id="__span-20-77"><a id="__codelineno-20-77" name="__codelineno-20-77" href="#__codelineno-20-77"></a><span class="nb">print</span><span class="p">(</span><span class="n">embed</span><span class="p">)</span>
</span><span id="__span-20-78"><a id="__codelineno-20-78" name="__codelineno-20-78" href="#__codelineno-20-78"></a><span class="n">embedding</span> <span class="o">=</span> <span class="n">embed</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="s1">&#39;测试embedding&#39;</span><span class="p">)</span>
</span><span id="__span-20-79"><a id="__codelineno-20-79" name="__codelineno-20-79" href="#__codelineno-20-79"></a><span class="nb">len</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>2025-05-22 10:21:51,892 - modelscope - WARNING - Model revision not specified, use revision: v1.1.0
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>2025-05-22 10:21:53,263 - modelscope - WARNING - Model revision not specified, use revision: v1.1.0
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>Downloading Model from https://www.modelscope.cn to directory: /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>2025-05-22 10:21:53,541 - modelscope - INFO - initiate model from /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>2025-05-22 10:21:53,543 - modelscope - INFO - initiate model from location /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large.
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>2025-05-22 10:21:53,562 - modelscope - INFO - initialize model from /Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>2025-05-22 10:21:56,991 - modelscope - WARNING - No preprocessor field found in cfg.
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>2025-05-22 10:21:56,991 - modelscope - WARNING - No val key and type key found in preprocessor domain of configuration.json file.
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>2025-05-22 10:21:56,992 - modelscope - WARNING - Cannot find available config to build preprocessor at mode inference, current config: {&#39;model_dir&#39;: &#39;/Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large&#39;}. trying to build by task and model information.
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>2025-05-22 10:21:57,014 - modelscope - INFO - cuda is not available, using cpu instead.
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>2025-05-22 10:21:57,018 - modelscope - WARNING - No preprocessor field found in cfg.
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>2025-05-22 10:21:57,019 - modelscope - WARNING - No val key and type key found in preprocessor domain of configuration.json file.
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>2025-05-22 10:21:57,019 - modelscope - WARNING - Cannot find available config to build preprocessor at mode inference, current config: {&#39;model_dir&#39;: &#39;/Users/xiniao/.cache/modelscope/hub/models/iic/nlp_gte_sentence-embedding_chinese-large&#39;, &#39;sequence_length&#39;: 1024}. trying to build by task and model information.
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>embed=&lt;modelscope.pipelines.nlp.sentence_embedding_pipeline.SentenceEmbeddingPipeline object at 0x1766e44a0&gt; model_id=&#39;iic/nlp_gte_sentence-embedding_chinese-large&#39; model_revision=None sequence_length=1024
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>1024
</span></code></pre></div>
<h3 id="semanticchunker">使用 SemanticChunker</h3>
<p>要实例化SemanticChunker，必须指定一个Embeddings实例。</p>
<p>语义分块器的工作原理是确定何时“拆分”句子，具体方法是查找任意两个句子之间嵌入的差异，当差异超过某个阈值时，句子就会被拆分。</p>
<p><code>SemanticChunker</code> 默认句子拆分的逻辑是将文章按默认的 '.', '?', 和 '!' 进行分割，默认参数为：<code>sentence_split_regex: str = r"(?&lt;=[.?!])\s+"</code></p>
<p>有几种可以用来计算相似度的方法和阈值，这些方法由参数 <code>breakpoint_threshold_type</code> 控制。</p>
<ul>
<li>percentile: 百分位数，默认 95，该参数的取值范围为 0.0 到 100.0 之间，可以使用 <code>breakpoint_threshold_amount</code> 调整取值（默认类型）。</li>
<li>standard_deviation：标准差，默认 3，可以使用 <code>breakpoint_threshold_amount</code> 调整取值。</li>
<li>interquartile：四分位数，默认 1.5，可以使用 <code>breakpoint_threshold_amount</code> 调整取值。</li>
<li>gradient：梯度，默认 95，可以使用 <code>breakpoint_threshold_amount</code> 调整取值。</li>
</ul>
<p>注意：如果生成的块大小太小/太大，可以使用 min_chunk_size 进行调整。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">BreakpointThresholdType</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="s2">&quot;percentile&quot;</span><span class="p">,</span> <span class="s2">&quot;standard_deviation&quot;</span><span class="p">,</span> <span class="s2">&quot;interquartile&quot;</span><span class="p">,</span> <span class="s2">&quot;gradient&quot;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="p">]</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">BREAKPOINT_DEFAULTS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">BreakpointThresholdType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="s2">&quot;percentile&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="s2">&quot;standard_deviation&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="s2">&quot;interquartile&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="s2">&quot;gradient&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>接下来使用 SemanticChunker 进行文本语义分块</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_experimental.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">SemanticChunker</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="s2">要实例化SemanticChunker，必须指定一个Embeddings实例。</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="s2">语义分块器的工作原理是确定何时“拆分”句子，具体方法是查找任意两个句子之间嵌入的差异，当差异超过某个阈值时，句子就会被拆分。</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="s2">有几种方法可以确定该阈值，这些方法由参数 breakpoint_threshold_type 控制。</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="s2">percentile: 百分位数，默认 95，该参数的取值范围为 0.0 到 100.0 之间，可以使用 breakpoint_threshold_amount 调整取值（默认类型）。</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="s2">standard_deviation：标准差，默认 3，可以使用 breakpoint_threshold_amount 调整取值。</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="s2">interquartile：四分位数，默认 1.5，可以使用 breakpoint_threshold_amount 调整取值。</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="s2">gradient：梯度，默认 95，可以使用 breakpoint_threshold_amount 调整取值。</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="s2">注意：如果生成的块大小太小/太大，可以使用 min_chunk_size 进行调整。</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">SemanticChunker</span><span class="p">(</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>    <span class="n">embeddings</span><span class="o">=</span><span class="n">embed</span><span class="p">,</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    <span class="n">breakpoint_threshold_type</span><span class="o">=</span><span class="s1">&#39;percentile&#39;</span><span class="p">,</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>    <span class="n">breakpoint_threshold_amount</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>    <span class="n">sentence_split_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(?&lt;=[。？！])\s+&quot;</span> <span class="c1"># 自定义句子切分正则表达式，内部使用 re.split(self.sentence_split_regex, text) 切分句子</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="p">)</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="n">docs</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">create_documents</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="nb">print</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;分块数量：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>[Document(metadata={}, page_content=&#39;\n要实例化SemanticChunker，必须指定一个Embeddings实例。 语义分块器的工作原理是确定何时“拆分”句子，具体方法是查找任意两个句子之间嵌入的差异，当差异超过某个阈值时，句子就会被拆分。 有几种方法可以确定该阈值，这些方法由参数 breakpoint_threshold_type 控制。&#39;), Document(metadata={}, page_content=&#39;percentile: 百分位数，默认 95，该参数的取值范围为 0.0 到 100.0 之间，可以使用 breakpoint_threshold_amount 调整取值（默认类型）。 standard_deviation：标准差，默认 3，可以使用 breakpoint_threshold_amount 调整取值。 interquartile：四分位数，默认 1.5，可以使用 breakpoint_threshold_amount 调整取值。 gradient：梯度，默认 95，可以使用 breakpoint_threshold_amount 调整取值。 注意：如果生成的块大小太小/太大，可以使用 min_chunk_size 进行调整。 &#39;)]
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>分块数量：2
</span></code></pre></div>
<p>调整句子断点的阈值 <code>breakpoint_threshold_amount=50</code>，测试分块的效果如下：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">SemanticChunker</span><span class="p">(</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="n">embeddings</span><span class="o">=</span><span class="n">embed</span><span class="p">,</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="n">breakpoint_threshold_type</span><span class="o">=</span><span class="s1">&#39;percentile&#39;</span><span class="p">,</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="n">breakpoint_threshold_amount</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="n">sentence_split_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(?&lt;=[。？！])\s+&quot;</span> <span class="c1"># 自定义句子切分正则表达式，内部使用 re.split(self.sentence_split_regex, text) 切分句子</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="p">)</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="n">docs</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">create_documents</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="nb">print</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;分块数量：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>[Document(metadata={}, page_content=&#39;\n要实例化SemanticChunker，必须指定一个Embeddings实例。 语义分块器的工作原理是确定何时“拆分”句子，具体方法是查找任意两个句子之间嵌入的差异，当差异超过某个阈值时，句子就会被拆分。 有几种方法可以确定该阈值，这些方法由参数 breakpoint_threshold_type 控制。&#39;), Document(metadata={}, page_content=&#39;percentile: 百分位数，默认 95，该参数的取值范围为 0.0 到 100.0 之间，可以使用 breakpoint_threshold_amount 调整取值（默认类型）。 standard_deviation：标准差，默认 3，可以使用 breakpoint_threshold_amount 调整取值。&#39;), Document(metadata={}, page_content=&#39;interquartile：四分位数，默认 1.5，可以使用 breakpoint_threshold_amount 调整取值。&#39;), Document(metadata={}, page_content=&#39;gradient：梯度，默认 95，可以使用 breakpoint_threshold_amount 调整取值。 注意：如果生成的块大小太小/太大，可以使用 min_chunk_size 进行调整。&#39;), Document(metadata={}, page_content=&#39;&#39;)]
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>分块数量：5
</span></code></pre></div>
<blockquote>
<p>其他几种计算相似度的方法和阈值不在这里演示，有兴趣的可以尝试修改 <code>breakpoint_threshold_type</code> 和 h<code>breakpoint_threshold_amount</code> 进行测试
</p>
</blockquote>
<h2 id="markdown">按标题拆分 Markdown</h2>
<h3 id="markdownheadertextsplitter">使用 MarkdownHeaderTextSplitter</h3>
<p><code>MarkdownHeaderTextSplitter</code> 类的作用是根据指定的Markdown标题（headers）来分割Markdown文档。它能够识别并利用文档中的标题结构，将内容按照这些标题进行分组或分割，从而生成包含特定标题下内容的块。每个块不仅包含了该标题下的文本内容，还保留了与该内容相关的元数据，如标题层级和标题名称。</p>
<p>具体来说，<code>MarkdownHeaderTextSplitter</code> 的主要功能包括：</p>
<ol>
<li>识别标题：根据提供的标题标识符（例如 #, ## 等），识别出Markdown文档中的各个标题。</li>
<li>分组内容：将每个标题下的内容作为一个独立的块进行分组，确保每个块的内容都与其标题紧密相关。</li>
<li>保留元数据：在生成的每个块中，保留与该块内容相关的元数据，如标题的层级和名称，以便后续处理时能够更好地理解内容的上下文。</li>
</ol>
<p>通过这种方式，<code>MarkdownHeaderTextSplitter</code> 能够帮助用户更有效地管理和处理 <code>Markdown</code> 文档，特别是在需要对文档进行嵌入、存储和检索等操作时，能够更好地保持内容的结构和语义完整性。这对于构建高效的知识库、问答系统和其他基于文本的应用非常有帮助。</p>
<blockquote>
<p>如何将 pdf 和 docx 文件转换为 markdown 格式文件，可以查看我前面写的文章
</p>
</blockquote>
<p>详细使用示例查看 <a href="https://python.langchain.com/docs/how_to/markdown_header_metadata_splitter/">How to split Markdown by Headers</a></p>
<p>下面是一个使用 markdown 文本进行分块的示例。</p>
<p>示例文本：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="s2">以下是基于语义相似度的分块实现思路总结，该方法通过 **嵌入距离检测语义边界** 实现智能分块：</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="s2">---</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="s2">### **核心思路**</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="s2">1. **分句处理**  </span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="s2">   将原始文本按句子粒度拆分（如使用 `spaCy`、`nltk` 或标点规则）。</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="s2">2. **滑动窗口聚合**  </span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="s2">   将连续句子组成 **窗口**（如 3 个句子为一个窗口），计算窗口的嵌入表示。</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="s2">3. **嵌入距离计算**  </span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="s2">   滑动窗口逐步后移（如每次移除前一句，添加下一句），计算相邻窗口嵌入的相似度（如余弦距离）。</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="s2">4. **断点检测**  </span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="s2">   若相邻窗口的嵌入距离超过预设 **阈值**，则认为此处存在语义边界，触发分块。</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="s2">5. **合并相邻块**  </span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="s2">   将未触发断点的相邻窗口合并为同一块，保持语义连贯性。</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="s2">---</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="s2">### **具体步骤示例**</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="s2">#### **输入文本**</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="s2">句子1：深度学习是机器学习的分支。</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="s2">句子2：它通过神经网络模拟人脑的学习过程。</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="s2">句子3：常见的模型包括CNN和RNN。</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="s2">句子4：自然语言处理（NLP）是其重要应用领域。</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="s2">句子5：BERT和GPT是NLP中的代表性模型。  </span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="s2">#### **分块过程**</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="s2">1. **窗口生成**  </span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="s2">   - 窗口1：[句子1, 句子2, 句子3]  </span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="s2">   - 窗口2：[句子2, 句子3, 句子4]  </span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="s2">   - 窗口3：[句子3, 句子4, 句子5]  </span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="s2">2. **嵌入计算**  </span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="s2">   - 获取每个窗口的嵌入向量（如使用 Sentence-BERT）。  </span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="s2">3. **距离比较**  </span>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="s2">   - 计算窗口1与窗口2的嵌入距离 → 假设距离较小（主题连续：深度学习→模型）。  </span>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="s2">   - 计算窗口2与窗口3的嵌入距离 → 假设距离较大（主题切换：模型→NLP应用）。  </span>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="s2">4. **断点触发**  </span>
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="s2">   - 在窗口2与窗口3之间触发分块。  </span>
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="s2">5. **最终分块**  </span>
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a><span class="s2">   - 块1：[句子1, 句子2, 句子3]  </span>
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a><span class="s2">   - 块2：[句子4, 句子5]</span>
</span><span id="__span-27-43"><a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>
</span><span id="__span-27-44"><a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a><span class="s2">---</span>
</span><span id="__span-27-45"><a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a>
</span><span id="__span-27-46"><a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a><span class="s2">### **优点与缺点**</span>
</span><span id="__span-27-47"><a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a><span class="s2">| **优点**                                      | **缺点**                                      |</span>
</span><span id="__span-27-48"><a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a><span class="s2">|----------------------------------------------|----------------------------------------------|</span>
</span><span id="__span-27-49"><a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a><span class="s2">| ✅ 自适应语义边界，避免机械切分                 | ❌ 计算成本高（需多次嵌入计算和相似度比较）     |</span>
</span><span id="__span-27-50"><a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a><span class="s2">| ✅ 减少噪声（窗口聚合降低单句波动影响）          | ❌ 依赖嵌入模型质量（如语义表示不准确则分块失效）|</span>
</span><span id="__span-27-51"><a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a><span class="s2">| ✅ 适配不同文本类型（技术文档、对话等）          | ❌ 参数敏感（需调优窗口大小、阈值）             |</span>
</span><span id="__span-27-52"><a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>
</span><span id="__span-27-53"><a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a><span class="s2">---</span>
</span><span id="__span-27-54"><a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a>
</span><span id="__span-27-55"><a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a><span class="s2">### **关键参数与调优建议**</span>
</span><span id="__span-27-56"><a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a><span class="s2">1. **窗口大小**  </span>
</span><span id="__span-27-57"><a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a><span class="s2">   - 过小：噪声敏感（如窗口=1时退化为单句比较）。  </span>
</span><span id="__span-27-58"><a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a><span class="s2">   - 过大：语义边界模糊（如窗口=5可能掩盖局部变化）。  </span>
</span><span id="__span-27-59"><a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a><span class="s2">   - **建议值**：2-4 个句子（根据文本密度调整）。  </span>
</span><span id="__span-27-60"><a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a><span class="s2">2. **相似度阈值**  </span>
</span><span id="__span-27-61"><a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a><span class="s2">   - 过高：分块过少，块内语义混杂。  </span>
</span><span id="__span-27-62"><a id="__codelineno-27-62" name="__codelineno-27-62" href="#__codelineno-27-62"></a><span class="s2">   - 过低：分块过多，破坏连贯性。  </span>
</span><span id="__span-27-63"><a id="__codelineno-27-63" name="__codelineno-27-63" href="#__codelineno-27-63"></a><span class="s2">   - **调优方法**：通过验证集测试不同阈值下的分块质量（如人工评估或检索召回率）。  </span>
</span><span id="__span-27-64"><a id="__codelineno-27-64" name="__codelineno-27-64" href="#__codelineno-27-64"></a><span class="s2">3. **嵌入模型选择**  </span>
</span><span id="__span-27-65"><a id="__codelineno-27-65" name="__codelineno-27-65" href="#__codelineno-27-65"></a><span class="s2">   - 优先领域适配模型（如技术文本用 `all-mpnet-base-v2`，通用文本用 `text-embedding-3-small`）。</span>
</span><span id="__span-27-66"><a id="__codelineno-27-66" name="__codelineno-27-66" href="#__codelineno-27-66"></a>
</span><span id="__span-27-67"><a id="__codelineno-27-67" name="__codelineno-27-67" href="#__codelineno-27-67"></a><span class="s2">---</span>
</span><span id="__span-27-68"><a id="__codelineno-27-68" name="__codelineno-27-68" href="#__codelineno-27-68"></a>
</span><span id="__span-27-69"><a id="__codelineno-27-69" name="__codelineno-27-69" href="#__codelineno-27-69"></a><span class="s2">### **改进方向**</span>
</span><span id="__span-27-70"><a id="__codelineno-27-70" name="__codelineno-27-70" href="#__codelineno-27-70"></a><span class="s2">1. **动态窗口调整**  </span>
</span><span id="__span-27-71"><a id="__codelineno-27-71" name="__codelineno-27-71" href="#__codelineno-27-71"></a><span class="s2">   根据文本复杂度自动扩展/收缩窗口（如密集段落用小窗口，冗余内容用大窗口）。  </span>
</span><span id="__span-27-72"><a id="__codelineno-27-72" name="__codelineno-27-72" href="#__codelineno-27-72"></a><span class="s2">2. **混合分块策略**  </span>
</span><span id="__span-27-73"><a id="__codelineno-27-73" name="__codelineno-27-73" href="#__codelineno-27-73"></a><span class="s2">   先按标题/段落粗分块，再对长段落应用语义分块。  </span>
</span><span id="__span-27-74"><a id="__codelineno-27-74" name="__codelineno-27-74" href="#__codelineno-27-74"></a><span class="s2">3. **轻量化计算**  </span>
</span><span id="__span-27-75"><a id="__codelineno-27-75" name="__codelineno-27-75" href="#__codelineno-27-75"></a><span class="s2">   - 使用低维嵌入（如 PCA 降维）。  </span>
</span><span id="__span-27-76"><a id="__codelineno-27-76" name="__codelineno-27-76" href="#__codelineno-27-76"></a><span class="s2">   - 缓存嵌入结果减少重复计算。  </span>
</span><span id="__span-27-77"><a id="__codelineno-27-77" name="__codelineno-27-77" href="#__codelineno-27-77"></a>
</span><span id="__span-27-78"><a id="__codelineno-27-78" name="__codelineno-27-78" href="#__codelineno-27-78"></a><span class="s2">---</span>
</span><span id="__span-27-79"><a id="__codelineno-27-79" name="__codelineno-27-79" href="#__codelineno-27-79"></a>
</span><span id="__span-27-80"><a id="__codelineno-27-80" name="__codelineno-27-80" href="#__codelineno-27-80"></a><span class="s2">### **适用场景**</span>
</span><span id="__span-27-81"><a id="__codelineno-27-81" name="__codelineno-27-81" href="#__codelineno-27-81"></a><span class="s2">- **技术文档**：精准切分章节、案例、代码块。  </span>
</span><span id="__span-27-82"><a id="__codelineno-27-82" name="__codelineno-27-82" href="#__codelineno-27-82"></a><span class="s2">- **长对话记录**：按话题切换分割会话阶段。  </span>
</span><span id="__span-27-83"><a id="__codelineno-27-83" name="__codelineno-27-83" href="#__codelineno-27-83"></a><span class="s2">- **跨段落推理任务**：确保块内语义高度相关。  </span>
</span><span id="__span-27-84"><a id="__codelineno-27-84" name="__codelineno-27-84" href="#__codelineno-27-84"></a>
</span><span id="__span-27-85"><a id="__codelineno-27-85" name="__codelineno-27-85" href="#__codelineno-27-85"></a><span class="s2">通过该方法，可显著提升 RAG 等应用中检索内容的语义连贯性和相关性。</span>
</span><span id="__span-27-86"><a id="__codelineno-27-86" name="__codelineno-27-86" href="#__codelineno-27-86"></a><span class="s2">&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>分块代码：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_text_splitters</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarkdownHeaderTextSplitter</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">markdown_splitter_by_header</span><span class="p">(</span><span class="n">markdown_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>    <span class="n">headers_to_split_on</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>        <span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Header 1&quot;</span><span class="p">),</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>        <span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">,</span> <span class="s2">&quot;Header 2&quot;</span><span class="p">),</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>        <span class="p">(</span><span class="s2">&quot;###&quot;</span><span class="p">,</span> <span class="s2">&quot;Header 3&quot;</span><span class="p">),</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>        <span class="p">(</span><span class="s2">&quot;####&quot;</span><span class="p">,</span> <span class="s2">&quot;Header 4&quot;</span><span class="p">),</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>        <span class="p">(</span><span class="s2">&quot;#####&quot;</span><span class="p">,</span> <span class="s2">&quot;Header 5&quot;</span><span class="p">),</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>        <span class="p">(</span><span class="s2">&quot;######&quot;</span><span class="p">,</span> <span class="s2">&quot;Header 6&quot;</span><span class="p">),</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>        <span class="p">(</span><span class="s2">&quot;#######&quot;</span><span class="p">,</span> <span class="s2">&quot;Header 7&quot;</span><span class="p">),</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>    <span class="p">]</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>    <span class="c1"># MD splits</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>    <span class="n">markdown_splitter</span> <span class="o">=</span> <span class="n">MarkdownHeaderTextSplitter</span><span class="p">(</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>        <span class="n">headers_to_split_on</span><span class="o">=</span><span class="n">headers_to_split_on</span><span class="p">,</span>  <span class="c1"># 分块的标题级别</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>        <span class="n">strip_headers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 是否去除content中的标题</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>        <span class="n">return_each_line</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># 是否返回单独行，也就是每一个单独行作为一个分块</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>    <span class="p">)</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>    <span class="n">md_header_splits</span> <span class="o">=</span> <span class="n">markdown_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">markdown_content</span><span class="p">)</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>    <span class="k">return</span> <span class="n">md_header_splits</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="n">chunks</span> <span class="o">=</span> <span class="n">markdown_splitter_by_header</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a>    <span class="n">chunk_dict</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>    <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">chunk_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
</span></code></pre></div>
<p>输出结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>{
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>    &quot;id&quot;: null,
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>    &quot;metadata&quot;: {},
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>    &quot;page_content&quot;: &quot;以下是基于语义相似度的分块实现思路总结，该方法通过 **嵌入距离检测语义边界** 实现智能分块：  \n---&quot;,
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>}
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>{
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    &quot;id&quot;: null,
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>    &quot;metadata&quot;: {
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>        &quot;Header 3&quot;: &quot;**核心思路**&quot;
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>    },
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>    &quot;page_content&quot;: &quot;### **核心思路**\n1. **分句处理**\n将原始文本按句子粒度拆分（如使用 `spaCy`、`nltk` 或标点规则）。\n2. **滑动窗口聚合**\n将连续句子组成 **窗口**（如 3 个句子为一个窗口），计算窗口的嵌入表示。\n3. **嵌入距离计算**\n滑动窗口逐步后移（如每次移除前一句，添加下一句），计算相邻窗口嵌入的相似度（如余弦距离）。\n4. **断点检测**\n若相邻窗口的嵌入距离超过预设 **阈值**，则认为此处存在语义边界，触发分块。\n5. **合并相邻块**\n将未触发断点的相邻窗口合并为同一块，保持语义连贯性。  \n---&quot;,
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>}
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>{
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>    &quot;id&quot;: null,
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>    &quot;metadata&quot;: {
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>        &quot;Header 3&quot;: &quot;**具体步骤示例**&quot;,
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>        &quot;Header 4&quot;: &quot;**输入文本**&quot;
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>    },
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>    &quot;page_content&quot;: &quot;### **具体步骤示例**  \n#### **输入文本**\n```\n句子1：深度学习是机器学习的分支。\n句子2：它通过神经网络模拟人脑的学习过程。\n句子3：常见的模型包括CNN和RNN。\n句子4：自然语言处理（NLP）是其重要应用领域。\n句子5：BERT和GPT是NLP中的代表性模型。\n```&quot;,
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a>}
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a>{
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a>    &quot;id&quot;: null,
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a>    &quot;metadata&quot;: {
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a>        &quot;Header 3&quot;: &quot;**具体步骤示例**&quot;,
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a>        &quot;Header 4&quot;: &quot;**分块过程**&quot;
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a>    },
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a>    &quot;page_content&quot;: &quot;#### **分块过程**\n1. **窗口生成**\n- 窗口1：[句子1, 句子2, 句子3]\n- 窗口2：[句子2, 句子3, 句子4]\n- 窗口3：[句子3, 句子4, 句子5]\n2. **嵌入计算**\n- 获取每个窗口的嵌入向量（如使用 Sentence-BERT）。\n3. **距离比较**\n- 计算窗口1与窗口2的嵌入距离 → 假设距离较小（主题连续：深度学习→模型）。\n- 计算窗口2与窗口3的嵌入距离 → 假设距离较大（主题切换：模型→NLP应用）。\n4. **断点触发**\n- 在窗口2与窗口3之间触发分块。\n5. **最终分块**\n- 块1：[句子1, 句子2, 句子3]\n- 块2：[句子4, 句子5]  \n---&quot;,
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a>}
</span><span id="__span-29-33"><a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a>{
</span><span id="__span-29-34"><a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a>    &quot;id&quot;: null,
</span><span id="__span-29-35"><a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a>    &quot;metadata&quot;: {
</span><span id="__span-29-36"><a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a>        &quot;Header 3&quot;: &quot;**优点与缺点**&quot;
</span><span id="__span-29-37"><a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a>    },
</span><span id="__span-29-38"><a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a>    &quot;page_content&quot;: &quot;### **优点与缺点**\n| **优点**                                      | **缺点**                                      |\n|----------------------------------------------|----------------------------------------------|\n| ✅ 自适应语义边界，避免机械切分                 | ❌ 计算成本高（需多次嵌入计算和相似度比较）     |\n| ✅ 减少噪声（窗口聚合降低单句波动影响）          | ❌ 依赖嵌入模型质量（如语义表示不准确则分块失效）|\n| ✅ 适配不同文本类型（技术文档、对话等）          | ❌ 参数敏感（需调优窗口大小、阈值）             |  \n---&quot;,
</span><span id="__span-29-39"><a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-40"><a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a>}
</span><span id="__span-29-41"><a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a>{
</span><span id="__span-29-42"><a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a>    &quot;id&quot;: null,
</span><span id="__span-29-43"><a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a>    &quot;metadata&quot;: {
</span><span id="__span-29-44"><a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a>        &quot;Header 3&quot;: &quot;**关键参数与调优建议**&quot;
</span><span id="__span-29-45"><a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a>    },
</span><span id="__span-29-46"><a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a>    &quot;page_content&quot;: &quot;### **关键参数与调优建议**\n1. **窗口大小**\n- 过小：噪声敏感（如窗口=1时退化为单句比较）。\n- 过大：语义边界模糊（如窗口=5可能掩盖局部变化）。\n- **建议值**：2-4 个句子（根据文本密度调整）。\n2. **相似度阈值**\n- 过高：分块过少，块内语义混杂。\n- 过低：分块过多，破坏连贯性。\n- **调优方法**：通过验证集测试不同阈值下的分块质量（如人工评估或检索召回率）。\n3. **嵌入模型选择**\n- 优先领域适配模型（如技术文本用 `all-mpnet-base-v2`，通用文本用 `text-embedding-3-small`）。  \n---&quot;,
</span><span id="__span-29-47"><a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-48"><a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a>}
</span><span id="__span-29-49"><a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a>{
</span><span id="__span-29-50"><a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a>    &quot;id&quot;: null,
</span><span id="__span-29-51"><a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a>    &quot;metadata&quot;: {
</span><span id="__span-29-52"><a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a>        &quot;Header 3&quot;: &quot;**改进方向**&quot;
</span><span id="__span-29-53"><a id="__codelineno-29-53" name="__codelineno-29-53" href="#__codelineno-29-53"></a>    },
</span><span id="__span-29-54"><a id="__codelineno-29-54" name="__codelineno-29-54" href="#__codelineno-29-54"></a>    &quot;page_content&quot;: &quot;### **改进方向**\n1. **动态窗口调整**\n根据文本复杂度自动扩展/收缩窗口（如密集段落用小窗口，冗余内容用大窗口）。\n2. **混合分块策略**\n先按标题/段落粗分块，再对长段落应用语义分块。\n3. **轻量化计算**\n- 使用低维嵌入（如 PCA 降维）。\n- 缓存嵌入结果减少重复计算。  \n---&quot;,
</span><span id="__span-29-55"><a id="__codelineno-29-55" name="__codelineno-29-55" href="#__codelineno-29-55"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-56"><a id="__codelineno-29-56" name="__codelineno-29-56" href="#__codelineno-29-56"></a>}
</span><span id="__span-29-57"><a id="__codelineno-29-57" name="__codelineno-29-57" href="#__codelineno-29-57"></a>{
</span><span id="__span-29-58"><a id="__codelineno-29-58" name="__codelineno-29-58" href="#__codelineno-29-58"></a>    &quot;id&quot;: null,
</span><span id="__span-29-59"><a id="__codelineno-29-59" name="__codelineno-29-59" href="#__codelineno-29-59"></a>    &quot;metadata&quot;: {
</span><span id="__span-29-60"><a id="__codelineno-29-60" name="__codelineno-29-60" href="#__codelineno-29-60"></a>        &quot;Header 3&quot;: &quot;**适用场景**&quot;
</span><span id="__span-29-61"><a id="__codelineno-29-61" name="__codelineno-29-61" href="#__codelineno-29-61"></a>    },
</span><span id="__span-29-62"><a id="__codelineno-29-62" name="__codelineno-29-62" href="#__codelineno-29-62"></a>    &quot;page_content&quot;: &quot;### **适用场景**\n- **技术文档**：精准切分章节、案例、代码块。\n- **长对话记录**：按话题切换分割会话阶段。\n- **跨段落推理任务**：确保块内语义高度相关。  \n通过该方法，可显著提升 RAG 等应用中检索内容的语义连贯性和相关性。&quot;,
</span><span id="__span-29-63"><a id="__codelineno-29-63" name="__codelineno-29-63" href="#__codelineno-29-63"></a>    &quot;type&quot;: &quot;Document&quot;
</span><span id="__span-29-64"><a id="__codelineno-29-64" name="__codelineno-29-64" href="#__codelineno-29-64"></a>}
</span></code></pre></div>
<h3 id="_18">如何限制块的大小</h3>
<p>从前面分块的结果可以看到，markdown 文本按照标题的层级结构分块，从前面的结果可以分块还是比较符合预期的。</p>
<p>但是存在一个问题，如果一个标题下面的文本内容太长，那么需要限制块的大小，也就是需要对同一个标题下的文本继续分块，可以结合 <code>RecursiveCharacterTextSplitter</code> 来进一步控制块的大小</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreTrainedTokenizerBase</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">text_splitter_by_token_num</span><span class="p">(</span><span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">],</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>                               <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>                               <span class="n">chunk_overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>                               <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PreTrainedTokenizerBase</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>                               <span class="n">separators</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="sd">    按照token数拆分文本</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="sd">    :param separators: chunk 分隔符列表</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="sd">    :param docs: 文档列表</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="sd">    :param tokenizer: 分词器</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="sd">    :param chunk_size: 每个chunk的token数</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="sd">    :param chunk_overlap: 重叠部分的token数</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="sd">    :return:</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>    <span class="k">if</span> <span class="n">separators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>        <span class="n">separators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;。&quot;</span><span class="p">]</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>    <span class="k">if</span> <span class="n">tokenizer</span><span class="p">:</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>        <span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="o">.</span><span class="n">from_huggingface_tokenizer</span><span class="p">(</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a>            <span class="n">tokenizer</span><span class="p">,</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a>            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a>            <span class="n">chunk_overlap</span><span class="o">=</span><span class="n">chunk_overlap</span><span class="p">,</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a>            <span class="n">separators</span><span class="o">=</span><span class="n">separators</span><span class="p">,</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a>        <span class="p">)</span>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a>        <span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a>            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a>            <span class="n">chunk_overlap</span><span class="o">=</span><span class="n">chunk_overlap</span><span class="p">,</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a>            <span class="n">separators</span><span class="o">=</span><span class="n">separators</span><span class="p">,</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>        <span class="p">)</span>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a>    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_content</span><span class="p">:</span>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a>            <span class="k">continue</span>
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_content</span>
</span><span id="__span-30-39"><a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a>            <span class="n">splits</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
</span><span id="__span-30-40"><a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a>            <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
</span><span id="__span-30-41"><a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
</span><span id="__span-30-42"><a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a>                    <span class="k">continue</span>
</span><span id="__span-30-43"><a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-30-44"><a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a>                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="__span-30-45"><a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a>                    <span class="n">new_doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">page_content</span><span class="o">=</span><span class="n">split</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="__span-30-46"><a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_doc</span><span class="p">)</span>
</span><span id="__span-30-47"><a id="__codelineno-30-47" name="__codelineno-30-47" href="#__codelineno-30-47"></a>    <span class="k">return</span> <span class="n">results</span>
</span></code></pre></div>
<h3 id="markdown_1">markdown 分块其他挑战</h3>
<ul>
<li>如何提取markdown文件中的完整表格，也就是尽可能将表格放在一个分块中。</li>
<li>如何提取markdown文件中的完整代码块，也就是尽可能将代码块放在一个分块中。</li>
<li>如何提取和识别markdown文件中的图片，将图片内容识别出来放在一个分块中。</li>
</ul>
<p>关于这几个问题，会在后续文章中介绍，请继续关注。</p>
<h2 id="_19">动态分块</h2>
<p>关于动态分块的基本思路是：根据输入文件的类型动态的选项对应的分块逻辑，分块逻辑使用langchain的实现：</p>
<p>json文件：<code>RecursiveJsonSplitter</code></p>
<p>html文件选择合适的：</p>
<ul>
<li>使用<code>HTMLHeaderTextSplitter</code>情况：需要根据标题层次结构拆分 HTML 文档并维护有关标题的元数据。</li>
<li>使用<code>HTMLSectionSplitter</code>情况：需要将文档拆分为更大、更通用的部分，可能基于自定义标签或字体大小。</li>
<li>使用<code>HTMLSemanticPreservingSplitter</code>情况：需要将文档拆分成块，同时保留表格和列表等语义元素，确保它们不会被拆分并且它们的上下文得到维护。</li>
</ul>
<p>markdown文件：<code>MarkdownHeaderTextSplitter</code></p>
<h2 id="_20">总结</h2>
<p>最后总结一下各个分块方法的优缺点如下：</p>
<table>
<thead>
<tr>
<th><strong>分块方法</strong></th>
<th><strong>方法描述</strong></th>
<th><strong>优点</strong></th>
<th><strong>缺点</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>按字符分块</strong></td>
<td>基于固定字符数切分文本（如每 200 个字符一个块）。</td>
<td>✅ 实现简单   ✅ 无需依赖分词工具</td>
<td>❌ 破坏单词/句子结构   ❌ 多语言适配性差</td>
</tr>
<tr>
<td><strong>按 Token 分块</strong></td>
<td>基于模型分词器（Tokenizer）的 token 数切分（如每 256 tokens 一个块）。</td>
<td>✅ 适配模型输入限制   ✅ 计算成本低</td>
<td>❌ 可能切断语义边界   ❌ 依赖分词器性能</td>
</tr>
<tr>
<td><strong>按语义分块</strong></td>
<td>利用 NLP 工具或规则识别语义边界（如句子、段落、章节）。</td>
<td>✅ 保留语义完整性   ✅ 适配结构化文本</td>
<td>❌ 依赖文本结构或模型   ❌ 计算成本高</td>
</tr>
<tr>
<td><strong>按 Markdown 层次化分块</strong></td>
<td>根据 Markdown 标题层级（如 <code>#</code>、<code>##</code>）划分块，保留文档结构。</td>
<td>✅ 保持文档逻辑结构   ✅ 无需复杂 NLP 处理</td>
<td>❌ 仅支持 Markdown 格式   ❌ 格式错误导致分块失败</td>
</tr>
<tr>
<td><strong>动态分块</strong></td>
<td>根据文档类型和内容动态调整块大小（如html文件，json文件，代码等使用不同的分块策略）。</td>
<td>✅ 灵活适配文本特性   ✅ 优化信息覆盖率</td>
<td>❌ 实现复杂度高   ❌ 需定制规则或模型</td>
</tr>
</tbody>
</table>
<p>下一篇文章将介绍如何将分块后的内容存储到向量数据库中，以便RAG应用检索，请继续关注。</p>
<p>参考文档：</p>
<p><a href="https://python.langchain.com/docs/how_to/">https://python.langchain.com/docs/how_to/</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.select"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>